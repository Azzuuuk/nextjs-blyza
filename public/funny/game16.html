<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Where in the World? - Game Show Edition!</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Luckiest+Guy&family=Quicksand:wght@300..700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base Styles from Guess The Price */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary: #FF8833; /* Blyza Orange */
            --secondary: #CB7AE1; /* Blyza Purple */
            --light: #F2F2F2;
            --success: #00BFA6; /* Blyza Keppel */
            --danger: #ff4b2b;
            --dark: #1a1c20;
            --darker: #0f1012;
            --info: #4ECDC4;
            --gold: #FFD700; /* Game show gold */
            --stage-bg: #2c3e50;
            --curtain-color: #c0392b;
            --spotlight-color: rgba(255, 223, 0, 0.6);
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--darker) 100%);
            color: var(--light);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .game-container {
            max-width: 900px;
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 30px;
            box-shadow:
                0 20px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .brand-logo {
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        .brand-logo-prominent {
            display: block;
            margin: 0 auto 20px;
            max-height: 80px;
        }

        h1 {
            font-family: "Luckiest Guy", cursive;
            font-size: 3rem;
            margin-bottom: 25px;
            color: var(--gold);
            text-shadow:
                0 2px 0px #000,
                0 4px 6px rgba(0, 0, 0, 0.5),
                0 0 30px var(--primary);
            letter-spacing: 1px;
            margin-top: 10px;
        }
        h3, .screen-title {
            font-family: "Bungee", cursive;
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: var(--primary);
            text-shadow: 0 1px 2px #000;
        }
        h3#results-screen-title { margin-top: 0; }


        .screen { display: none; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .active { display: block; }

        .instructions {
            font-family: "Quicksand", sans-serif;
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 20px;
            margin: 30px 0;
            line-height: 1.8;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            text-align: left;
        }
        .instructions p:first-of-type strong {
             font-family: "Bungee", cursive; font-size: 1.2em; display:block; margin-bottom: 10px;
             color: var(--light);
        }
        .instructions p { font-size: 1.1rem; margin-bottom: 15px; color: var(--light); }
        .instructions ul { list-style-type: none; padding-left: 0; }
        .instructions li { margin-bottom: 10px; display: flex; align-items: flex-start; font-size: 1rem; }
        .instructions i {
            margin-right: 10px; font-size: 1.2em; color: var(--primary);
            width: 20px; text-align: center; margin-top: 2px;
        }
        .instructions strong { color: var(--primary); }


        .game-mode-selection {
            display: flex; justify-content: center; gap: 20px; margin: 30px 0; flex-wrap: wrap;
        }
        .mode-option {
            background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; cursor: pointer;
            transition: all 0.3s ease; border: 2px solid rgba(255,255,255,0.1);
            flex: 1; min-width: 200px; max-width: 280px;
        }
        .mode-option:hover {
            transform: translateY(-5px) scale(1.03); background: rgba(255,255,255,0.08);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2), 0 0 10px var(--secondary); border-color: var(--secondary);
        }
        .mode-option.selected {
            border-color: var(--primary); background: rgba(255,136,51,0.1);
            box-shadow: 0 0 15px rgba(255,136,51,0.2), inset 0 0 8px rgba(255,136,51,0.1);
            transform: scale(1.01);
        }
        .mode-option i { font-size: 2rem; margin-bottom: 10px; color: var(--primary); }
        .mode-option h3 { font-size: 1.3rem; margin-bottom: 8px; color: var(--light); }
        .mode-option p { color: rgba(242,242,242,0.7); font-size: 0.9rem; }

        .team-inputs-container {
            margin: 30px 0; background: rgba(255,255,255,0.05); padding: 30px;
            border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
        }
        #team-names-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px; margin-bottom: 20px;
        }
        .team-input input.team-name-input {
            width: 100%; max-width: 350px;
            padding: 15px 20px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1); font-size: 1.1rem;
            background: rgba(255,255,255,0.05); color: var(--light);
            transition: all 0.3s ease; font-family: 'Quicksand', sans-serif;
        }
        .team-input input.team-name-input:focus {
            outline: none; border-color: var(--secondary);
            box-shadow: 0 0 10px rgba(203,122,225,0.2);
        }

        .game-info {
            display: flex; justify-content: space-around; align-items: center;
            padding: 10px 20px; margin-bottom: 20px; background: rgba(0,0,0,0.2);
            border-radius: 10px; border: 1px solid var(--gold);
            font-family: "Orbitron", sans-serif; font-size: 1rem; color: var(--gold);
            text-shadow: 0 0 5px var(--primary);
        }
        #current-player-display-text {
            font-family: "Bungee", cursive; color: var(--primary);
            font-size: 1.3rem; margin-top: -10px; margin-bottom: 15px;
            text-shadow: 0 1px 2px #000;
        }

        .place-display-stage {
            background: var(--stage-bg); padding: 20px; border-radius: 20px;
            margin-bottom: 25px; border: 3px solid var(--gold);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 0 15px rgba(0,0,0,0.3);
            position: relative; overflow: hidden;
        }
        .place-display-stage::before, .place-display-stage::after {
            content: ''; position: absolute; top: -50px; width: 200px; height: 300px;
            background: radial-gradient(ellipse at center, var(--spotlight-color) 0%, transparent 70%);
            pointer-events: none; opacity: 0.7;
        }
        .place-display-stage::before { left: -50px; transform: rotate(-30deg); }
        .place-display-stage::after { right: -50px; transform: rotate(30deg); }

        .stage-curtains {
            position: absolute;
            top: 0;
            width: 50%;
            height: 100%;
            background-color: var(--curtain-color);
            background-image: linear-gradient(rgba(0,0,0,0.2) 50%, transparent 50%),
                              linear-gradient(90deg, rgba(0,0,0,0.2) 50%, transparent 50%);
            background-size: 50px 50px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.5);
            transition: transform 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 5;
        }
        .stage-curtains.left { left: 0; border-right: 3px solid #a52a20; }
        .stage-curtains.right { right: 0; border-left: 3px solid #a52a20; }
        .stage-curtains.open.left { transform: translateX(-100%); }
        .stage-curtains.open.right { transform: translateX(100%); }


        .place-tv-screen {
            background: #111; border: 10px solid #333; border-radius: 15px;
            padding: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.7), inset 0 0 10px rgba(0,0,0,0.5);
            position: relative; z-index: 1; min-height: 300px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .place-tv-screen h3 {
            font-family: "Luckiest Guy", cursive; color: var(--gold);
            font-size: 1.6rem; margin-bottom: 15px; text-shadow: 0 2px 3px #000;
        }
        .place-image {
            max-height: 350px; max-width: 90%; object-fit: contain;
            border-radius: 8px; margin: 10px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); display: block;
            opacity: 0;
            transition: opacity 0.5s ease-in 0.3s;
        }
        .place-image.visible { opacity: 1; }

        /* FIXED: Options Layout 2-1 */
        .options-container {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Two equal columns */
            gap: 15px;
            margin: 25px auto;
            max-width: 600px; /* Control overall width of the options block */
        }
        .option-btn { /* Default styling for option buttons */
            /* Inherits from general button styling */
            font-family: "Quicksand", sans-serif; font-weight: 600;
            font-size: 1rem; padding: 12px 20px;
            background: linear-gradient(135deg, var(--secondary) 0%, #b85cd6 100%);
            text-align: left;
            justify-content: flex-start;
            width: 100%; /* Make buttons fill their grid cell */
        }
        .option-btn:nth-child(3) {
            grid-column: 1 / span 2; /* Make the 3rd button span both columns */
            justify-self: center; /* Center the button within the spanned area */
            max-width: calc(50% - 7.5px); /* Approximately one column width, considering gap */
             /* Or a fixed max-width if preferred: e.g. max-width: 280px; */
        }


        .option-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #b85cd6 0%, var(--secondary) 100%);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4), inset 0 -2px 5px rgba(0,0,0,0.2), 0 0 10px var(--secondary);
        }
        .option-btn i { font-size: 1.1rem; color: var(--light); margin-right: 10px; }

        .option-btn.correct {
            background: linear-gradient(135deg, var(--success) 0%, #00a890 100%) !important;
        }
        .option-btn.correct:hover:not(:disabled) { box-shadow: 0 8px 25px rgba(0,0,0,0.4), inset 0 -2px 5px rgba(0,0,0,0.2), 0 0 10px var(--success) !important; }

        .option-btn.incorrect {
            background: linear-gradient(135deg, var(--danger) 0%, #ff416c 100%) !important; opacity: 0.85;
        }
        .option-btn.incorrect:hover:not(:disabled) { box-shadow: 0 8px 25px rgba(0,0,0,0.4), inset 0 -2px 5px rgba(0,0,0,0.2), 0 0 10px var(--danger) !important; opacity: 1;}

        .option-btn.disabled-option { /* Applied to non-selected, non-correct options AFTER reveal */
            background: rgba(255,255,255,0.1) !important; opacity:0.6;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important; transform:none !important;
            border-color: rgba(0,0,0,0.5) !important; pointer-events: none;
        }
        .option-btn:disabled:not(.correct):not(.incorrect) { /* For buttons disabled BEFORE reveal (after one is selected) */
             background: rgba(255,255,255,0.1) !important; opacity:0.5;
             box-shadow: 0 2px 5px rgba(0,0,0,0.2) !important; transform:none !important;
        }


        .result-item {
            background: rgba(0,0,0, 0.2); padding: 20px; border-radius: 20px;
            margin-bottom: 20px; border: 2px solid var(--gold);
            box-shadow: 0 0 15px var(--gold); display: flex;
            flex-direction: column; align-items: center; text-align: center;
        }
        .result-item .place-image { max-height: 200px; margin-bottom: 15px; }
        .answer-display {
            font-size: 2rem; color: var(--success); margin: 15px 0;
            font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.4), 0 0 10px var(--success);
            font-family: "Orbitron", sans-serif;
        }
        #place-description-text {
            font-size: 1rem; color: rgba(242,242,242,0.8);
            margin-top: 10px; max-width: 90%;
        }
        .guess-results-container {
            display: grid; gap: 15px; margin: 25px 0;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        .guess-result {
            background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px;
            text-align: left; border: 1px solid rgba(255,255,255,0.1);
        }
        .guess-result .player-name {
            font-family: "Bungee", cursive; font-size: 1.1rem; color: var(--primary); margin-bottom: 5px;
        }
        .guess-result .guess-text { font-size: 1rem; color: var(--light); margin-bottom: 8px; }
        .guess-result .result-feedback-text { font-weight: bold; font-size: 1rem; }
        .guess-result.correct-guess {
            border: 2px solid var(--success); background: rgba(0,191,166,0.1);
            box-shadow: 0 0 15px rgba(0,191,166,0.2); transform: scale(1.02);
        }
        .guess-result.correct-guess .result-feedback-text { color: var(--success); }
        .guess-result:not(.correct-guess) .result-feedback-text { color: var(--danger); }

        .score-display {
            display: grid; gap: 20px; margin: 30px 0;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        .score-card {
            background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px;
            border: 2px solid var(--gold); transition: all 0.3s ease;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3); text-align: center;
        }
        .score-card .team-name-score {
             font-family: "Bungee", cursive; font-size: 1.3rem; margin-bottom: 8px; color: var(--primary);
        }
        .score-card .score-value-display {
            font-family: "Orbitron", sans-serif; font-size: 2.2rem; color: var(--light); text-shadow: 0 0 8px var(--gold);
        }
        .score-card.winner-glow {
            animation: winnerGlow 1.5s infinite alternate; border-color: var(--success);
            box-shadow: 0 0 20px rgba(0,191,166,0.3), 0 0 10px var(--gold), inset 0 0 10px rgba(0,191,166,0.1);
            background: rgba(0,191,166,0.1);
        }
        @keyframes winnerGlow {
            from { box-shadow: 0 0 20px rgba(0,191,166,0.3), 0 0 10px var(--gold); }
            to { box-shadow: 0 0 35px rgba(0,191,166,0.6), 0 0 20px var(--gold); }
        }
        .progress-bar {
            height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px;
            margin-top: 10px; overflow: hidden; border: 1px solid rgba(255,255,255,0.2);
        }
        .progress-fill {
            height: 100%; background: linear-gradient(90deg, var(--primary) 0%, var(--gold) 100%);
            border-radius: 4px; transition: width 0.5s ease; box-shadow: 0 0 8px var(--primary);
        }

        .win-message {
            font-size: 3rem; margin: 30px 0; color: var(--gold);
            text-shadow: 0 3px 0px #000, 0 0 20px var(--primary);
            font-family: "Luckiest Guy", cursive;
        }
        .winner-trophy {
            font-size: 6rem; margin: 20px 0 30px 0;
            animation: bounce 1.5s infinite ease-in-out; color: var(--gold);
            text-shadow: 0 0 20px var(--gold), 0 0 30px var(--primary);
        }
        @keyframes bounce { 0%,100%{transform:translateY(0) scale(1);} 50%{transform:translateY(-35px) scale(1.1);} }
        #winner-subtext {
            font-family: "Quicksand", sans-serif; font-size: 1.1rem;
            color: rgba(242,242,242,0.8); margin-bottom: 20px;
        }

        button {
            background: linear-gradient(135deg, var(--primary) 0%, #ff7711 100%);
            color: var(--light); border: 2px solid var(--darker); padding: 15px 25px;
            font-size: 1rem; border-radius: 50px; cursor: pointer;
            font-weight: normal; transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3), inset 0 -2px 5px rgba(0,0,0,0.2);
            margin: 10px 5px; font-family: "Bungee", cursive; text-shadow: 1px 1px 2px #000;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            min-width: 180px; flex-shrink: 0;
        }
        button:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4), inset 0 -2px 5px rgba(0,0,0,0.2), 0 0 10px var(--primary);
            background: linear-gradient(135deg, #ff7711 0%, var(--primary) 100%);
        }
        button:active:not(:disabled) { transform: translateY(-1px) scale(1.02); }
        button:disabled {
            background: rgba(255,255,255,0.1); cursor:not-allowed; opacity:0.6;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); transform:none; border-color: rgba(0,0,0,0.5);
        }
        .btn-primary {}
        .btn-success { background: linear-gradient(135deg, var(--success) 0%, #00a890 100%); }
        .btn-success:hover:not(:disabled) { box-shadow: 0 8px 25px rgba(0,0,0,0.4), inset 0 -2px 5px rgba(0,0,0,0.2), 0 0 10px var(--success); }
        .btn-danger { background: linear-gradient(135deg, var(--danger) 0%, #ff416c 100%); }
        .btn-danger:hover:not(:disabled) { box-shadow: 0 8px 25px rgba(0,0,0,0.4), inset 0 -2px 5px rgba(0,0,0,0.2), 0 0 10px var(--danger); }
        .btn-secondary { background: linear-gradient(135deg, var(--secondary) 0%, #b85cd6 100%); }
        .btn-secondary:hover:not(:disabled) { box-shadow: 0 8px 25px rgba(0,0,0,0.4), inset 0 -2px 5px rgba(0,0,0,0.2), 0 0 10px var(--secondary); }
        .btn-info { background: linear-gradient(135deg, var(--info) 0%, #3eb7af 100%); }
        .btn-info:hover:not(:disabled) { box-shadow: 0 8px 25px rgba(0,0,0,0.4), inset 0 -2px 5px rgba(0,0,0,0.2), 0 0 10px var(--info); }

        .game-over-buttons-container { display: flex; justify-content: center; align-items: flex-start; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
        .game-over-button-wrapper { position: relative; display: flex; flex-direction: column; align-items: center; }
        .treat-yourself-callout { margin-bottom: 8px; background-color: var(--gold); color: var(--darker); padding: 8px 15px; border-radius: 20px; font-family: "Bungee",cursive; font-size:0.9rem; white-space:nowrap; box-shadow:0 2px 10px rgba(255,215,0,0.5); display:none; align-items:center; gap:8px; z-index:10;}
        .treat-yourself-callout i { font-size: 1.2em; animation: bounceArrow 1s infinite; }
        @keyframes bounceArrow { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-4px);} }


        .icon-btn { position:absolute; background:rgba(0,0,0,0.3); color:var(--light); border:1px solid var(--gold); border-radius:50%; width:40px; height:40px; font-size:1.1rem; cursor:pointer; transition:all .3s ease; display:flex; justify-content:center; align-items:center; z-index:100; padding:0; margin:0; box-shadow:none; text-shadow:none; }
        .icon-btn#settings-btn { top:15px; right:15px; }
        .icon-btn:hover { background:rgba(0,0,0,0.5); transform:scale(1.1) rotate(15deg); box-shadow:0 0 10px var(--gold); }
        .icon-btn i { margin:0; }
        .modal { position:fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color:rgba(0,0,0,0.7); backdrop-filter:blur(8px); display:none; justify-content:center; align-items:center; }
        .modal-content { background-color:var(--darker); margin:auto; padding:30px; border:2px solid var(--gold); border-radius:15px; width:80%; max-width:450px; box-shadow:0 10px 30px rgba(0,0,0,0.6),0 0 20px var(--primary); position:relative; color:var(--light); }
        .modal-content h2 { font-family:"Bungee",cursive; color:var(--primary); text-align:center; margin-bottom:25px; font-size:1.8rem; }
        .setting-item { margin-bottom:20px; display:flex; flex-direction:column; }
        .setting-item label { margin-bottom:8px; font-weight:600; font-size:0.9rem;}
        input[type=range] { -webkit-appearance:none; width:100%; background:transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance:none; height:20px; width:20px; border-radius:50%; background:var(--primary); cursor:pointer; margin-top:-7px; box-shadow:0 0 8px var(--primary); }
        input[type=range]::-moz-range-thumb { height:20px; width:20px; border-radius:50%; background:var(--primary); cursor:pointer; border:none; box-shadow:0 0 8px var(--primary); }
        input[type=range]::-webkit-slider-runnable-track { width:100%; height:6px; cursor:pointer; background:rgba(255,255,255,0.2); border-radius:3px; border:1px solid rgba(0,0,0,0.2); }
        input[type=range]::-moz-range-track { width:100%; height:6px; cursor:pointer; background:rgba(255,255,255,0.2); border-radius:3px; border:1px solid rgba(0,0,0,0.2); }
        .close-modal-btn { color:#aaa; position:absolute; top:15px; right:20px; font-size:28px; font-weight:bold; cursor:pointer; }
        .close-modal-btn:hover, .close-modal-btn:focus { color:var(--light); text-decoration:none; }

        .feedback-popup {
            position: fixed; top: 50%; left: 50%; color: white; padding: 30px 50px;
            border-radius: 20px; font-size: 2.8rem; font-family: "Luckiest Guy", cursive;
            text-align: center; z-index: 2000; box-shadow: 0 15px 40px rgba(0,0,0,0.7);
            opacity: 0; transform: translate(-50%,-50%) scale(0.7); border: 3px solid var(--gold);
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; display: none;
        }
        .feedback-popup.show { display: block; opacity: 1; transform: translate(-50%,-50%) scale(1); animation: feedbackPopAnimWITW 1.5s forwards; } /* Keep scale(1) for GTP feedback style */
        @keyframes feedbackPopAnimWITW {
            0%   { opacity: 0; transform: translate(-50%,-50%) scale(0.7); }
            20%  { opacity: 1; transform: translate(-50%,-50%) scale(1); } /* GTP pop in */
            80%  { opacity: 1; transform: translate(-50%,-50%) scale(1); } /* Hold */
            100% { opacity: 0; transform: translate(-50%,-50%) scale(0.7); } /* Fade out */
        }
        .feedback-popup.correct-feedback { background-color: rgba(0,191,166,0.97); text-shadow: 0 0 10px var(--success); }
        .feedback-popup.incorrect-feedback { background-color: rgba(255,75,43,0.97); text-shadow: 0 0 10px var(--danger); }
        .feedback-popup.win-feedback { background-color: rgba(255,136,51,0.97); text-shadow: 0 0 10px var(--primary); }

        .confetti-piece { position:fixed; width:10px; height:20px; background-color:var(--primary); opacity:0; animation-timing-function:linear; animation-fill-mode:forwards; pointer-events:none; z-index:3000; }
        @keyframes fallAndFade { 0%{transform:translateY(-20vh) rotate(0deg); opacity:1;} 100%{transform:translateY(120vh) rotate(720deg); opacity:0;} }


        @media (max-width: 768px) {
            .game-container { padding: 20px; }
            h1 { font-size: 2.5rem; } h3, .screen-title { font-size: 1.6rem; }
            .game-mode-selection { flex-direction: column; align-items: center; gap: 15px; }
            .mode-option { max-width: 90%; min-width: unset; }
            .place-image { max-height: 280px; }
            .options-container { grid-template-areas: "opt1" "opt2" "opt3"; grid-template-columns: 1fr; }
            .option-btn:nth-child(3) { justify-self: stretch; width: 100%; max-width: none; }
            .option-btn { font-size: 0.9rem; padding: 12px 18px;}
            .score-display { flex-direction: column; align-items: center; gap: 15px; }
            .score-card { min-width: 80%; max-width: 90%; }
            .win-message { font-size: 2.2rem; }
            .winner-trophy { font-size: 5rem; }
            .modal-content { padding: 20px; }
            .game-over-buttons-container { flex-direction: column; align-items: center;}
            .game-over-buttons-container .game-over-button-wrapper { width: 90%; margin: 5px auto;}
            .game-over-buttons-container .game-over-button-wrapper button { width: 100%;}
            .feedback-popup { font-size: 2.2rem; padding: 25px 40px; width: 80%;}
            .place-display-stage::before, .place-display-stage::after { display: none; }
            .place-tv-screen h3 {font-size: 1.3rem;}
            .answer-display {font-size: 1.5rem;}
        }
         @media (max-width: 480px) {
            h1 { font-size: 2rem; } h3, .screen-title { font-size: 1.4rem; }
            .game-container { padding: 15px; }
            .team-input input.team-name-input { max-width: 100%;}
            .place-image { max-height: 200px; }
            .option-btn { width: 100%; margin: 5px 0; }
            .options-container { gap: 10px; }
             .option-btn:nth-child(3) { max-width: 100%; }
            .icon-btn { top: 10px; right: 10px; width: 35px; height: 35px; font-size: 1rem; }
            .feedback-popup { font-size: 1.8rem; padding: 20px 30px;}
            .instructions li { font-size: 0.9rem;}
            .game-info { font-size: 0.9rem;}
            .place-tv-screen h3 {font-size: 1.2rem;}
            .answer-display {font-size: 1.3rem;}
         }
    </style>
</head>
<body>
    <div class="game-container">
        <img id="corner-logo-static" class="brand-logo" src="https://static.wixstatic.com/shapes/9ce3e5_4f0149a89dd841859da02f59247b5b6b.svg" alt="Blyza Mascot" style="position: absolute; top: 20px; left: 20px; max-height: 40px; opacity: 0.7; display: none;">
        <button id="settings-btn" class="icon-btn" aria-label="Open Settings">
            <i class="fas fa-cog"></i>
        </button>

        <div id="start-screen" class="screen active">
            <img class="brand-logo brand-logo-prominent" src="https://static.wixstatic.com/shapes/9ce3e5_4f0149a89dd841859da02f59247b5b6b.svg" alt="Blyza Mascot">
            <h1>Where in the World?</h1>
            <div class="instructions">
                <p><strong>HOW TO PLAY:</strong></p>
                <ul>
                    <li><i class="fas fa-map-marked-alt"></i> Guess the correct place shown from three options.</li>
                    <li><i class="fas fa-user"></i> **Single Player:** 10 rounds. Score points for correct answers.</li>
                    <li><i class="fas fa-users"></i> **Multiplayer:** Up to 4 teams. Take turns. First to <strong>5 points</strong> wins!</li>
                </ul>
            </div>
            <div class="game-mode-selection">
                <div class="mode-option selected" data-mode="single"> <i class="fas fa-user"></i> <h3>Single Player</h3> <p>10 rounds</p> </div>
                <div class="mode-option" data-mode="multi"> <i class="fas fa-users"></i> <h3>Multiplayer</h3> <p>With friends</p> </div>
            </div>
            <div id="team-inputs-container" class="team-inputs-container" style="display: none;">
                <h3 class="screen-title">Enter Team Names</h3>
                <div id="team-names-grid">
                    <div class="team-input"><input type="text" class="team-name-input" placeholder="Team 1"></div>
                    <div class="team-input"><input type="text" class="team-name-input" placeholder="Team 2"></div>
                </div>
                <button id="add-team-btn" class="btn-secondary"><i class="fas fa-plus-circle"></i> Add Team</button>
            </div>
            <button id="start-game-btn" class="btn-primary">Start Game <i class="fas fa-play"></i></button>
        </div>

        <div id="game-screen" class="screen">
            <div class="game-info">
                <div> <span id="round-type-text">Round</span> <span id="round-number-text">1</span> <span id="round-total-text">/10</span> </div>
                <div> Score: <span id="current-score-text">0</span> <span id="score-target-display-text"></span> </div>
            </div>
            <div id="current-player-display-text"></div>
            <div class="place-display-stage">
                <div class="stage-curtains left"></div> <div class="stage-curtains right"></div>
                <div class="place-tv-screen">
                    <h3>Where is this place?</h3>
                    <img id="place-image-display" src="" alt="Place to guess" class="place-image">
                </div>
            </div>
            <div id="options-container-div" class="options-container"></div>
            <button id="reveal-answer-btn" class="btn-primary" style="display: none;">Reveal Answer <i class="fas fa-eye"></i></button>
        </div>

        <div id="results-screen" class="screen">
            <img class="brand-logo brand-logo-prominent" src="https://static.wixstatic.com/shapes/9ce3e5_4f0149a89dd841859da02f59247b5b6b.svg" alt="Blyza Mascot" style="max-height: 60px;">
            <h3 id="results-screen-title" class="screen-title">Round Result</h3>
            <div class="result-item">
                <img id="result-place-image-display" src="" alt="Place" class="place-image">
                <div class="answer-display">Correct Answer: <span id="correct-answer-text">Place</span></div>
                <div id="place-description-text">Description.</div>
            </div>
            <div id="guess-results-container-div" class="guess-results-container"></div>
            <div id="score-display-results-div" class="score-display"></div>
            <button id="next-round-btn" class="btn-primary">Next Round <i class="fas fa-arrow-right"></i></button>
        </div>

        <div id="game-over-screen" class="screen">
            <img class="brand-logo brand-logo-prominent" src="https://static.wixstatic.com/shapes/9ce3e5_4f0149a89dd841859da02f59247b5b6b.svg" alt="Blyza Mascot">
            <h1>Game Over!</h1>
            <div class="win-message" id="win-message-final-text">Team Wins!</div>
            <div class="winner-trophy">üèÜ</div>
            <div id="winner-subtext"></div>
            <div id="final-scores-display-div" class="score-display"></div>
            <div class="game-over-buttons-container">
                <div class="game-over-button-wrapper">
                     <button id="play-again-game-btn" class="btn-success"><i class="fas fa-redo"></i> Play Again</button>
                </div>
                <div class="game-over-button-wrapper">
                     <button id="main-menu-nav-btn" class="btn-secondary"><i class="fas fa-home"></i> Main Menu</button>
                </div>
                <div class="game-over-button-wrapper" id="store-button-wrapper">
                     <button id="visit-store-btn" class="btn-info"><i class="fas fa-store"></i> Visit Store</button>
                </div>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span id="close-modal-btn" class="close-modal-btn">√ó</span>
            <h2>Settings</h2>
            <div class="setting-item"> <label for="bgm-volume-slider">Background Music Volume:</label> <input type="range" id="bgm-volume-slider" min="0" max="1" step="0.01" value="0.2"> </div>
            <div class="setting-item"> <label for="sfx-toggle-btn">Sound Effects:</label> <button id="sfx-toggle-btn" class="btn-secondary">SFX: ON</button> </div>
        </div>
    </div>
    <div id="feedback-popup" class="feedback-popup"> <span id="feedback-message-text-el"></span> </div>

    <audio id="background-game-music" loop src="https://static.wixstatic.com/mp3/9ce3e5_380adfaea802407b9a4cebc67f12a216.mp3"></audio>
    <audio id="start-game-sound" src="https://static.wixstatic.com/mp3/9ce3e5_1b9151238aec4e29ab14f1526e9c1334.mp3"></audio>
    <audio id="interaction-sound" src="https://static.wixstatic.com/mp3/9ce3e5_fc326aa1760c485dbac083ec55c2bfcb.wav"></audio>
    <audio id="correct-answer-sound" src="https://static.wixstatic.com/mp3/9ce3e5_76691a6fefcd4536aa403ada111e886a.mp3"></audio>
    <audio id="wrong-answer-sound" src="https://static.wixstatic.com/mp3/9ce3e5_277f814439064d1bbe5c0342241b23e4.mp3"></audio>
    <audio id="win-game-sound" src="https://static.wixstatic.com/mp3/9ce3e5_5d7fcfc389734cf7994f5d37de621e3d.mp3"></audio>
    <audio id="curtain-sound" src="https://static.wixstatic.com/mp3/9ce3e5_ccd36cdf98bf4e1594cf2e52d5296c51.wav"></audio>


    <script>
        const gameConfig = {
            sfxEnabled: true,
            musicVolume: 0.2,
        };

        const gameState = {
            players: [], currentRound: 1, scores: {}, gameMode: 'single', currentPlace: null,
            currentPlayerIndex: 0, usedPlaces: [], currentGuess: null,
            places: [ /* Places array from previous script */
                 { image: "https://static.wixstatic.com/media/9ce3e5_09dcc3d095064b768a85d0a90d8d84f5~mv2.jpg", correctAnswer: "Baku, Azerbaijan", options: ["Baku, Azerbaijan", "Tbilisi, Georgia", "Astana, Kazakasthan"], description: "This vibrant capital city is known for its modern Flame Towers and the ancient walled Old City." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_f2ec9180c645479f8956038166065254~mv2.jpeg", correctAnswer: "Berlin, Germany", options: ["Prague, Czechia", "Berlin, Germany", "Vienna, Austria"], description: "A city steeped in history, it boasts iconic landmarks like the Brandenburg Gate." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_7e5c4a438e734b4aa5dae6078edcdf53~mv2.jpg", correctAnswer: "Amsterdam, Netherlands", options: ["Copenhagen, Denmark", "Bruges, Belgium", "Amsterdam, Netherlands"], description: "Famous for its intricate canal system, historic gabled houses, and vibrant artistic heritage." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_ba41ac2fcd5e4981820613bb79a42b99~mv2.webp", correctAnswer: "Bali, Indonesia", options: ["Bali, Indonesia", "Male, Maldives", "Puket, Thailand"], description: "This Island paradise is renowned for its stunning beaches, lush rice paddies, and spiritual retreats." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_bf28558e3ae84ad19328d5154ce60771~mv2.jpg", correctAnswer: "Colombo, Sri Lanka", options: ["Mumbai, India", "Colombo, Sri Lanka", "Ho Chi Minh City, Vietnam"], description: "The bustling commercial capital, featuring a mix of modern high-rises and colonial-era architecture." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_ab63cff93d4f4a2095c92d94a4ee1ac6~mv2.jpg", correctAnswer: "Cape Town, South Africa", options: ["Sydney, Australia", "Rio De Janeiro, Brazil", "Cape Town, South Africa"], description: "Nestled beneath the iconic Table Mountain, this city boasts stunning coastal scenery and diverse cultural heritage." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_3c2e1025e75f458e9d132c9d93a47aca~mv2.webp", correctAnswer: "Buenos Aires, Argentina", options: ["S√£o Paulo, Brazil", "Chichen Itza, Mexico", "Buenos Aires, Argentina"], description: "Known as the Paris of South America, this capital is famous for its European-style architecture and passionate tango culture." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_19c1d2e7555d4505a4634f3514998711~mv2.jpg", correctAnswer: "Brussels, Belgium", options: ["Brussels, Belgium", "Geneva, Switzerland", "Berlin, Germany"], description: "The capital and a major center for European politics, famous for its Grand Place and delicious chocolate." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_be09b5bc9e2549b2b3ab549e769067af~mv2.webp", correctAnswer: "Dubai, UAE", options: ["Riaydh, Saudi Arabia", "Dubai, UAE", "Doha, Qatar"], description: "This ultramodern city is famous for its futuristic skyscrapers, luxury shopping, and artificial islands." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_f250e5739b334a57b519c1bdac4633c1~mv2.jpeg", correctAnswer: "Gdansk, Poland", options: ["Riga, Latvia", "Tallinn, Estonia", "Gdansk, Poland"], description: "A historic port city on the Baltic coast of Poland, known for its colorful Long Market and maritime history." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_2e10ed6e32ce4f76a1a17371346b121c~mv2.avif", correctAnswer: "Istanbul, Turkey", options: ["Istanbul, Turkey", "Cairo, Egypt", "Athens, Greece"], description: "Straddling two continents, this Turkish city boasts a rich history evident in its Hagia Sophia and Blue Mosque." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_667659900297423aacd1ce77923c4e3d~mv2.jpeg", correctAnswer: "Las Vegas, USA", options: ["Los Angeles, USA", "Las Vegas, USA", "Atlantic City, USA"], description: "Known as the Entertainment Capital of the World, this Nevada city is famous for its casinos, dazzling shows, and vibrant nightlife." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_68a46a12fd4343908c7d5c37c3d68aa3~mv2.avif", correctAnswer: "Lagos, Nigeria", options: ["Nairobi, Kenya", "Dhaka, Bangladesh", "Lagos, Nigeria"], description: "The sprawling and energetic economic hub, known for its bustling markets and vibrant music scene." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_9d66ca30b333461e85c94cc31a35c352~mv2.jpg", correctAnswer: "Manchester, UK", options: ["Manchester, UK", "Liverpool, UK", "London, UK"], description: "A major city in northwest England with a rich industrial heritage and a thriving contemporary music and arts scene." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_c9f7aba5e3f84f3cb0a72c6c931fdeef~mv2.jpg", correctAnswer: "Marseille, France", options: ["Genoa, Italy", "Marseille, France", "Valencia, Spain"], description: "France's second-largest city, a vibrant port with a rich cultural mix and the iconic Vieux-Port (Old Port)." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_9da172ba6d1b4a24872cea096995caca~mv2.jpg", correctAnswer: "Melbourne, Australia", options: ["Auckland, New Zealand", "Vancouver, Canada", "Melbourne, Australia"], description: "A stylish coastal city in southeastern Australia, known for its laneway cafes, vibrant arts scene, and major sporting events." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_5f9ee5bb1bfa45b1aa4c83e1b278b5a6~mv2.jpg", correctAnswer: "Osaka, Japan", options: ["Osaka, Japan", "Tokyo, Japan", "Taipei, Taiwan"], description: "A large port city and commercial center on the Japanese island of Honshu, known for its modern architecture, street food, and lively nightlife." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_4214e6a2c4be4d5cb19cd3687632ea17~mv2.avif", correctAnswer: "Muscat, Oman", options: ["Dammam, Saudi Arabia", "Muscat, Oman", "Jahra, Kuwait"], description: "The capital city of Oman, known for its ancient souks, beautiful mosques, and stunning coastal scenery." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_0a64c3d10bb642fbbe3e2bb44c9c453c~mv2.jpg", correctAnswer: "Porto, Portugal", options: ["Bilbao, Spain", "Tallinn, Estonia", "Porto, Portugal"], description: "A coastal city in northwest Portugal, famous for its port wine cellars and the Ribeira district's colorful, narrow streets along the Douro River." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_d9af5b619664458f9ea65841ef1f3c95~mv2.jpg", correctAnswer: "Rio de Janeiro, Brazil", options: ["Rio de Janeiro, Brazil", "Apopa, El Salvador", "Guanajuato, Mexico"], description: "Famous for its iconic Christ the Redeemer statue, Sugarloaf Mountain, and vibrant beaches like Copacabana and Ipanema." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_6362e11c604b42809cf8f2b62ac076f4~mv2.jpg", correctAnswer: "Prague, Czechia", options: ["Budapest, Hungary", "Prague, Czechia", "Krakow, Poland"], description: "The capital of the Czech Republic, renowned for its Old Town Square, Charles Bridge, and fairytale architecture." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_0e83b15b48c644bdb2fc21974aa67428~mv2.jpg", correctAnswer: "Seoul, South Korea", options: ["Beijing, China", "Tokyo, Japan", "Seoul, South Korea"], description: "The vibrant capital of South Korea, a dynamic mix of ancient temples, cutting-edge technology, and bustling street markets." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_02627aadd7534ce29f48f868ed3d02a7~mv2.jpg", correctAnswer: "Rome, Italy", options: ["Rome, Italy", "Lisbon, Portugal", "Madrid, Spain"], description: "The Eternal City, capital of Italy, home to ancient wonders like the Colosseum and the Roman Forum." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_e14ab9b84c0849d79a4f15bad4497d06~mv2.webp", correctAnswer: "Vancouver, Canada", options: ["Seattle, USA", "Vancouver, Canada", "Sydney, Australia"], description: "A vibrant coastal city in British Columbia, Canada, known for its stunning natural beauty, surrounded by mountains and the Pacific Ocean." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_15ea364d60264367b040d335d0327501~mv2.jpg", correctAnswer: "Tbilisi, Georgia", options: ["Yerevan, Armenia", "Tehran, Iran", "Tbilisi, Georgia"], description: "The ancient capital of Georgia, known for its diverse architecture reflecting centuries of history, thermal springs, and vibrant cultural scene." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_1f26ea3b95c447e7b13e70e1373dcbce~mv2.jpg", correctAnswer: "Yerevan, Armenia", options: ["Yerevan, Armenia", "Beirut, Lebanon", "Bishek, Kyrgyzstan"], description: "The ancient capital of Armenia, set in the highlands and known for its grand Soviet-era architecture and views of Mount Ararat." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_a81c9b272738498eabb5a59bbcf3fec8~mv2.jpg", correctAnswer: "Beijing, China", options: ["Hong Kong", "Beijing, China", "Bangok, Thailand"], description: "The capital of China, a city rich in history and culture, home to iconic sites like the Forbidden City and the Great Wall." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_af3fe5983f41472f85b2d498aef7dc6e~mv2.jpeg", correctAnswer: "Chicago, USA", options: ["Wellingtin, New Zealand", "Montreal, Canada", "Chicago, USA"], description: "Known for its bold architecture, blues music, and deep-dish pizza, this major city sits on Lake Michigan." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_9f26e4a72c734a72b7b029bcf139d08b~mv2.jpg", correctAnswer: "Hanoi, Vietnam", options: ["Hanoi, Vietnam", "Phnom Penh, Cambodia", "Kuala Lumpur, Malaysia"], description: "The capital of Vietnam, known for its Old Quarter, French colonial architecture, and serene lakes." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_aac6a86cb69742a49b66bdd8a7a8c2a5~mv2.jpg", correctAnswer: "Manila, Philippines", options: ["Jakarta, Indonesia", "Manila, Philippines", "Singapore"], description: "The bustling capital of the Philippines, a vibrant mix of historic Intramuros and modern skyscrapers." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_3667799d353e44fca42f49ccf8f5280e~mv2.avif", correctAnswer: "Hyderabad, India", options: ["Jamalpur, Bangladesh", "Lahore, Pakistan", "Hyderabad, India"], description: "A historic city in southern India, known for its pearl and diamond trading centers, and Charminar." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_babf7e1b0857429b889ee70355465717~mv2.jpg", correctAnswer: "Marrakech, Morocco", options: ["Marrakech, Morocco", "Tunis, Tunisia", "Cairo, Egypt"], description: "A major city in Morocco, known for its bustling Djemaa el-Fna square, vibrant souks, and beautiful mosques and gardens." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_52d8a4c923b749b89f4fafe933385cf6~mv2.jpg", correctAnswer: "Mexico City, Mexico", options: ["Lima, Peru", "Mexico City, Mexico", "Guayana, Venezuela"], description: "The sprawling, high-altitude capital of Mexico, known for its Aztec ruins, colonial architecture, and vibrant arts scene." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_f45206a737ea4a6cb6f1ed5a378d8f93~mv2.jpg", correctAnswer: "Oslo, Norway", options: ["Stockholm, Sweden", "Helsinki, Finland", "Oslo, Norway"], description: "The capital of Norway, situated at the head of the Oslofjord, known for its green spaces, museums, and maritime history." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_64f75787d8674c75803d1a6b9808b1e3~mv2.jpg", correctAnswer: "Algiers, Algeria", options: ["Algiers, Algeria", "Tripoli, Libya", "Casablanca, Morocco"], description: "The capital and largest city of Algeria, located on the Mediterranean coast, known for its whitewashed buildings and the Casbah." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_cebb14bc01db4375a8bda98e97a34b66~mv2.jpg", correctAnswer: "Apia, Samoa", options: ["Suva, Fiji", "Apia, Samoa", "Honiara, Solomon Islands"], description: "The capital and only city of Samoa, located on the northern coast of Upolu island, known for its relaxed pace and tropical surroundings." },
                 { image: "https://static.wixstatic.com/media/9ce3e5_6efce60f140246008e8d78a8fdcb0a68~mv2.jpeg", correctAnswer: "Islamabad, Pakistan", options: ["Kabul, Afghanistan", "Almaty, Kazakasthan", "Islamabad, Pakistan"], description: "The modern capital city of Pakistan, known for its well-organized layout and the Faisal Mosque." }
            ]
        };

        const screensEl = { start: document.getElementById('start-screen'), game: document.getElementById('game-screen'), results: document.getElementById('results-screen'), gameOver: document.getElementById('game-over-screen') };
        const cornerLogoEl = document.getElementById('corner-logo-static');
        const modeOptionsNodeListEl = document.querySelectorAll('.mode-option');
        const teamInputsContainerEl = document.getElementById('team-inputs-container');
        const teamNamesGridEl = document.getElementById('team-names-grid');
        const addTeamBtnEl = document.getElementById('add-team-btn');
        const startGameBtnEl = document.getElementById('start-game-btn');
        const roundTypeTextEl = document.getElementById('round-type-text');
        const roundNumberTextEl = document.getElementById('round-number-text');
        const roundTotalTextEl = document.getElementById('round-total-text');
        const currentScoreTextEl = document.getElementById('current-score-text');
        const scoreTargetDisplayTextEl = document.getElementById('score-target-display-text');
        const currentPlayerDisplayTextEl = document.getElementById('current-player-display-text');
        const placeImageDisplayEl = document.getElementById('place-image-display');
        const leftCurtainEl = document.querySelector('.place-display-stage .stage-curtains.left');
        const rightCurtainEl = document.querySelector('.place-display-stage .stage-curtains.right');
        const optionsContainerEl = document.getElementById('options-container-div');
        const revealAnswerBtnEl = document.getElementById('reveal-answer-btn');
        const resultPlaceImageDisplayEl = document.getElementById('result-place-image-display');
        const correctAnswerTextEl = document.getElementById('correct-answer-text');
        const placeDescriptionTextEl = document.getElementById('place-description-text');
        const guessResultsContainerEl = document.getElementById('guess-results-container-div');
        const scoreDisplayResultsEl = document.getElementById('score-display-results-div');
        const nextRoundBtnEl = document.getElementById('next-round-btn');
        const winMessageFinalTextEl = document.getElementById('win-message-final-text');
        const winnerSubtextEl = document.getElementById('winner-subtext');
        const finalScoresDisplayEl = document.getElementById('final-scores-display-div');
        const playAgainGameBtnEl = document.getElementById('play-again-game-btn');
        const mainMenuNavBtnEl = document.getElementById('main-menu-nav-btn');
        const storeButtonWrapperEl = document.getElementById("store-button-wrapper");
        let treatYourselfElement = null;
        const visitStoreBtnEl = document.getElementById('visit-store-btn');
        const settingsBtnEl = document.getElementById('settings-btn');
        const settingsModalEl = document.getElementById('settings-modal');
        const closeModalBtnEl = document.getElementById('close-modal-btn');
        const bgmVolumeSliderEl = document.getElementById('bgm-volume-slider');
        const sfxToggleBtnEl = document.getElementById('sfx-toggle-btn');
        const feedbackPopupEl = document.getElementById('feedback-popup');
        const feedbackMessageTextPopupEl = document.getElementById('feedback-message-text-el');
        const backgroundMusicAudioEl = document.getElementById('background-game-music');
        const startGameSoundAudioEl = document.getElementById('start-game-sound');
        const interactionSoundAudioEl = document.getElementById('interaction-sound');
        const correctAnswerSoundAudioEl = document.getElementById('correct-answer-sound');
        const wrongAnswerSoundAudioEl = document.getElementById('wrong-answer-sound');
        const winGameSoundAudioEl = document.getElementById('win-game-sound');
        const curtainSoundAudioEl = document.getElementById('curtain-sound');


        function playSound(audioElement) { if (gameConfig.sfxEnabled && audioElement) { audioElement.currentTime = 0; audioElement.volume = 0.7; audioElement.play().catch(e => console.error("SFX error:", e));}}
        function playSoundWithCallback(audioElement, callback, ...args) { if (gameConfig.sfxEnabled && audioElement) { audioElement.currentTime = 0; audioElement.volume = 0.7; let cbEx = false; const exCb = () => { if (!cbEx) { cbEx = true; audioElement.removeEventListener('ended', exCb); if(typeof soundTimeoutId!=='undefined' && soundTimeoutId) clearTimeout(soundTimeoutId); if(callback) callback(...args); }}; audioElement.addEventListener('ended', exCb); const sDur = (audioElement.duration&&isFinite(audioElement.duration))?audioElement.duration*1000:500; const soundTimeoutId=setTimeout(exCb,sDur+200); audioElement.play().catch(e=>{console.error("SFX error:",e);exCb();});} else {if(callback)callback(...args);}}
        function initBackgroundMusic() { backgroundMusicAudioEl.volume = gameConfig.musicVolume; backgroundMusicAudioEl.play().catch(e => console.log("BGM autoplay failed.", e)); }
        settingsBtnEl.addEventListener('click', () => { playSound(interactionSoundAudioEl); settingsModalEl.style.display = 'flex'; });
        closeModalBtnEl.addEventListener('click', () => { playSound(interactionSoundAudioEl); settingsModalEl.style.display = 'none'; });
        window.addEventListener('click', (event) => { if (event.target === settingsModalEl) { playSound(interactionSoundAudioEl); settingsModalEl.style.display = 'none'; } });
        bgmVolumeSliderEl.addEventListener('input', (e) => { gameConfig.musicVolume = parseFloat(e.target.value); backgroundMusicAudioEl.volume = gameConfig.musicVolume; });
        sfxToggleBtnEl.addEventListener('click', () => {
            playSound(interactionSoundAudioEl);
            gameConfig.sfxEnabled = !gameConfig.sfxEnabled;
            sfxToggleBtnEl.textContent = `SFX: ${gameConfig.sfxEnabled ? 'ON' : 'OFF'}`;
            sfxToggleBtnEl.classList.toggle('btn-success', gameConfig.sfxEnabled);
            sfxToggleBtnEl.classList.toggle('btn-danger', !gameConfig.sfxEnabled);
        });
        let feedbackTimeoutHandle; // Renamed to avoid conflict with global feedbackTimeout
        function showFeedbackPopupMessage(message, type = '', duration = 1500) {
            feedbackMessageTextPopupEl.textContent = message;
            feedbackPopupEl.className = 'feedback-popup'; // Reset classes
            if (type) feedbackPopupEl.classList.add(type);
            feedbackPopupEl.classList.add('show'); // This triggers the CSS animation

            clearTimeout(feedbackTimeoutHandle);
            // The CSS animation will handle hiding the popup.
            // We just need to ensure the 'show' class is removed if we want to re-trigger.
             feedbackTimeoutHandle = setTimeout(() => {
                 feedbackPopupEl.classList.remove('show');
             }, duration - 100); // Remove class slightly before animation ends to allow re-triggering
        }

        function triggerConfetti() {
            const confettiCount = 100;
            const colors = ['var(--primary)', 'var(--secondary)', 'var(--success)', 'var(--gold)', 'var(--info)'];
            document.querySelectorAll('.confetti-piece').forEach(el => el.remove());
            for (let i = 0; i < confettiCount; i++) {
                const piece = document.createElement('div');
                piece.classList.add('confetti-piece');
                piece.style.left = Math.random() * 100 + 'vw';
                piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                const animDur = Math.random() * 3 + 2;
                piece.style.animationName = 'fallAndFade';
                piece.style.animationDuration = animDur + 's';
                piece.style.animationDelay = Math.random() * 1 + 's';
                document.body.appendChild(piece);
                setTimeout(() => piece.remove(), (animDur + parseFloat(piece.style.animationDelay || 0)) * 1000 + 500);
            }
        }

        modeOptionsNodeListEl.forEach(option => option.addEventListener('click', function() { playSound(interactionSoundAudioEl); selectGameMode.call(this); }));
        addTeamBtnEl.addEventListener('click', () => { playSound(interactionSoundAudioEl); addTeamInput(); });
        startGameBtnEl.addEventListener('click', () => {
             if(backgroundMusicAudioEl.paused) initBackgroundMusic();
             playSoundWithCallback(startGameSoundAudioEl, startGame);
        });
        revealAnswerBtnEl.addEventListener('click', () => { playSound(interactionSoundAudioEl); revealAnswer(); });
        nextRoundBtnEl.addEventListener('click', () => { playSound(interactionSoundAudioEl); nextRound(); });
        playAgainGameBtnEl.addEventListener('click', () => {
            if(backgroundMusicAudioEl.paused) initBackgroundMusic();
            playSoundWithCallback(startGameSoundAudioEl, playAgain);
        });
        mainMenuNavBtnEl.addEventListener('click', () => { playSound(interactionSoundAudioEl); goToMainMenu(); });
        visitStoreBtnEl.addEventListener('click', () => { playSound(interactionSoundAudioEl); window.location.href = '/store';  });


        function switchScreen(screenId) {
            Object.values(screensEl).forEach(s => s.classList.remove('active'));
            screensEl[screenId].classList.add('active');
            cornerLogoEl.style.display = (screenId !== 'start') ? 'block' : 'none';
            if (treatYourselfElement) {
                treatYourselfElement.style.display = (screenId === 'gameOver') ? 'flex' : 'none';
            }
        }
        function selectGameMode() {
            modeOptionsNodeListEl.forEach(option => option.classList.remove('selected'));
            this.classList.add('selected');
            gameState.gameMode = this.dataset.mode;
            teamInputsContainerEl.style.display = gameState.gameMode === 'multi' ? 'block' : 'none';
            roundTotalTextEl.textContent = gameState.gameMode === 'single' ? '/10' : '';
        }
        function addTeamInput() {
            const teamCount = teamNamesGridEl.querySelectorAll('.team-name-input').length;
            if (teamCount >= 4) { alert("Maximum of 4 teams allowed."); return; }
            const newInputDiv = document.createElement('div');
            newInputDiv.className = 'team-input';
            newInputDiv.innerHTML = `<input type="text" class="team-name-input" placeholder="Team ${teamCount + 1}">`;
            teamNamesGridEl.appendChild(newInputDiv);
        }

        function startGame() {
            if (gameState.gameMode === 'single') {
                gameState.players = ['You']; gameState.scores = { 'You': 0 };
                roundTypeTextEl.textContent = 'Round'; roundTotalTextEl.textContent = '/10';
                scoreTargetDisplayTextEl.textContent = '/10';
            } else {
                gameState.players = Array.from(teamNamesGridEl.querySelectorAll('.team-name-input'))
                    .map((input,idx) => input.value.trim() || `Team ${idx+1}`)
                    .filter(name => name !== '');

                if (gameState.players.length < 2) { alert('You need at least 2 teams for multiplayer!'); return; }
                if (gameState.players.some(name => name.length > 15)) { alert("Team names too long (max 15 chars)!"); return; }
                const uniquePlayerNames = new Set(gameState.players);
                if (uniquePlayerNames.size !== gameState.players.length) { alert("Team names must be unique!"); return; }

                gameState.scores = {}; gameState.players.forEach(team => { gameState.scores[team] = 0; });
                roundTypeTextEl.textContent = 'Round'; roundTotalTextEl.textContent = '';
                scoreTargetDisplayTextEl.textContent = ' to 5';
            }
            gameState.currentRound = 1; gameState.usedPlaces = []; gameState.currentGuess = null; gameState.currentPlayerIndex = 0;
            nextRoundBtnEl.innerHTML = 'Next Round <i class="fas fa-arrow-right"></i>';
            nextRoundBtnEl.disabled = true; // FIX: Should be disabled until answer is revealed
            switchScreen('game');
            setupRound();
        }

        function setupRound() {
            if (leftCurtainEl && rightCurtainEl) {
                leftCurtainEl.classList.remove('open');
                rightCurtainEl.classList.remove('open');
            }
            placeImageDisplayEl.classList.remove('visible');
            placeImageDisplayEl.src = ""; // Clear previous image to prevent flash

            let availablePlaces = gameState.places.filter(place => !gameState.usedPlaces.includes(place.image));
            if (availablePlaces.length === 0) { gameState.usedPlaces = []; availablePlaces = [...gameState.places]; }
            if (availablePlaces.length === 0) { alert("No more places!"); showGameOver(); return; }
            const randomIndex = Math.floor(Math.random() * availablePlaces.length);
            gameState.currentPlace = availablePlaces[randomIndex];
            gameState.usedPlaces.push(gameState.currentPlace.image);

            roundNumberTextEl.textContent = gameState.currentRound;
            currentScoreTextEl.textContent = gameState.gameMode === 'single' ? gameState.scores['You'] : gameState.scores[gameState.players[gameState.currentPlayerIndex]];
            placeImageDisplayEl.src = gameState.currentPlace.image;
            placeImageDisplayEl.alt = gameState.currentPlace.correctAnswer;


            currentPlayerDisplayTextEl.style.display = gameState.gameMode === 'multi' ? 'block' : 'none';
            if (gameState.gameMode === 'multi') { currentPlayerDisplayTextEl.textContent = `${gameState.players[gameState.currentPlayerIndex]}'s turn`; }

            optionsContainerEl.innerHTML = ''; revealAnswerBtnEl.style.display = 'none';
            const shuffledOptions = [...gameState.currentPlace.options].sort(() => Math.random() - 0.5);
            // Ensure only 3 options are displayed
            const displayOptions = shuffledOptions.slice(0, 3);
            displayOptions.forEach(optionText => {
                const optionBtn = document.createElement('button');
                optionBtn.className = 'option-btn'; optionBtn.innerHTML = `<i class="far fa-circle"></i> ${optionText}`;
                optionBtn.dataset.option = optionText;
                optionBtn.addEventListener('click', (e) => { playSound(interactionSoundAudioEl); handleOptionSelect(e); });
                optionsContainerEl.appendChild(optionBtn);
            });
            gameState.currentGuess = null;
            nextRoundBtnEl.disabled = true; // Disable until round is processed

            setTimeout(() => {
                if (curtainSoundAudioEl) playSound(curtainSoundAudioEl);
                if (leftCurtainEl && rightCurtainEl) {
                    leftCurtainEl.classList.add('open');
                    rightCurtainEl.classList.add('open');
                }
                placeImageDisplayEl.classList.add('visible');
            }, 300);
        }

        function handleOptionSelect(event) {
            const selectedButton = event.currentTarget; gameState.currentGuess = selectedButton.dataset.option;
            document.querySelectorAll('#options-container-div .option-btn').forEach(btn => {
                btn.disabled = true; // Disable all options
                // btn.style.cursor = 'default'; // Already handled by :disabled
                if (btn !== selectedButton) { // Reset icon for non-selected
                    btn.querySelector('i').className = 'far fa-circle';
                }
            });
            selectedButton.querySelector('i').className = 'fas fa-check-circle';
            revealAnswerBtnEl.style.display = 'inline-flex';
            revealAnswerBtnEl.disabled = false; // Enable reveal button
        }

        function revealAnswer() {
            revealAnswerBtnEl.disabled = true;
            const optionButtons = optionsContainerEl.querySelectorAll('.option-btn');
            const guessedCorrectly = gameState.currentGuess === gameState.currentPlace.correctAnswer;

            optionButtons.forEach(btn => {
                // Keep all buttons disabled after reveal to prevent further interaction
                btn.disabled = true;
                // Apply visual styles based on correctness
                if (btn.dataset.option === gameState.currentPlace.correctAnswer) {
                    btn.classList.add('correct');
                    btn.querySelector('i').className = 'fas fa-check-circle';
                } else if (btn.dataset.option === gameState.currentGuess && !guessedCorrectly) {
                    btn.classList.add('incorrect');
                    btn.querySelector('i').className = 'fas fa-times-circle';
                } else {
                    // For options that were neither selected nor correct, ensure they are visually distinct if needed
                    // The 'disabled-option' class might not be strictly necessary if :disabled covers it
                    // btn.classList.add('disabled-option'); // This was making them look too faded, default disabled is fine
                }
            });

            // FIX: Call feedback popup here
            if (guessedCorrectly) {
                playSound(correctAnswerSoundAudioEl);
                const currentPlayerName = gameState.gameMode === 'single' ? 'You' : gameState.players[gameState.currentPlayerIndex];
                gameState.scores[currentPlayerName]++;
                showFeedbackPopupMessage('Correct!', 'correct-feedback', 2000); // Increased duration
            } else {
                playSound(wrongAnswerSoundAudioEl);
                showFeedbackPopupMessage('Incorrect!', 'incorrect-feedback', 2000); // Increased duration
            }

            setTimeout(() => {
                switchScreen('results');
                showResultsScreenUI();
                // revealAnswerBtnEl.disabled = false; // Not needed, button is on game screen
                nextRoundBtnEl.disabled = false;
            }, 2000); // Matched duration to feedback popup
        }

        function showResultsScreenUI() {
            resultPlaceImageDisplayEl.src = gameState.currentPlace.image;
            resultPlaceImageDisplayEl.classList.add('visible'); // <<< EDITED: This line makes the image appear
            correctAnswerTextEl.textContent = gameState.currentPlace.correctAnswer;
            placeDescriptionTextEl.textContent = gameState.currentPlace.description;
            guessResultsContainerEl.innerHTML = '';
            const resultCard = document.createElement('div');
            const guessedCorrectly = gameState.currentGuess === gameState.currentPlace.correctAnswer;
            resultCard.className = `guess-result ${guessedCorrectly ? 'correct-guess' : ''}`;
            const playerNameEl = document.createElement('div'); playerNameEl.className = 'player-name';
            playerNameEl.textContent = gameState.gameMode === 'single' ? 'Your Guess:' : `${gameState.players[gameState.currentPlayerIndex]}'s Guess:`;
            const guessTextEl = document.createElement('div'); guessTextEl.className = 'guess-text';
            guessTextEl.textContent = `${gameState.currentGuess || 'No guess made'}`;
            const feedbackTextEl = document.createElement('div'); feedbackTextEl.className = 'result-feedback-text';
            feedbackTextEl.innerHTML = guessedCorrectly ? '<i class="fas fa-check-circle"></i> Correct! +1 point' : '<i class="fas fa-times-circle"></i> Incorrect!';
            resultCard.appendChild(playerNameEl); resultCard.appendChild(guessTextEl); resultCard.appendChild(feedbackTextEl);
            guessResultsContainerEl.appendChild(resultCard);
            updateScoreDisplayOnResults();

            const maxScore = Math.max(...Object.values(gameState.scores));
            const roundsToEnd = gameState.gameMode === 'single' ? 10 : 5;
            const targetToEnd = gameState.gameMode === 'single' ? gameState.currentRound : maxScore;

            if (targetToEnd >= roundsToEnd) {
                nextRoundBtnEl.innerHTML = 'See Final Results <i class="fas fa-trophy"></i>';
            } else {
                 nextRoundBtnEl.innerHTML = 'Next Round <i class="fas fa-arrow-right"></i>';
            }
        }

        function updateScoreDisplayOnResults() {
            scoreDisplayResultsEl.innerHTML = '';
            Object.entries(gameState.scores).forEach(([name, score]) => {
                const scoreCard = document.createElement('div'); scoreCard.className = 'score-card';
                const maxForProgress = gameState.gameMode === 'single' ? 10 : 5;
                const progressWidth = (score / maxForProgress) * 100;
                scoreCard.innerHTML = `<div class="team-name-score">${name}</div><div class="score-value-display">${score}</div><div class="progress-bar"><div class="progress-fill" style="width: ${progressWidth}%"></div></div>`;
                scoreDisplayResultsEl.appendChild(scoreCard);
            });
        }

        function nextRound() {
            const maxScore = Math.max(...Object.values(gameState.scores));
            const winTargetScore = 5;
            const maxRoundsForSinglePlayer = 10;

            if ((gameState.gameMode === 'single' && gameState.currentRound >= maxRoundsForSinglePlayer) ||
                (gameState.gameMode === 'multi' && maxScore >= winTargetScore)) {
                showGameOver();
            } else {
                gameState.currentRound++;
                if (gameState.gameMode === 'multi') {
                     gameState.currentPlayerIndex = (gameState.currentPlayerIndex + 1) % gameState.players.length;
                }
                switchScreen('game');
                setupRound();
            }
        }

        function showGameOver() {
            playSound(winGameSoundAudioEl);
            triggerConfetti();
            switchScreen('gameOver');
            const maxScore = Math.max(...Object.values(gameState.scores));
            const winners = Object.entries(gameState.scores).filter(([_, score]) => score === maxScore).map(([name]) => name);

            if (winners.length === 1) {
                winMessageFinalTextEl.textContent = `${winners[0]} Wins!`;
                winnerSubtextEl.textContent = gameState.gameMode === 'single' ? `You scored ${maxScore} out of 10!` : `Congratulations on reaching ${maxScore} points!`;
                showFeedbackPopupMessage(`${winners[0]} Wins!`, 'win-feedback', 3000);
            } else {
                winMessageFinalTextEl.textContent = "It's a Tie!";
                winnerSubtextEl.textContent = `${winners.join(' and ')} both finished with ${maxScore} points. Well played!`;
                showFeedbackPopupMessage("It's a Tie Game!", 'win-feedback', 3000);
            }

            finalScoresDisplayEl.innerHTML = '';
            Object.entries(gameState.scores).forEach(([name, score]) => {
                const scoreCard = document.createElement('div');
                scoreCard.className = `score-card ${winners.includes(name) ? 'winner-glow' : ''}`;
                scoreCard.innerHTML = `<div class="team-name-score">${name}</div><div class="score-value-display">${score}</div>`;
                finalScoresDisplayEl.appendChild(scoreCard);
            });
            if (!treatYourselfElement) {
                treatYourselfElement = document.createElement('div');
                treatYourselfElement.className = 'treat-yourself-callout';
                treatYourselfElement.innerHTML = `<span>Treat Yourself!</span> <i class="fas fa-arrow-down"></i>`;
                if (storeButtonWrapperEl && visitStoreBtnEl) {
                   storeButtonWrapperEl.insertBefore(treatYourselfElement, visitStoreBtnEl);
                }
            }
             // Ensure treat yourself is visible on game over
             if (treatYourselfElement) treatYourselfElement.style.display = 'flex';
        }

        function playAgain() {
            if (treatYourselfElement) treatYourselfElement.style.display = 'none';
            startGame();
        }
        function goToMainMenu() {
            teamNamesGridEl.innerHTML = `
                <div class="team-input"><input type="text" class="team-name-input" placeholder="Team 1"></div>
                <div class="team-input"><input type="text" class="team-name-input" placeholder="Team 2"></div>
            `;
            modeOptionsNodeListEl.forEach(opt => opt.classList.remove('selected'));
            if (modeOptionsNodeListEl.length > 0) modeOptionsNodeListEl[0].classList.add('selected');
            teamInputsContainerEl.style.display = 'none';
            gameState.gameMode = 'single';
            if (treatYourselfElement) treatYourselfElement.style.display = 'none';
            if(backgroundMusicAudioEl.paused) initBackgroundMusic();
            switchScreen('start');
        }

        document.addEventListener('DOMContentLoaded', () => {
            sfxToggleBtnEl.textContent = `SFX: ${gameConfig.sfxEnabled ? 'ON' : 'OFF'}`;
            sfxToggleBtnEl.classList.toggle('btn-success',gameConfig.sfxEnabled);
            sfxToggleBtnEl.classList.toggle('btn-danger',!gameConfig.sfxEnabled);
            bgmVolumeSliderEl.value = gameConfig.musicVolume;
            initBackgroundMusic();
            switchScreen('start');
        });
    </script>
</body>
</html>