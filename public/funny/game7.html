<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What Happens Next - Blyza Game Center</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Luckiest+Guy&family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- START: BRAND IDENTITY & ROOT VARIABLES --- */
        :root {
            --blyza-orange-primary: #FF8833;
            --blyza-purple-secondary: #cb7ae1;
            --blyza-keppel-accent: #00BFA6;
            --blyza-sunny-yellow: #FFDF00;
            --blyza-quickfire-red: #EA2027;

            --darker-grey-bg: #4A4A4A;
            --text-light: #FDFEFE;
            --text-dark: #2C3A47;
            --text-medium: #535c68;
            --black-stroke: #1A1A1A;

            --font-logo: "Luckiest Guy", cursive;
            --font-heading-alt: "Bungee", cursive;
            --font-body: 'Quicksand', sans-serif;
            --border-radius-game: 12px;
            --shadow-chunky: 4px 4px 0px var(--black-stroke);
        }
        /* --- END: BRAND IDENTITY & ROOT VARIABLES --- */

        /* --- Basic Reset & Body --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        
        /* --- CUSTOM SCROLLING BODY --- */
        body {
            font-family: var(--font-body);
            color: var(--text-light);
            background: linear-gradient(135deg, var(--blyza-orange-primary) 0%, var(--blyza-purple-secondary) 100%);
            line-height: 1.6;
            overflow: hidden; /* Body does not scroll */
            position: relative;
            height: var(--app-height, 100vh); /* Full screen height */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px 10px;
        }

        /* --- Floating Background Elements --- */
        .hero-background-elements { position: fixed; top:0; left:0; width:100%; height:100%; z-index:0; pointer-events: none; }
        .bg-game-element {
            position: absolute; opacity: 0.1; color: var(--text-light);
            animation: floatSimple 20s infinite ease-in-out alternate;
            user-select: none;
        }
        .bg-video-1 { font-size: 150px; top: 10%; left: 5%; --initial-rotate: -15deg; animation-duration: 22s; }
        .bg-play-1 { font-size: 100px; top: 65%; right: 8%; --initial-rotate: 10deg; animation-duration: 18s; }
        .bg-question-1 { font-size: 120px; top: 70%; left: 15%; --initial-rotate: 5deg; animation-duration: 25s; opacity: 0.08; }
        .bg-film-1 { font-size: 130px; top: 15%; right: 10%; --initial-rotate: 20deg; animation-duration: 16s; }
        .bg-video-2 { font-size: 80px; top: 80%; right: 25%; --initial-rotate: 25deg; animation-duration: 15s; }
        .bg-play-2 { font-size: 120px; bottom: 5%; left: 3%; --initial-rotate: -5deg; animation-duration: 28s; }
        .bg-question-2 { font-size: 90px; top: 20%; left: 20%; --initial-rotate: 15deg; animation-duration: 20s; }
        .bg-eye-1 { font-size: 70px; top: 5%; right: 30%; --initial-rotate: -10deg; animation-duration: 24s; }
        .bg-forward-1 { font-size: 110px; bottom: 10%; right: 4%; --initial-rotate: 12deg; animation-duration: 19s; }
        .bg-film-2 { font-size: 60px; top: 50%; left: 1%; --initial-rotate: 20deg; animation-duration: 26s; }


        @keyframes floatSimple {
            0% { transform: translateY(0px) rotate(var(--initial-rotate, 0deg)); }
            50% { transform: translateY(-25px) rotate(calc(var(--initial-rotate, 0deg) + 8deg)); }
            100% { transform: translateY(0px) rotate(calc(var(--initial-rotate, 0deg) - 8deg)); }
        }
        
        /* --- CUSTOM SCROLLING CONTAINER --- */
        .game-container {
            max-width: 950px;
            width: 100%;
            background: linear-gradient(145deg, #fdfefe, #e9ecef);
            color: var(--text-dark);
            border-radius: var(--border-radius-game);
            border: 3px solid var(--black-stroke);
            box-shadow: 8px 8px 0px var(--black-stroke);
            padding: 30px; 
            text-align: center;
            position: relative;
            z-index: 2;
            max-height: calc(var(--app-height, 100vh) - 40px); /* Make container scrollable */
            overflow-y: auto;
        }

        .brand-logo { object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .brand-logo-prominent { display: block; margin: 0 auto 15px; max-height: 80px; }
        
        h1 {
            font-family: var(--font-logo);
            font-size: clamp(2.5rem, 5vw, 3.2rem);
            color: var(--blyza-orange-primary);
            -webkit-text-stroke: 2px var(--black-stroke);
            text-stroke: 2px var(--black-stroke);
            text-shadow: 3px 3px 0px rgba(0,0,0,0.15);
            margin-bottom: 20px;
            line-height: 1.1;
        }

        h3 { 
            font-family: var(--font-heading-alt); 
            margin-top: 25px;
            margin-bottom: 15px; 
            font-size: 1.5rem;
            color: var(--text-dark);
        }
        
        .screen { display: none; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .active { display: block; }
        
        /* --- Instructions & Info Panels --- */
        .instructions, .team-inputs {
            background: rgba(0,0,0, 0.04);
            padding: 20px; border-radius: 10px; margin: 25px 0;
            border: 2px dashed var(--text-medium);
        }
        .instructions p { font-size: 1.1rem; margin-bottom: 15px; font-weight: 600; }
        .instructions ul { list-style-type: none; text-align: left; padding: 0 10px; }
        .instructions li { margin-bottom: 10px; display: flex; align-items: center; }
        .instructions i { margin-right: 15px; font-size: 1.3em; color: var(--blyza-purple-secondary); width:20px; text-align:center;}
        
        /* --- Buttons --- */
        button, .btn-primary, .btn-secondary, .btn-success, .btn-danger, .btn-info {
            font-family: var(--font-heading-alt); font-size: 1.1rem; padding: 0.7em 1.5em;
            border: 3px solid var(--black-stroke); border-radius: 8px;
            text-transform: uppercase; text-decoration: none; display: inline-flex;
            align-items: center; justify-content: center; gap: 10px;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            letter-spacing: 1px; cursor: pointer; color: var(--text-dark);
            margin: 8px 5px;
            box-shadow: var(--shadow-chunky);
        }
        button:hover:not(:disabled) { transform: translate(2px, 2px); box-shadow: 2px 2px 0px var(--black-stroke); }
        button:active:not(:disabled) { transform: translate(4px, 4px); box-shadow: 0px 0px 0px var(--black-stroke); }
        button:disabled { background: var(--text-medium); color: var(--text-light); cursor: not-allowed; opacity: 0.7; box-shadow: var(--shadow-chunky); }

        .btn-primary, #start-game-btn, #reveal-video-btn, #next-round-btn { background-color: var(--blyza-sunny-yellow); }
        .btn-secondary, #add-team-btn, #main-menu-btn { background-color: var(--blyza-purple-secondary); color: var(--text-light); }
        .btn-success, #play-again-btn { background-color: var(--blyza-keppel-accent); color: var(--text-light); }
        .btn-danger { background-color: var(--blyza-quickfire-red); color: var(--text-light); }
        .btn-info, #visit-store-btn { background-color: #4ECDC4; color: var(--text-dark); }

        /* --- Mode & Team Selection --- */
        .game-mode-selection { display: flex; justify-content: center; gap: 20px; margin: 30px 0; flex-wrap: wrap; }
        .mode-option {
            background: var(--text-light); padding: 20px; border-radius: var(--border-radius-game);
            cursor: pointer; transition: all 0.3s ease; border: 3px solid var(--black-stroke);
            box-shadow: var(--shadow-chunky); flex: 1; min-width: 250px; max-width: 300px;
        }
        .mode-option:hover { transform: translateY(-5px) scale(1.02); box-shadow: 6px 6px 0 var(--blyza-orange-primary); }
        .mode-option.selected {
            background: var(--blyza-keppel-accent); color: var(--text-light); border-color: var(--black-stroke);
            transform: scale(1.02); box-shadow: 6px 6px 0 var(--black-stroke);
        }
        .mode-option.selected i, .mode-option.selected h3, .mode-option.selected p { color: var(--text-light); }
        .mode-option i { font-size: 2.5rem; margin-bottom: 10px; color: var(--blyza-orange-primary); transition: all 0.3s ease; }
        .mode-option h3 { margin-bottom: 8px; font-size: 1.3rem; margin-top: 0; }
        .mode-option p { color: var(--text-medium); font-size: 0.9rem; }
        .team-inputs h3 { font-family: var(--font-heading-alt); margin-bottom: 15px; margin-top:0; }
        .team-input-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .team-input-wrapper input {
            width: 100%; padding: 12px 18px; border-radius: 8px;
            border: 3px solid var(--black-stroke); background: var(--text-light);
            color: var(--text-dark); font-size: 1rem; transition: all 0.3s ease;
            font-family: var(--font-body); font-weight: 600;
        }
        .team-input-wrapper input:focus { outline: none; border-color: var(--blyza-orange-primary); box-shadow: 0 0 0 3px var(--blyza-sunny-yellow); }
        .remove-team-btn {
            background: var(--blyza-quickfire-red); color: var(--text-light);
            padding: 8px 12px; font-size: 0.8rem; margin: 0;
        }
        .remove-team-btn:disabled { background: var(--text-medium); cursor: not-allowed; opacity: 0.7; }
        #add-team-btn { font-size: 1rem; padding: 10px 20px;}

        /* --- Game Screen & Video Stage --- */
        .game-info {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            padding: 12px 15px;
            background: rgba(0,0,0,0.1);
            border-radius: 8px;
            font-size: 1.1rem;
            font-family: var(--font-heading-alt);
            color: var(--text-dark);
            border: 2px solid var(--black-stroke);
        }
        #turn-indicator { font-size: 1.2rem; color: var(--blyza-purple-secondary); text-shadow: 1px 1px 0 var(--black-stroke); }
        .video-stage-container {
            background: var(--darker-grey-bg); padding: 20px; border-radius: var(--border-radius-game);
            margin: 25px auto; border: 3px solid var(--black-stroke);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.3); position: relative; overflow: hidden;
        }
        .tv-screen-wrapper {
            background: #111; border: 10px solid #333; border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.7), inset 0 0 10px rgba(0,0,0,0.5);
            position: relative; z-index: 1;
            width: 100%; aspect-ratio: 16 / 9; overflow: hidden;
        }
        .stage-curtains {
            position: absolute; top: 0; width: 51%; height: 100%;
            background-color: var(--text-dark);
            background-image: repeating-linear-gradient(90deg, transparent, transparent 20px, rgba(255,255,255,0.03) 20px, rgba(255,255,255,0.03) 40px);
            box-shadow: 0 0 25px rgba(0,0,0,0.6);
            transition: transform 1.2s cubic-bezier(0.77, 0, 0.175, 1);
            z-index: 5;
        }
        .stage-curtains.left { left: 0; border-right: 6px solid var(--blyza-orange-primary); }
        .stage-curtains.right { right: 0; border-left: 6px solid var(--blyza-orange-primary); }
        .stage-curtains.open.left { transform: translateX(-105%) skewX(-10deg); }
        .stage-curtains.open.right { transform: translateX(105%) skewX(10deg); }
        video {
            width: 100%; height: 100%; display: block; object-fit: cover;
            opacity: 0; transition: opacity 0.5s ease-in 0.7s;
        }
        video.visible { opacity: 1; }

        /* --- Options & Results --- */
        .options-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px; margin: 25px 0;
        }
        .option {
            font-family: var(--font-body); font-weight: 700; text-transform: none;
            justify-content: flex-start; text-align: left; padding: 0.8em 1.2em;
            background-color: var(--text-light);
        }
        .option.selected {
            border-color: var(--blyza-orange-primary) !important;
            background-color: var(--blyza-sunny-yellow) !important;
            box-shadow: 4px 4px 0px var(--black-stroke) !important;
            transform: translate(2px, 2px);
        }
        .option.correct {
            background-color: var(--blyza-keppel-accent) !important;
            color: var(--text-light) !important; border-color: var(--black-stroke) !important;
        }
        .option.incorrect {
            background-color: var(--blyza-quickfire-red) !important;
            color: var(--text-light) !important; border-color: var(--black-stroke) !important;
        }
        .option i { margin-right: 15px; font-size: 1.2em; }

        #detailed-feedback-area-results {
            margin: 25px auto; font-size: 1.1rem; line-height: 1.7;
            font-weight: 600; max-width: 90%;
        }
        #detailed-feedback-area-results strong { font-family: var(--font-heading-alt); }
        
        /* --- Score & Game Over --- */
        .score-display-multi, #final-scores-display-area {
            display: grid; gap: 20px; margin: 30px 0;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        .score-card {
            background: rgba(0,0,0,0.05); padding: 20px; border-radius: 10px;
            border: 3px solid var(--black-stroke); transition: all 0.3s ease;
            box-shadow: var(--shadow-chunky);
        }
        .score-card h4 { font-family: var(--font-heading-alt); color: var(--blyza-orange-primary); }
        .score-card .score-value { font-family: var(--font-heading-alt); font-size: 2rem; }
        .score-card.winner-glow {
            animation: winnerGlow 1.5s infinite alternate;
            border-color: var(--blyza-keppel-accent);
        }
        @keyframes winnerGlow { from { box-shadow: 4px 4px 0 var(--blyza-keppel-accent); } to { box-shadow: 4px 4px 15px var(--blyza-keppel-accent); } }
        
        .progress-bar-multi {
            height: 12px; background: rgba(0,0,0,0.2); border-radius: 50px;
            margin-top: 15px; overflow: hidden; border: 2px solid var(--black-stroke);
        }
        .progress-fill-multi {
            height: 100%; background: var(--blyza-sunny-yellow);
            border-radius: 50px; transition: width 0.5s ease;
        }

        .winner-trophy {
            font-size: 6rem; margin: 20px 0; animation: bounce 1.5s infinite ease-in-out;
            color: var(--blyza-sunny-yellow);
            text-shadow: 0 0 20px var(--blyza-orange-primary), 3px 3px 0 var(--black-stroke);
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-25px); } }
        
        .win-message {
            font-family: var(--font-logo); font-size: 3rem; margin: 20px 0;
            color: var(--blyza-orange-primary);
            -webkit-text-stroke: 2px var(--black-stroke);
            text-stroke: 2px var(--black-stroke);
        }
        #final-score-message-text { font-size: 1.1rem; font-weight: 600; }

        /* --- Floating Icon Buttons --- */
        .icon-btn {
            position: absolute; background-color: var(--blyza-purple-secondary);
            color: var(--text-light); border-radius: 50%; width: 55px; height: 55px;
            font-size: 1.2rem; cursor: pointer; transition: all 0.1s ease;
            display: flex; justify-content: center; align-items: center; z-index: 100;
            text-decoration: none; border: 3px solid var(--black-stroke);
            box-shadow: 4px 4px 0px var(--black-stroke);
        }
        .icon-btn:hover:not(:disabled) { transform: translate(2px, 2px); box-shadow: 2px 2px 0px var(--black-stroke); }
        .icon-btn:active:not(:disabled) { transform: translate(4px, 4px); box-shadow: 0px 0px 0px var(--black-stroke); }
        #settings-btn { top: 20px; right: 20px; }
        #home-menu-btn, #back-btn { top: 20px; left: 20px; }
        #back-btn { display: none; }
        
        /* --- Modal Styles --- */
        .modal {
            position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6); -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; animation: fadeInModal 0.3s ease;
        }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        .modal-content {
            background-color: var(--darker-grey-bg); margin: auto; padding: 25px;
            border: 3px solid var(--black-stroke); border-radius: var(--border-radius-game);
            width: 90%; max-width: 450px; box-shadow: 8px 8px 0px rgba(0,0,0,0.4);
            position: relative; color: var(--text-light); text-align: center;
        }
        .modal-content h2 {
            font-family: var(--font-logo); color: var(--blyza-orange-primary);
            -webkit-text-stroke: 1.5px var(--black-stroke); text-stroke: 1.5px var(--black-stroke);
            text-align: center; margin-bottom: 25px; font-size: 2rem;
        }
        .setting-item { margin-bottom: 18px; display: flex; flex-direction: column; }
        .setting-item label { margin-bottom: 10px; font-weight: 600; font-size: 1rem; }
        .close-modal-btn { color: #aaa; position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .close-modal-btn:hover { color: var(--text-light); }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 10px; cursor: pointer; background: rgba(0,0,0,0.3); border-radius: 5px; border: 2px solid var(--black-stroke); }
        input[type=range]::-webkit-slider-thumb { border: 2px solid var(--black-stroke); height: 22px; width: 22px; border-radius: 50%; background: var(--blyza-orange-primary); cursor: pointer; -webkit-appearance: none; margin-top: -9px; }

        #audio-consent-modal .modal-content p { font-family: var(--font-body); font-weight: 600; font-size: 1.1rem; margin-bottom: 25px; color: var(--text-light); }
        #audio-consent-buttons { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }

        /* --- Feedback Popup --- */
        .feedback-popup {
            position: fixed; top: 50%; left: 50%;
            background-color: var(--text-dark); color: white;
            padding: 25px 40px; border-radius: var(--border-radius-game);
            font-size: 2.5rem; font-family: var(--font-logo); text-align: center;
            z-index: 2000; box-shadow: 8px 8px 0px rgba(0,0,0,0.5);
            opacity: 0; transform: translate(-50%, -50%) scale(0.7);
            transition: opacity 0.3s ease, transform 0.3s ease;
            pointer-events: none; border: 3px solid var(--black-stroke);
            display: none;
        }
        .feedback-popup.show { opacity: 1; transform: translate(-50%, -50%) scale(1); display: block; }
        .feedback-popup.correct { color: var(--blyza-keppel-accent); }
        .feedback-popup.incorrect { color: var(--blyza-quickfire-red); }
        .feedback-popup.info { color: var(--blyza-sunny-yellow); }

        /* --- Confetti --- */
        .confetti-piece { position: fixed; width: 10px; height: 20px; background-color: var(--blyza-orange-primary); opacity: 0; animation-timing-function: linear; animation-fill-mode: forwards; pointer-events: none; z-index: 3000; }
        @keyframes fallAndFade { 0% { transform: translateY(-20vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(120vh) rotate(720deg); opacity: 0; } }
        
        /* --- Game Over Section & "Treat Yourself" --- */
        .game-over-buttons-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 15px; margin-top: 20px; }
        .game-over-button-wrapper { position: relative; display: flex; flex-direction: column; align-items: center; }
        .treat-yourself-callout {
            margin-bottom: 8px; background-color: var(--blyza-sunny-yellow); color: var(--text-dark);
            padding: 8px 15px; border-radius: 20px; font-family: var(--font-heading-alt);
            font-size: 0.9rem; white-space: nowrap; box-shadow: var(--shadow-chunky);
            display: none; align-items: center; gap: 8px; z-index: 10;
            border: 2px solid var(--black-stroke);
        }
        .treat-yourself-callout i { font-size: 1.2em; animation: bounceArrow 1s infinite; }
        @keyframes bounceArrow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        
        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            body { 
                padding: 10px; 
                align-items: flex-start;
                padding-top: 20px;
                padding-bottom: 20px;
            }
            .game-container { 
                padding: 45px 15px 15px; 
                max-height: calc(var(--app-height, 100vh) - 40px);
            } 
            h1 { font-size: 2.2rem; margin-top: 5px; }
            .instructions { padding: 15px; }
            .options-container, .score-display-multi { grid-template-columns: 1fr; }
            .icon-btn { width: 48px; height: 48px; }
            #settings-btn { top: 12px; right: 12px; }
            #home-menu-btn, #back-btn { top: 12px; left: 12px; }
            .feedback-popup { font-size: 2rem; padding: 20px 30px; width: 90%; }
            .modal-content { padding: 20px; }
            .game-over-buttons-container { flex-direction: column; align-items: center; }
            .game-over-buttons-container .game-over-button-wrapper { width: 90%; }
            .game-over-buttons-container .game-over-button-wrapper button { width: 100%; }
            .win-message { font-size: 2.2rem; }
            .bg-game-element { display: none; }
        }
    </style>
</head>
<body>
    <!-- Floating background elements -->
    <div class="hero-background-elements">
        <div class="bg-game-element bg-video-1"><i class="fas fa-video"></i></div>
        <div class="bg-game-element bg-play-1"><i class="fas fa-play-circle"></i></div>
        <div class="bg-game-element bg-question-1"><i class="fas fa-question-circle"></i></div>
        <div class="bg-game-element bg-film-1"><i class="fas fa-film"></i></div>
        <div class="bg-game-element bg-video-2"><i class="fas fa-video"></i></div>
        <div class="bg-game-element bg-play-2"><i class="fas fa-play-circle"></i></div>
        <div class="bg-game-element bg-question-2"><i class="fas fa-question-circle"></i></div>
        <div class="bg-game-element bg-eye-1"><i class="fas fa-eye"></i></div>
        <div class="bg-game-element bg-forward-1"><i class="fas fa-forward"></i></div>
        <div class="bg-game-element bg-film-2"><i class="fas fa-film"></i></div>
    </div>
    
    <script>
        // THIS SCRIPT MUST RUN FIRST
        function setAppHeight() {
            document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
        }
        window.addEventListener('resize', setAppHeight);
        setAppHeight();
    </script>
    
    <div class="game-container">
       <a href="#" onclick="history.back(); return false;" id="home-menu-btn" class="icon-btn" aria-label="Back to the previous page">
            <i class="fas fa-home"></i>
        </a>
        <button id="back-btn" class="icon-btn" aria-label="Go Back" style="display: none;">
            <i class="fas fa-arrow-left"></i>
        </button>
        <button id="settings-btn" class="icon-btn" aria-label="Open Settings">
            <i class="fas fa-cog"></i>
        </button>

        <!-- Start Screen -->
        <div id="start-screen" class="screen active">
            <img class="brand-logo brand-logo-prominent" src="https://static.wixstatic.com/shapes/9ce3e5_4f0149a89dd841859da02f59247b5b6b.svg" alt="Blyza Mascot">
            <h1>What Happens Next?</h1>
            <div class="instructions">
                <p><strong>HOW TO PLAY:</strong></p>
                <ul>
                    <li><i class="fas fa-video"></i> Watch the first part of a video clip</li>
                    <li><i class="fas fa-question-circle"></i> Guess what happens next from the 3 options provided</li>
                    <li><i class="fas fa-eye"></i> Click "Reveal Video" to see the full clip and find out if you're right!</li>
                    <li><i class="fas fa-users"></i> Play solo or with up to 4 teams!</li>
                    <li><i class="fas fa-star"></i> Score 1 point for each correct guess. The game lasts for 5 rounds</li>
                </ul>
            </div>
            <div class="game-mode-selection">
                <div class="mode-option selected" data-mode="single">
                    <i class="fas fa-user"></i>
                    <h3>Single Player</h3>
                    <p>Play 5 rounds alone</p>
                </div>
                <div class="mode-option" data-mode="multi">
                    <i class="fas fa-users"></i>
                    <h3>Multiplayer</h3>
                    <p>Up to 4 teams</p>
                </div>
            </div>
            <div id="team-inputs-container" style="display: none;">
                <div class="team-inputs">
                    <h3>Enter Team Names</h3>
                    <div id="team-names-list">
                        <div class="team-input-wrapper"><input type="text" class="team-name-input" placeholder="Team 1"></div>
                        <div class="team-input-wrapper"><input type="text" class="team-name-input" placeholder="Team 2"></div>
                    </div>
                    <button id="add-team-btn" class="btn-secondary"><i class="fas fa-plus"></i> Add Team</button>
                </div>
            </div>
            <button id="start-game-btn" class="btn-primary">Start Game <i class="fas fa-play"></i></button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div class="game-info">
                <div id="round-info-text">Round <span id="round-number-text">1</span>/5</div>
                <div id="score-info-text" style="display:none;">Score: <span id="current-score-text">0</span></div>
            </div>
            <div id="turn-indicator" style="display: none;"></div>
            <div class="video-stage-container">
                <div class="tv-screen-wrapper">
                    <div class="stage-curtains left" id="video-curtain-left"></div>
                    <div class="stage-curtains right" id="video-curtain-right"></div>
                    <video id="video-clip-player" controlsList="nodownload" playsinline muted autoplay loop>
                        Your browser does not support the video tag.
                    </video>
                </div>
            </div>
            <h3>What happens next?</h3>
            <div id="options-container-display" class="options-container"></div>
            <button id="reveal-video-btn" class="btn-primary" disabled>Reveal Full Video <i class="fas fa-eye"></i></button>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="screen">
            <h1>Round Result</h1>
            <div class="video-stage-container">
                 <div class="tv-screen-wrapper">
                    <video id="full-video-player" controlsList="nodownload" controls style="opacity:1;" playsinline>
                        Your browser does not support the video tag.
                    </video>
                 </div>
            </div>
            <div id="detailed-feedback-area-results"></div>
            <div id="score-display-area" class="score-display-multi"></div>
            <button id="next-round-btn" class="btn-primary">Next Round <i class="fas fa-arrow-right"></i></button>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="screen">
            <img class="brand-logo brand-logo-prominent" src="https://static.wixstatic.com/shapes/9ce3e5_4f0149a89dd841859da02f59247b5b6b.svg" alt="Blyza Mascot">
            <h1>Game Over!</h1>
            <div class="win-message" id="win-message-text">Game Complete!</div>
            <div class="winner-trophy">üèÜ</div>
            <div id="final-score-message-text">Your final score is...</div>
            <div id="final-scores-display-area" class="score-display-multi"></div>
            <div class="game-over-buttons-container">
                <div class="game-over-button-wrapper">
                    <button id="play-again-btn" class="btn-success"><i class="fas fa-redo"></i> Play Again</button>
                </div>
                <div class="game-over-button-wrapper">
                    <button id="main-menu-btn" class="btn-secondary"><i class="fas fa-home"></i> Main Menu</button>
                </div>
                <div class="game-over-button-wrapper" id="store-button-wrapper">
                    <button id="visit-store-btn" class="btn-info"><i class="fas fa-store"></i> Visit Store</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio Consent Modal -->
    <div id="audio-consent-modal" class="modal">
        <div class="modal-content">
            <h2>Enable Audio?</h2>
            <p>This game has background music and sound effects. Would you like to enable them for the best experience?</p>
            <div id="audio-consent-buttons">
                <button id="audio-consent-yes-btn" class="btn-success"><i class="fas fa-volume-up"></i> Yes, please!</button>
                <button id="audio-consent-no-btn" class="btn-secondary"><i class="fas fa-volume-mute"></i> No, thanks</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span id="close-modal-btn" class="close-modal-btn">√ó</span>
            <h2>Settings</h2>
            <div class="setting-item">
                <label for="bgm-volume-slider">Background Music Volume:</label>
                <input type="range" id="bgm-volume-slider" min="0" max="1" step="0.01" value="0.2">
            </div>
            <div class="setting-item">
                <label for="sfx-toggle-btn">Sound Effects:</label>
                <button id="sfx-toggle-btn" class="btn-secondary">SFX: ON</button>
            </div>
        </div>
    </div>

    <!-- Feedback Pop-up -->
    <div id="feedback-popup" class="feedback-popup">
        <span id="feedback-message-text-el"></span>
    </div>

    <audio id="background-game-music" loop src="https://static.wixstatic.com/mp3/9ce3e5_380adfaea802407b9a4cebc67f12a216.mp3"></audio>
    <audio id="start-game-sound" src="https://static.wixstatic.com/mp3/9ce3e5_1b9151238aec4e29ab14f1526e9c1334.mp3"></audio>
    <audio id="interaction-sound" src="https://static.wixstatic.com/mp3/9ce3e5_fc326aa1760c485dbac083ec55c2bfcb.wav"></audio>
    <audio id="video-reveal-sound" src="https://static.wixstatic.com/mp3/9ce3e5_fc326aa1760c485dbac083ec55c2bfcb.wav"></audio>
    <audio id="correct-answer-sound" src="https://static.wixstatic.com/mp3/9ce3e5_76691a6fefcd4536aa403ada111e886a.mp3"></audio>
    <audio id="wrong-answer-sound" src="https://static.wixstatic.com/mp3/9ce3e5_277f814439064d1bbe5c0342241b23e4.mp3"></audio>
    <audio id="curtain-sound" src="https://static.wixstatic.com/mp3/9ce3e5_ccd36cdf98bf4e1594cf2e52d5296c51.wav"></audio>
    <audio id="confetti-sound" src="https://static.wixstatic.com/mp3/9ce3e5_5d7fcfc389734cf7994f5d37de621e3d.mp3"></audio>

       <script>
        const gameConfig = { totalRounds: 5, sfxEnabled: true, musicVolume: 0.2, minTeams: 2, maxTeams: 4 };
        const gameState = { gameMode: 'single', players: [], scores: {}, currentRound: 0, currentPlayerIndexInRound: 0, roundPlayerChoices: {}, singlePlayerChoice: null, currentClip: null, clips: [ { id: 1, partialUrl: "https://video.wixstatic.com/video/9ce3e5_84548f28d45d4b03b449d0cbd97b590d/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_b76bd68b8d27495f86dcf3e4b70bac4a/1080p/mp4/file.mp4", options: ["A lightning strike brutally hits the car", "A tire launches the car in the air", "Car skids on to the other side of the road"], correctOption: 1 }, { id: 2, partialUrl: "https://video.wixstatic.com/video/9ce3e5_d23402cffe424530af1963fef8f81aa6/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_0d20c45eb31545efa62b6f7fb41bb0c3/1080p/mp4/file.mp4", options: ["Horse bites off the riders shirt", "Rider sucker punches the horse back ", "Horse runs the race without the rider"], correctOption: 2 }, { id: 3, partialUrl: "https://video.wixstatic.com/video/9ce3e5_021f78f0d75446f3a4a6a8de4f501cf8/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_e6137b687c8e492ea4e113faf6f3b849/1080p/mp4/file.mp4", options: ["Man does a double backflip", "Man nearly dodges the supercar", "Man jumps over the supercar"], correctOption: 2 }, { id: 4, partialUrl: "https://video.wixstatic.com/video/9ce3e5_6981fbbc61754965bbafbee9a25b7555/720p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_577a1af924ef4f3db6f38fda862d6083/720p/mp4/file.mp4", options: ["Surfer bumbs into a pole in the ocean", "Surfer catches the beer can and celebrates in style", "A dolphin comes up and pushes the surfer off the board"], correctOption: 0 }, { id: 5, partialUrl: "https://video.wixstatic.com/video/9ce3e5_eca01b923e6b423b85549b3e61cc1145/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_4da8c4280ab04deb9aa2f98e6f274aa0/1080p/mp4/file.mp4", options: ["Another dog pops up and bumbs into the race dog", "Dog stops mid course to take a poo", "Dog jumps on the owner to play instead of racing"], correctOption: 1 }, { id: 6, partialUrl: "https://video.wixstatic.com/video/9ce3e5_b26c4ed824ed4e659a18f820ca2b9073/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_b632503a26a94962965950e478ff2914/1080p/mp4/file.mp4", options: ["The squirrel bites the mans hand", "The squirrel poops on the mans hand", "The squirrel gets eaten by a cat"], correctOption: 2 }, { id: 7, partialUrl: "https://video.wixstatic.com/video/9ce3e5_9f5bd13b46a446e7974ed69fb768c20e/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_bc8bc638a4cf4f40be2fa2b2f9e6c3a8/1080p/mp4/file.mp4", options: ["A man falls through the ceiling.", "A monkey recieves the order.", "Delivery driver gets blasted with flour"], correctOption: 1 }, { id: 8, partialUrl: "https://video.wixstatic.com/video/9ce3e5_4fe5dac5708c4fc495de2c9c9d1f75e4/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_45f5bbbe9e0744ac994857b1689f615c/1080p/mp4/file.mp4", options: ["A snake walks in to the room.", "Her dad walks in to the room.", "She slips and breaks the table."], correctOption: 0 }, { id: 9, partialUrl: "https://video.wixstatic.com/video/9ce3e5_facc1b5721714355abd0108dfc0c3450/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_d975afb8db7046a6a512b4f582b79ca3/1080p/mp4/file.mp4", options: ["Man pulls the table instead.", "Man pulls the table cloth perfectly.", "Man slips on to the table and breaks everything."], correctOption: 0 }, { id: 10, partialUrl: "https://video.wixstatic.com/video/9ce3e5_97e28c78becf449292d14377bec69088/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_e01ab74af57d4974b12b89c495f2365b/1080p/mp4/file.mp4", options: ["An eagle snatches his shade off", "Man gets snow ball thrown on his face", "Man ski's off house roof."], correctOption: 2 }, { id: 11, partialUrl: "https://video.wixstatic.com/video/9ce3e5_23dedb51cbad421d946ae97b683f2686/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_2414116f55df44259431d015c8525ac2/1080p/mp4/file.mp4", options: ["One of the singer starts to throw up.", "A girl starts throwing eggs at the judges.", "Camera pans to auidence member eating his booger."], correctOption: 1 }, { id: 12, partialUrl: "https://video.wixstatic.com/video/9ce3e5_17db7648471c4556b0a371d830a7c0a4/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_238a9a9a22a04e3db56c726c8a127257/1080p/mp4/file.mp4", options: ["Man faints at the finish line.", "His daughter runs into the track.", "Man breaks his leg"], correctOption: 2 }, { id: 13, partialUrl: "https://video.wixstatic.com/video/9ce3e5_d318cfdb4b4c4b2ab0cc390d21b6ff7c/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_3c01170407b447b58cb618381818c05e/1080p/mp4/file.mp4", options: ["Seasaw breaks in half.", "Man gets hit in the head with the seasaw.", "Both men fall into the pond."], correctOption: 1 }, { id: 14, partialUrl: "https://video.wixstatic.com/video/9ce3e5_13ebb4cbdfe34e2cbaf8c938d128f0c0/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_5cb32c3f0cd646a9acbf347ce3de8928/1080p/mp4/file.mp4", options: ["Man kicks ball to girls face.", "Both joggers trip and fall on the ball.", "Cat takes the ball away."], correctOption: 0 }, { id: 15, partialUrl: "https://video.wixstatic.com/video/9ce3e5_5d98adfed19f4f53ba7100406625c1ba/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_a6c7f0ae43224b6e8bc83c6459913c01/1080p/mp4/file.mp4", options: ["Man falls face first onto the road.", "The puddle is deeper than he thought.", "The splash from the puddle drenches the camera man."], correctOption: 1 }, { id: 16, partialUrl: "https://video.wixstatic.com/video/9ce3e5_95b984124cbd45ee92767b076b874499/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_add45699e20841f29594103d8c6165a5/1080p/mp4/file.mp4", options: ["Grandpa kicks running kid", "Grandpa's swing breaks", "Grandpa does backflip"], correctOption: 2 }, { id: 17, partialUrl: "https://video.wixstatic.com/video/9ce3e5_6f79426ea662489abf873c90d486f92c/720p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_ac6c3706141c45ae9503e9f70a39ba36/720p/mp4/file.mp4", options: ["The pan breaks", "The food explodes", "Cat jumps on the food"], correctOption: 0 }, { id: 18, partialUrl: "https://video.wixstatic.com/video/9ce3e5_2cece476721443109d4fee8e06e50c1e/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_a1cf38e6ebbb41af89a47de7bdb47195/1080p/mp4/file.mp4", options: ["The car is filled with skittles", "Bear comes out of the car", "Officer falls into the trunk"], correctOption: 1 } ], usedClips: [] };
        
        const screens = { start: document.getElementById('start-screen'), game: document.getElementById('game-screen'), results: document.getElementById('results-screen'), gameOver: document.getElementById('game-over-screen') };
        const homeMenuBtnEl = document.getElementById('home-menu-btn');
        const backBtnEl = document.getElementById('back-btn');
        const settingsBtnEl = document.getElementById('settings-btn');
        const modeOptionsEl = document.querySelectorAll('.mode-option');
        const teamInputsContainerEl = document.getElementById('team-inputs-container');
        const teamNamesListEl = document.getElementById('team-names-list');
        const addTeamBtnEl = document.getElementById('add-team-btn');
        const startGameBtnEl = document.getElementById('start-game-btn');
        const roundInfoTextEl = document.getElementById('round-info-text');
        const scoreInfoTextEl = document.getElementById('score-info-text');
        const turnIndicatorEl = document.getElementById('turn-indicator');
        const roundNumberTextEl = document.getElementById('round-number-text');
        const currentScoreTextEl = document.getElementById('current-score-text');
        const videoCurtainLeftEl = document.getElementById('video-curtain-left');
        const videoCurtainRightEl = document.getElementById('video-curtain-right');
        const videoClipPlayerEl = document.getElementById('video-clip-player');
        const optionsContainerDisplayEl = document.getElementById('options-container-display');
        const revealVideoBtnEl = document.getElementById('reveal-video-btn');
        const fullVideoPlayerEl = document.getElementById('full-video-player');
        const detailedFeedbackAreaResultsEl = document.getElementById('detailed-feedback-area-results');
        const scoreDisplayAreaEl = document.getElementById('score-display-area');
        const nextRoundBtnEl = document.getElementById('next-round-btn');
        const winMessageTextEl = document.getElementById('win-message-text');
        const finalScoreMessageTextEl = document.getElementById('final-score-message-text');
        const finalScoresDisplayAreaEl = document.getElementById('final-scores-display-area');
        const storeButtonWrapperEl = document.getElementById("store-button-wrapper");
        let treatYourselfElement = null;
        const playAgainBtnEl = document.getElementById('play-again-btn');
        const mainMenuBtnEl = document.getElementById('main-menu-btn');
        const visitStoreBtnEl = document.getElementById('visit-store-btn');
        const settingsModalEl = document.getElementById('settings-modal');
        const closeModalBtnEl = document.getElementById('close-modal-btn');
        const bgmVolumeSliderEl = document.getElementById('bgm-volume-slider');
        const sfxToggleBtnEl = document.getElementById('sfx-toggle-btn');
        const feedbackPopupEl = document.getElementById('feedback-popup');
        const feedbackMessageTextPopupEl = document.getElementById('feedback-message-text-el');
        const audioConsentModalEl = document.getElementById('audio-consent-modal');
        const audioConsentYesBtnEl = document.getElementById('audio-consent-yes-btn');
        const audioConsentNoBtnEl = document.getElementById('audio-consent-no-btn');
        const backgroundMusicAudioEl = document.getElementById('background-game-music');

        const allSfx = [ document.getElementById('start-game-sound'), document.getElementById('interaction-sound'), document.getElementById('video-reveal-sound'), document.getElementById('correct-answer-sound'), document.getElementById('wrong-answer-sound'), document.getElementById('curtain-sound'), document.getElementById('confetti-sound') ];
        let feedbackTimeoutId, audioContextStarted = false;

        function initAudio() {
            if (audioContextStarted) return;
            backgroundMusicAudioEl.play().then(() => {
                audioContextStarted = true;
                if (gameConfig.musicVolume <= 0 || document.hidden) {
                    backgroundMusicAudioEl.pause();
                }
            }).catch(e => { console.warn("Audio autoplay blocked, waiting for user interaction.", e); });
        }
        
        function playSound(audioElement) { 
            if (gameConfig.sfxEnabled && audioElement && audioContextStarted) { 
                audioElement.pause(); 
                audioElement.currentTime = 0; 
                audioElement.play().catch(e => {}); 
            } 
        }
        
        function playSoundWithCallback(audioElement, callback, ...args) { 
            if (gameConfig.sfxEnabled && audioElement && audioContextStarted) { 
                audioElement.pause(); 
                audioElement.currentTime = 0; 
                let cbExecuted = false; 
                const execCb = () => { 
                    if (!cbExecuted) { 
                        cbExecuted = true; 
                        audioElement.removeEventListener('ended', execCb); 
                        if (callback) callback(...args); 
                    } 
                }; 
                audioElement.addEventListener('ended', execCb); 
                audioElement.play().catch(e => { execCb(); }); 
            } else { 
                if (callback) callback(...args); 
            } 
        }

        function showFeedbackMessage(message, type = 'info', duration = 2500) { feedbackMessageTextPopupEl.textContent = message; feedbackPopupEl.className = 'feedback-popup'; if (type) feedbackPopupEl.classList.add(type); feedbackPopupEl.classList.add('show'); clearTimeout(feedbackTimeoutId); feedbackTimeoutId = setTimeout(() => { feedbackPopupEl.classList.remove('show'); }, duration); }
        
        function triggerConfetti() { playSound(allSfx[6]); const colors = ['var(--blyza-orange-primary)', 'var(--blyza-purple-secondary)', 'var(--blyza-keppel-accent)', 'var(--blyza-sunny-yellow)']; for (let i = 0; i < 100; i++) { const piece = document.createElement('div'); piece.classList.add('confetti-piece'); piece.style.left = Math.random() * 100 + 'vw'; piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)]; const animDur = Math.random() * 3 + 2; piece.style.animationName = 'fallAndFade'; piece.style.animationDuration = animDur + 's'; piece.style.animationDelay = Math.random() * 1 + 's'; document.body.appendChild(piece); setTimeout(() => piece.remove(), (animDur + 1.1) * 1000); } }
        
        function loadAudioSettings() { const savedVol = localStorage.getItem('musicVolume'), savedSfx = localStorage.getItem('sfxEnabled'); if (savedVol !== null) gameConfig.musicVolume = parseFloat(savedVol); if (savedSfx !== null) gameConfig.sfxEnabled = savedSfx === 'true'; backgroundMusicAudioEl.volume = gameConfig.musicVolume; bgmVolumeSliderEl.value = gameConfig.musicVolume; sfxToggleBtnEl.textContent = `SFX: ${gameConfig.sfxEnabled ? 'ON' : 'OFF'}`; }
        
        function handleVisibilityChange() {
            if (!audioContextStarted) return;
            if (document.hidden) {
                backgroundMusicAudioEl.pause();
                videoClipPlayerEl.pause();
                fullVideoPlayerEl.pause();
            } else if (gameConfig.musicVolume > 0) {
                backgroundMusicAudioEl.play().catch(e => {});
            }
        }

        function handlePageShow(event) {
            if (event.persisted) {
                console.log("Page restored from bfcache. Re-initializing...");
                setAppHeight(); 
                mainMenu();
            }
        }

        function switchScreen(screenId) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenId].classList.add('active');
            
            const isStartOrGameOver = screenId === 'start' || screenId === 'gameOver';
            homeMenuBtnEl.style.display = isStartOrGameOver ? 'flex' : 'none';
            backBtnEl.style.display = isStartOrGameOver ? 'none' : 'flex';

            if (treatYourselfElement) { treatYourselfElement.style.display = (screenId === 'gameOver') ? 'flex' : 'none'; }
        }

        function openVideoCurtains() { videoCurtainLeftEl.classList.add('open'); videoCurtainRightEl.classList.add('open'); videoClipPlayerEl.classList.add('visible'); playSound(allSfx[5]); }
        function closeVideoCurtains() { videoCurtainLeftEl.classList.remove('open'); videoCurtainRightEl.classList.remove('open'); videoClipPlayerEl.classList.remove('visible'); }

        backBtnEl.addEventListener('click', () => { playSound(allSfx[1]); mainMenu(); });
        settingsBtnEl.addEventListener('click', () => { playSound(allSfx[1]); settingsModalEl.style.display = 'flex'; });
        closeModalBtnEl.addEventListener('click', () => { playSound(allSfx[1]); settingsModalEl.style.display = 'none'; });
        bgmVolumeSliderEl.addEventListener('input', (e) => { gameConfig.musicVolume = parseFloat(e.target.value); backgroundMusicAudioEl.volume = gameConfig.musicVolume; localStorage.setItem('musicVolume', gameConfig.musicVolume); if (gameConfig.musicVolume > 0 && !document.hidden && audioContextStarted) backgroundMusicAudioEl.play().catch(e=>{}); else backgroundMusicAudioEl.pause(); });
        sfxToggleBtnEl.addEventListener('click', () => { gameConfig.sfxEnabled = !gameConfig.sfxEnabled; sfxToggleBtnEl.textContent = `SFX: ${gameConfig.sfxEnabled ? 'ON' : 'OFF'}`; playSound(allSfx[1]); localStorage.setItem('sfxEnabled', gameConfig.sfxEnabled); });
        
        modeOptionsEl.forEach(option => {
            option.addEventListener('click', function() {
                playSound(allSfx[1]);
                modeOptionsEl.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                gameState.gameMode = this.dataset.mode;
                teamInputsContainerEl.style.display = gameState.gameMode === 'multi' ? 'block' : 'none';
                if (gameState.gameMode === 'multi') updateTeamAddRemoveButtons();
            });
        });

        addTeamBtnEl.addEventListener('click', () => {
            playSound(allSfx[1]);
            const teamCount = teamNamesListEl.querySelectorAll('.team-input-wrapper').length;
            if (teamCount < gameConfig.maxTeams) {
                const wrapper = document.createElement('div');
                wrapper.className = 'team-input-wrapper';
                wrapper.innerHTML = `<input type="text" class="team-name-input" placeholder="Team ${teamCount + 1}"><button class="remove-team-btn btn-danger"><i class="fas fa-times"></i></button>`;
                wrapper.querySelector('.remove-team-btn').onclick = function() { playSound(allSfx[1]); this.parentElement.remove(); updateTeamAddRemoveButtons(); };
                teamNamesListEl.appendChild(wrapper);
                updateTeamAddRemoveButtons();
            } else { showFeedbackMessage(`Maximum of ${gameConfig.maxTeams} teams.`, 'info'); }
        });
        
        function updateTeamAddRemoveButtons() {
            const teamWrappers = teamNamesListEl.querySelectorAll('.team-input-wrapper');
            const teamCount = teamWrappers.length;
            addTeamBtnEl.disabled = teamCount >= gameConfig.maxTeams;
            teamWrappers.forEach(wrapper => {
                const removeBtn = wrapper.querySelector('.remove-team-btn');
                if(removeBtn) removeBtn.disabled = teamCount <= gameConfig.minTeams;
            });
        }
        
        startGameBtnEl.addEventListener('click', () => { 
            initAudio(); // Ensure audio context is unlocked on game start
            playSoundWithCallback(allSfx[0], startGame); 
        });

        function startGame() {
            gameState.currentRound = 0;
            gameState.usedClips = [];
            gameState.scores = {};
            if (gameState.gameMode === 'single') {
                gameState.players = ['You'];
            } else {
                gameState.players = Array.from(teamNamesListEl.querySelectorAll('.team-name-input')).map((input, index) => input.value.trim() || `Team ${index + 1}`).filter(name => name !== '');
                if (gameState.players.some(name => name.length > 15)) { showFeedbackMessage("Team names max 15 chars!", "danger"); return; }
                if (new Set(gameState.players.map(p => p.toLowerCase())).size !== gameState.players.length) { showFeedbackMessage("Team names must be unique!", "danger"); return; }
                if (gameState.players.length < gameConfig.minTeams) { showFeedbackMessage(`Multiplayer needs ${gameConfig.minTeams}-${gameConfig.maxTeams} teams!`, 'danger'); return; }
            }
            gameState.players.forEach(player => gameState.scores[player] = 0);
            nextRoundBtnEl.innerHTML = 'Next Round <i class="fas fa-arrow-right"></i>';
            setupRound();
        }

        function setupRound() {
            closeVideoCurtains();
            gameState.currentRound++;
            gameState.singlePlayerChoice = null;
            gameState.roundPlayerChoices = {};
            gameState.currentPlayerIndexInRound = 0;
            let availableClips = gameState.clips.filter(clip => !gameState.usedClips.includes(clip.id));
            if (availableClips.length === 0) { gameState.usedClips = []; availableClips = [...gameState.clips]; }
            gameState.currentClip = availableClips[Math.floor(Math.random() * availableClips.length)];
            gameState.usedClips.push(gameState.currentClip.id);
            roundNumberTextEl.textContent = gameState.currentRound;
            scoreInfoTextEl.style.display = gameState.gameMode === 'single' ? 'block' : 'none';
            turnIndicatorEl.style.display = gameState.gameMode === 'multi' ? 'block' : 'none';
            if (gameState.gameMode === 'single') { currentScoreTextEl.textContent = gameState.scores['You']; }
            else { updateTurnIndicator(); }
            
            videoClipPlayerEl.src = gameState.currentClip.partialUrl;
            videoClipPlayerEl.load();
            videoClipPlayerEl.oncanplay = () => { if(!document.hidden) videoClipPlayerEl.play().catch(e => {}); }

            optionsContainerDisplayEl.innerHTML = '';
            gameState.currentClip.options.forEach((optionText, index) => {
                const optEl = document.createElement('button');
                optEl.className = 'option';
                optEl.innerHTML = `<i class="far fa-circle"></i> <span>${optionText}</span>`;
                optEl.dataset.optionIndex = index;
                optEl.addEventListener('click', () => selectOption(optEl, index));
                optionsContainerDisplayEl.appendChild(optEl);
            });
            revealVideoBtnEl.disabled = true;
            switchScreen('game');
            setTimeout(openVideoCurtains, 500);
        }

        function updateTurnIndicator() {
            if (gameState.gameMode === 'multi' && gameState.players.length > 0) {
                const currentPlayerName = gameState.players[gameState.currentPlayerIndexInRound];
                turnIndicatorEl.textContent = `${currentPlayerName}'s turn to guess:`;
            }
        }

        function selectOption(optionElement, optionIndex) {
            playSound(allSfx[1]);
            const currentPlayerName = gameState.gameMode === 'multi' ? gameState.players[gameState.currentPlayerIndexInRound] : 'You';
            document.querySelectorAll('#options-container-display .option').forEach(opt => {
                const isOwnedByCurrentPlayer = opt.dataset.playerOwner === currentPlayerName;
                if(gameState.gameMode === 'single' || isOwnedByCurrentPlayer) {
                    opt.classList.remove('selected');
                    opt.querySelector('i').className = 'far fa-circle';
                    delete opt.dataset.playerOwner;
                }
            });
            optionElement.classList.add('selected');
            optionElement.querySelector('i').className = 'fas fa-check-circle';
            if(gameState.gameMode === 'multi') { optionElement.dataset.playerOwner = currentPlayerName; }
            else { gameState.singlePlayerChoice = optionIndex; }
            gameState.roundPlayerChoices[currentPlayerName] = optionIndex;
            revealVideoBtnEl.disabled = false;
        }

        revealVideoBtnEl.addEventListener('click', () => {
            playSound(allSfx[2]);
            if (gameState.gameMode === 'multi') {
                const currentPlayerName = gameState.players[gameState.currentPlayerIndexInRound];
                if (gameState.roundPlayerChoices[currentPlayerName] === undefined) { showFeedbackMessage(`${currentPlayerName}, please make a selection.`, 'info'); return; }
                if (gameState.currentPlayerIndexInRound < gameState.players.length - 1) {
                    gameState.currentPlayerIndexInRound++;
                    updateTurnIndicator();
                    revealVideoBtnEl.disabled = true;
                    showFeedbackMessage(`${gameState.players[gameState.currentPlayerIndexInRound]}'s turn!`, 'info', 1500);
                    return;
                }
            }
            processAndRevealFullVideo();
        });

        function processAndRevealFullVideo() {
            videoClipPlayerEl.pause();
            switchScreen('results');
            fullVideoPlayerEl.src = gameState.currentClip.fullUrl;
            fullVideoPlayerEl.load();
            if(!document.hidden) fullVideoPlayerEl.play().catch(e => {});

            let feedbackMsg = "", feedbackType = "info";
            if (gameState.gameMode === 'single') {
                if (gameState.singlePlayerChoice === gameState.currentClip.correctOption) { gameState.scores['You']++; playSound(allSfx[3]); feedbackMsg = "Correct!"; feedbackType = "correct"; }
                else { playSound(allSfx[4]); feedbackMsg = "Incorrect!"; feedbackType = "incorrect"; }
            } else {
                const correctPlayers = gameState.players.filter(p => gameState.roundPlayerChoices[p] === gameState.currentClip.correctOption);
                correctPlayers.forEach(p => gameState.scores[p]++);
                if(correctPlayers.length > 0) { playSound(allSfx[3]); feedbackMsg = "Points Awarded!"; feedbackType = "correct"; }
                else { playSound(allSfx[4]); feedbackMsg = "No one was right!"; feedbackType = "incorrect"; }
            }
            showFeedbackMessage(feedbackMsg, feedbackType, 2500);
            updateScoreDisplayOnResults();
            if (gameState.currentRound >= gameConfig.totalRounds) { nextRoundBtnEl.innerHTML = 'See Final Results <i class="fas fa-trophy"></i>'; }
            else { nextRoundBtnEl.innerHTML = 'Next Round <i class="fas fa-arrow-right"></i>'; }
        }

        function updateScoreDisplayOnResults() {
            scoreDisplayAreaEl.innerHTML = '';
            detailedFeedbackAreaResultsEl.innerHTML = '';
            if (gameState.gameMode === 'single') {
                const isCorrect = gameState.singlePlayerChoice === gameState.currentClip.correctOption;
                const p = document.createElement('p');
                p.innerHTML = `You chose: <strong>"${gameState.currentClip.options[gameState.singlePlayerChoice]}"</strong>. This was ${isCorrect ? '<span style="color:var(--blyza-keppel-accent);">Correct!</span>' : '<span style="color:var(--blyza-quickfire-red);">Incorrect.</span>'}`;
                detailedFeedbackAreaResultsEl.appendChild(p);
            } else {
                gameState.players.forEach(player => {
                    const choice = gameState.roundPlayerChoices[player];
                    const isCorrect = choice === gameState.currentClip.correctOption;
                    const p = document.createElement('p');
                    p.innerHTML = `<strong>${player}</strong> chose: <strong>"${gameState.currentClip.options[choice]}"</strong> - ${isCorrect ? '<span style="color:var(--blyza-keppel-accent);">Correct!</span>' : '<span style="color:var(--blyza-quickfire-red);">Incorrect.</span>'}`;
                    detailedFeedbackAreaResultsEl.appendChild(p);

                    const scoreCard = document.createElement('div');
                    scoreCard.className = 'score-card';
                    scoreCard.innerHTML = `<h4>${player}</h4><div class="score-value">${gameState.scores[player]}</div><div class="progress-bar-multi"><div class="progress-fill-multi" style="width: ${gameState.scores[player] / gameConfig.totalRounds * 100}%"></div></div>`;
                    scoreDisplayAreaEl.appendChild(scoreCard);
                });
            }
            const pCorrect = document.createElement('p');
            pCorrect.innerHTML = `<br>The correct answer was: <strong>"${gameState.currentClip.options[gameState.currentClip.correctOption]}"</strong>`;
            detailedFeedbackAreaResultsEl.appendChild(pCorrect);
        }

        nextRoundBtnEl.addEventListener('click', () => { playSound(allSfx[1]); fullVideoPlayerEl.pause(); if (gameState.currentRound >= gameConfig.totalRounds) { showGameOver(); } else { setupRound(); } });

        function showGameOver() {
            triggerConfetti();
            finalScoresDisplayAreaEl.innerHTML = '';
            if (gameState.gameMode === 'single') {
                const score = gameState.scores['You'];
                winMessageTextEl.textContent = score === gameConfig.totalRounds ? "Perfect Score!" : "Game Complete!";
                finalScoreMessageTextEl.textContent = `You scored ${score} out of ${gameConfig.totalRounds}!`;
            } else {
                let highScore = Math.max(...Object.values(gameState.scores));
                const winners = gameState.players.filter(p => gameState.scores[p] === highScore);
                winMessageTextEl.textContent = winners.length > 1 ? "It's a Tie!" : `${winners[0]} Wins!`;
                finalScoreMessageTextEl.textContent = `Congratulations on scoring ${highScore} points!`;
                gameState.players.sort((a,b) => gameState.scores[b] - gameState.scores[a]).forEach(player => {
                    const scoreCard = document.createElement('div');
                    scoreCard.className = `score-card ${winners.includes(player) ? 'winner-glow' : ''}`;
                    scoreCard.innerHTML = `<h4>${player}</h4><div class="score-value">${gameState.scores[player]}</div>`;
                    finalScoresDisplayAreaEl.appendChild(scoreCard);
                });
            }
            if (!treatYourselfElement) { treatYourselfElement = document.createElement('div'); treatYourselfElement.className = 'treat-yourself-callout'; treatYourselfElement.innerHTML = `<span>Treat Yourself!</span> <i class="fas fa-arrow-down"></i>`; storeButtonWrapperEl.insertBefore(treatYourselfElement, visitStoreBtnEl); }
            switchScreen('gameOver');
        }

        playAgainBtnEl.addEventListener('click', () => { playSoundWithCallback(allSfx[0], startGame);});
        mainMenuBtnEl.addEventListener('click', () => { playSound(allSfx[1]); mainMenu(); });
        visitStoreBtnEl.addEventListener('click', () => { playSound(allSfx[1]); window.location.href = '/store'; });

        function mainMenu() {
            teamNamesListEl.innerHTML = `<div class="team-input-wrapper"><input type="text" class="team-name-input" placeholder="Team 1"></div><div class="team-input-wrapper"><input type="text" class="team-name-input" placeholder="Team 2"></div>`;
            updateTeamAddRemoveButtons();
            if (modeOptionsEl.length > 0) modeOptionsEl[0].click();
            if (treatYourselfElement) treatYourselfElement.style.display = 'none';
            switchScreen('start');
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadAudioSettings();
            
            // ALWAYS show the audio consent modal to ensure context is unlocked
            audioConsentModalEl.style.display = 'flex';

            // Add listeners for visibility and back/forward cache
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('pageshow', handlePageShow);
            
            mainMenu();
        });

        audioConsentYesBtnEl.addEventListener('click', () => {
            audioConsentModalEl.style.display = 'none';
            initAudio(); // This user tap unlocks the audio context
            playSound(allSfx[1]);
        });
        
        audioConsentNoBtnEl.addEventListener('click', () => {
            audioConsentModalEl.style.display = 'none';
            gameConfig.sfxEnabled = false;
            gameConfig.musicVolume = 0;
            backgroundMusicAudioEl.volume = 0;
            bgmVolumeSliderEl.value = 0;
            sfxToggleBtnEl.textContent = 'SFX: OFF';
            localStorage.setItem('sfxEnabled', 'false'); 
            localStorage.setItem('musicVolume', '0'); 
            initAudio(); // Still call this to set the audioContextStarted flag
        });

        // --- CUSTOM SCROLL REDIRECTION LOGIC ---
        const gameContainerForScroll = document.querySelector('.game-container');
        let lastTouchY = 0;

        window.addEventListener('wheel', e => {
            if (document.querySelector('.modal[style*="display: flex"]')) return;
            if (!gameContainerForScroll.contains(e.target)) {
                gameContainerForScroll.scrollTop += e.deltaY;
            }
        }, { passive: true });

        window.addEventListener('touchstart', e => {
            if (document.querySelector('.modal[style*="display: flex"]')) return;
            if (!gameContainerForScroll.contains(e.target)) {
                if (e.touches.length > 0) {
                    lastTouchY = e.touches[0].clientY;
                }
            }
        }, { passive: true });

        window.addEventListener('touchmove', e => {
            if (document.querySelector('.modal[style*="display: flex"]')) return;
            if (!gameContainerForScroll.contains(e.target)) {
                e.preventDefault(); 
                if (e.touches.length > 0) {
                    const currentTouchY = e.touches[0].clientY;
                    const deltaY = lastTouchY - currentTouchY;
                    gameContainerForScroll.scrollTop += deltaY;
                    lastTouchY = currentTouchY;
                }
            }
        }, { passive: false });
        // --- END OF CUSTOM SCROLL LOGIC ---
    </script>
    <script>
      window.va = window.va || function () { (window.va.q = window.va.q || []).push(arguments); };
    </script>
    <script src="/_vercel/insights/script.js" defer></script>

      <script async src="https://www.googletagmanager.com/gtag/js?id=G-N5PBKM0DNQ"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-N5PBKM0DNQ');
</script>

</body>
</html>