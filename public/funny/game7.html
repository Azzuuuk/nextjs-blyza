<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>What Happens Next - Game Show Edition!</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Luckiest+Guy&family=Quicksand:wght@300..700&family=Orbitron:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Base Styles from Guess The Price */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        :root {
            --primary: #FF8833; /* Blyza Orange */
            --secondary: #CB7AE1; /* Blyza Purple */
            --light: #F2F2F2;
            --success: #00BFA6; /* Blyza Keppel */
            --danger: #ff4b2b;
            --dark: #1a1c20;
            --darker: #0f1012;
            --info: #4ECDC4;
            --gold: #FFD700; /* Game show gold */
            --stage-bg: #2c3e50; /* Dark blueish stage background */
            --curtain-color: #c0392b; /* Deep red for curtains */
            --spotlight-color: rgba(255, 223, 0, 0.6); /* Gold spotlight */
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, var(--darker) 100%);
            color: var(--light);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .game-container {
            max-width: 950px;
            width: 100%;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 30px;
            box-shadow:
                0 20px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 1px rgba(255, 255, 255, 0.1);
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Brand Logo Styles */
        .brand-logo {
            object-fit: contain;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
        }
        .brand-logo-prominent {
            display: block;
            margin: 0 auto 20px;
            max-height: 80px; /* GTP Height */
        }

        h1 { /* Main Game Title */
            font-family: "Luckiest Guy", cursive;
            font-size: 3rem; /* GTP Size */
            margin-bottom: 25px;
            color: var(--gold);
            text-shadow:
                0 2px 0px #000,
                0 4px 6px rgba(0, 0, 0, 0.5),
                0 0 30px var(--primary);
            letter-spacing: 1px;
            margin-top: 10px;
        }
        h3 { /* Section titles like "What happens next?" or mode option titles */
            font-family: "Bungee", cursive;
            font-size: 1.6rem;
            margin-top: 25px; /* More space above */
            margin-bottom: 20px;
            color: var(--primary); /* Or gold */
            text-shadow: 0 1px 2px #000;
        }

        /* Screen Styles */
        .screen { display: none; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .active { display: block; }

        /* Instructions Section - GTP Style */
        .instructions {
            font-family: "Quicksand", sans-serif;
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 20px;
            margin: 30px 0;
            line-height: 1.8;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            text-align: left;
        }
        .instructions p { /* "How to Play" title */
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--light);
            font-family: "Bungee", cursive;
        }
        .instructions ul { list-style-type: none; padding-left: 0; }
        .instructions li {
            margin-bottom: 12px; display: flex; align-items: center;
            color: var(--light); font-size: 1rem;
        }
        .instructions i {
            margin-right: 15px; font-size: 1.4em; color: var(--primary);
            width: 20px; text-align: center;
        }

        /* Game Mode & Team Setup - GTP Style */
        .game-mode-selection {
            display: flex; justify-content: center; gap: 30px; margin: 30px 0;
        }
        .mode-option {
            background: rgba(255, 255, 255, 0.05); padding: 25px; border-radius: 20px;
            cursor: pointer; transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.1); flex: 1; max-width: 300px;
        }
        .mode-option:hover {
            transform: translateY(-5px) scale(1.05); background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2), 0 0 15px var(--secondary);
            border-color: var(--secondary);
        }
        .mode-option.selected {
            border: 2px solid var(--primary); background: rgba(255, 136, 51, 0.15);
            box-shadow: 0 0 25px rgba(255, 136, 51, 0.3), inset 0 0 15px rgba(255, 136, 51, 0.15);
            transform: scale(1.02);
        }
        .mode-option i { font-size: 2.5rem; margin-bottom: 15px; color: var(--primary); }
        .mode-option h3 { /* Title within mode option */
            margin-bottom: 10px; font-size: 1.4rem; color: var(--light);
            font-family: "Bungee", cursive; text-shadow: 0 1px 2px #000;
        }
        .mode-option p { color: rgba(242, 242, 242, 0.7); font-size: 1.1rem; margin:0;}

        .team-inputs { /* Container for team name fields */
            margin: 30px 0; background: rgba(255, 255, 255, 0.05); padding: 30px;
            border-radius: 20px; border: 1px solid rgba(255,255,255,0.1);
        }
         .team-inputs h3 { /* "Enter Team Names" */
            font-family: "Bungee", cursive; font-size: 1.6rem; margin-bottom: 20px;
            color: var(--primary); text-shadow: 0 1px 2px #000;
        }
        .team-input-wrapper {
            display: flex; align-items: center; gap: 10px; margin-bottom: 15px;
        }
        .team-input-wrapper input {
            flex-grow: 1; padding: 15px 20px; border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1); font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.05); color: var(--light);
            transition: all 0.3s ease; font-family: 'Quicksand', sans-serif;
        }
        .team-input-wrapper input:focus {
            outline: none; border-color: var(--secondary);
            box-shadow: 0 0 10px rgba(203, 122, 225, 0.2);
        }
        .remove-team-btn { /* Inherits general button, specific overrides */
            padding: 8px 12px !important; font-size: 0.9rem !important; min-width: auto;
        }
        .remove-team-btn i { margin: 0; }
        #add-team-btn { /* Specific button for adding teams */
             padding: 10px 20px !important; font-size: 0.9rem !important;
        }


        /* Video Display with TV & Curtains - GTP Style */
        .video-stage-container { /* New outer container for stage elements */
            background: var(--stage-bg);
            padding: 20px;
            border-radius: 20px;
            margin: 25px auto;
            max-width: 700px; /* Control overall width of stage area */
            border: 3px solid var(--gold);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 0 15px rgba(0,0,0,0.3);
            position: relative;
            overflow: hidden; /* For spotlights and curtains */
        }
        .video-stage-container::before, .video-stage-container::after { /* Spotlights */
            content: ''; position: absolute; top: -50px; width: 200px; height: 300px;
            background: radial-gradient(ellipse at center, var(--spotlight-color) 0%, transparent 70%);
            pointer-events: none; opacity: 0.7; z-index: 0;
        }
        .video-stage-container::before { left: -50px; transform: rotate(-30deg); }
        .video-stage-container::after { right: -50px; transform: rotate(30deg); }

        .tv-screen-wrapper { /* This will be the "TV" holding the video and curtains */
            background: #111; /* TV Screen BG */
            border: 10px solid #333; /* TV Border */
            border-radius: 15px;
            padding: 10px; /* Padding inside TV border before video/curtains */
            box-shadow: 0 0 20px rgba(0,0,0,0.7), inset 0 0 10px rgba(0,0,0,0.5);
            position: relative; /* For curtains */
            z-index: 1;
            overflow: hidden; /* Crucial for curtains */
            width: 100%; /* Take width of parent */
            aspect-ratio: 16 / 9; /* Maintain aspect ratio for video player */
            margin: 0 auto; /* Center the TV if stage is wider */
        }
        .stage-curtains {
            position: absolute; top: 0; width: 50%; height: 100%;
            background-color: var(--curtain-color);
            background-image: linear-gradient(rgba(0,0,0,0.2) 50%, transparent 50%),
                              linear-gradient(90deg, rgba(0,0,0,0.2) 50%, transparent 50%);
            background-size: 50px 50px;
            box-shadow: 5px 0 15px rgba(0,0,0,0.5);
            transition: transform 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 5; /* Above video initially */
        }
        .stage-curtains.left { left: 0; border-right: 3px solid #a52a20; }
        .stage-curtains.right { right: 0; border-left: 3px solid #a52a20; }
        .stage-curtains.open.left { transform: translateX(-100%); }
        .stage-curtains.open.right { transform: translateX(100%); }

        video { /* The video element itself */
            width: 100%; height: 100%; /* Fill the tv-screen-wrapper */
            display: block;
            object-fit: cover; /* Or contain, depending on desired video scaling */
            border-radius: 5px; /* Slight rounding if TV padding is small */
            opacity: 0; /* Hidden until curtains open */
            transition: opacity 0.5s ease-in 0.7s; /* Fade in after curtains start opening */
        }
        video.visible { opacity: 1; }

        /* Options Styling - GTP Style Buttons */
        .options-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Wider options */
            gap: 15px;
            margin: 25px 0;
        }
        .option { /* Will now use button styling, specific overrides needed */
            /* This will inherit from general button styling */
            background: linear-gradient(135deg, rgba(var(--secondary-rgb, 203,122,225),0.6) 0%, rgba(var(--secondary-rgb, 203,122,225),0.4) 100%);
            border: 2px solid rgba(var(--secondary-rgb, 203,122,225),0.8);
            font-family: "Quicksand", sans-serif; /* Options use Quicksand */
            font-weight: 600;
            text-shadow: none; /* Remove Bungee text shadow */
            text-align: left; /* Align icon and text */
            justify-content: flex-start; /* Align icon and text to start */
        }
        .option i { margin-right: 10px; font-size: 1.2em; }
        .option:hover:not(:disabled):not(.selected):not(.correct):not(.incorrect) {
            background: linear-gradient(135deg, var(--secondary) 0%, #b85cd6 100%);
            border-color: var(--secondary);
        }
        .option.selected {
            border-color: var(--primary) !important; /* Ensure override */
            background: linear-gradient(135deg, var(--primary) 0%, #ff7711 100%) !important;
            box-shadow: 0 0 15px var(--primary), inset 0 -2px 5px rgba(0,0,0,0.2);
        }
        .option.correct {
            background: linear-gradient(135deg, var(--success) 0%, #00a890 100%) !important;
            border-color: var(--success) !important;
        }
        .option.incorrect {
            background: linear-gradient(135deg, var(--danger) 0%, #ff416c 100%) !important;
            border-color: var(--danger) !important;
            opacity: 0.7; /* Keep opacity for visual cue */
        }
        .option.disabled-option { opacity: 0.6; pointer-events: none; }


        /* Game Info (Score/Round Top Bar) - GTP Style */
        .game-info {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; background: rgba(0, 0, 0, 0.2);
            padding: 15px 20px; border-radius: 10px; font-size: 1.1rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-family: "Orbitron", sans-serif; color: var(--gold);
        }
        .game-info span { text-shadow: 0 0 5px var(--primary); }
        #turn-indicator { /* For multiplayer turn, styled prominently */
            font-family: "Bungee", cursive; color: var(--gold);
            margin: 15px 0 10px 0; font-size: 1.3rem; text-shadow: 0 1px 2px #000;
        }

        /* Score Display (for multiplayer on results/game over) - GTP Style */
        .score-display-multi {
            display: grid; gap: 20px; margin: 30px 0;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Wider score cards */
        }
        .score-card-multi {
            background: rgba(0,0,0, 0.3); padding: 20px; border-radius: 15px;
            border: 2px solid var(--gold); transition: all 0.3s ease;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3); text-align: center;
        }
         .score-card-multi h4 { /* Team Name on score card */
            font-family: "Bungee", cursive; font-size: 1.2rem; margin-bottom: 10px;
            color: var(--primary); text-shadow: 0 1px 1px #000;
         }
         .score-card-multi .score-value { /* Actual score value */
            font-family: "Orbitron", sans-serif; font-size: 2.2rem;
            color: var(--light); text-shadow: 0 0 8px var(--gold);
         }
        .progress-bar-multi { /* Progress bar within score card */
            height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px;
            margin-top: 15px; overflow: hidden; border: 1px solid rgba(255,255,255,0.2);
        }
        .progress-fill-multi {
            height: 100%; background: linear-gradient(90deg, var(--primary) 0%, var(--gold) 100%);
            border-radius: 3.5px; transition: width 0.5s ease; box-shadow: 0 0 8px var(--primary);
        }
        .score-card-multi.winner-glow { /* Applied to winning team's score card */
            animation: winnerGlow 1.5s infinite alternate;
            border: 2px solid var(--success);
        }
        @keyframes winnerGlow { /* Match GTP winner glow */
            from { box-shadow: 0 0 20px rgba(0, 191, 166, 0.3), 0 0 10px var(--gold); }
            to { box-shadow: 0 0 35px rgba(0, 191, 166, 0.6), 0 0 20px var(--gold); }
        }


        /* Game Over Screen - GTP Style */
        .win-message {
            font-size: 3rem; margin: 30px 0; color: var(--gold);
            text-shadow: 0 3px 0px #000, 0 0 20px var(--primary);
            font-family: "Luckiest Guy", cursive;
        }
        .winner-trophy {
            font-size: 6rem; margin: 20px 0 30px 0;
            animation: bounce 1.5s infinite ease-in-out; color: var(--gold);
            text-shadow: 0 0 20px var(--gold), 0 0 30px var(--primary);
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-35px) scale(1.1); }
        }
        #final-score-message-text {
            font-size: 1.2rem; margin-bottom: 25px;
            color: var(--light); font-style: italic;
        }
        /* Game Over Buttons & Treat Yourself - GTP Style */
        .game-over-buttons-container {
            display: flex; justify-content: center; align-items: flex-start;
            flex-wrap: wrap; gap: 10px; margin-top: 20px;
        }
        .game-over-button-wrapper {
            position: relative; display: flex; flex-direction: column; align-items: center;
        }
        .treat-yourself-callout {
            margin-bottom: 8px; background-color: var(--gold); color: var(--darker);
            padding: 8px 15px; border-radius: 20px; font-family: "Bungee", cursive;
            font-size: 0.9rem; white-space: nowrap; box-shadow: 0 2px 10px rgba(255,215,0,0.5);
            display: none; align-items: center; gap: 8px; z-index: 10;
        }
        .treat-yourself-callout i { font-size: 1.2em; animation: bounceArrow 1s infinite; }
        @keyframes bounceArrow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }

        /* Buttons - GTP Style */
        button {
            background: linear-gradient(135deg, var(--primary) 0%, #ff7711 100%);
            color: var(--light); border: 2px solid var(--darker); padding: 15px 25px;
            font-size: 1rem; border-radius: 50px; cursor: pointer;
            font-weight: normal; /* Bungee is bold */ transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3), inset 0 -2px 5px rgba(0,0,0,0.2);
            margin: 10px 5px; font-family: "Bungee", cursive; text-shadow: 1px 1px 2px #000;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            flex-shrink: 0;
        }
        button:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0,0,0,0.4), inset 0 -2px 5px rgba(0,0,0,0.2), 0 0 10px var(--primary);
            background: linear-gradient(135deg, #ff7711 0%, var(--primary) 100%);
        }
        button:active:not(:disabled) { transform: translateY(-1px) scale(1.02); }
        button:disabled {
            background: rgba(255, 255, 255, 0.1); cursor: not-allowed; opacity: 0.6;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); transform: none; border-color: rgba(0,0,0,0.5);
        }
        .btn-primary {} /* Default */
        .btn-success { background: linear-gradient(135deg, var(--success) 0%, #00a890 100%); }
        .btn-success:hover:not(:disabled) { box-shadow: 0 8px 25px rgba(0,0,0,0.4), inset 0 -2px 5px rgba(0,0,0,0.2), 0 0 10px var(--success); }
        .btn-secondary { background: linear-gradient(135deg, var(--secondary) 0%, #b85cd6 100%); }
        .btn-secondary:hover:not(:disabled) { box-shadow: 0 8px 25px rgba(0,0,0,0.4), inset 0 -2px 5px rgba(0,0,0,0.2), 0 0 10px var(--secondary); }
        .btn-info { background: linear-gradient(135deg, var(--info) 0%, #3eb7af 100%); }
        .btn-info:hover:not(:disabled) { box-shadow: 0 8px 25px rgba(0,0,0,0.4), inset 0 -2px 5px rgba(0,0,0,0.2), 0 0 10px var(--info); }

        /* Settings Icon Button - GTP Style */
        .icon-btn {
            position: absolute; background: rgba(0,0,0, 0.3); color: var(--light);
            border: 1px solid var(--gold); border-radius: 50%; width: 40px; height: 40px;
            font-size: 1.1rem; cursor: pointer; transition: all 0.3s ease;
            display: flex; justify-content: center; align-items: center; z-index: 100;
            padding: 0; margin: 0; box-shadow: none; text-shadow: none;
        }
        .icon-btn#settings-btn { top: 15px; right: 15px; }
        .icon-btn:hover {
            background: rgba(0,0,0, 0.5); transform: scale(1.1) rotate(15deg);
            box-shadow: 0 0 10px var(--gold);
        }
        .icon-btn i { margin: 0; }

        /* Modal Styles - GTP Style */
        .modal {
            position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
            display: none; justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: var(--darker); margin: auto; padding: 30px;
            border: 2px solid var(--gold); border-radius: 15px; width: 80%; max-width: 450px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6), 0 0 20px var(--primary);
            position: relative; color: var(--light);
        }
        .modal-content h2 {
            font-family: "Bungee", cursive; color: var(--primary); text-align: center;
            margin-bottom: 25px; font-size: 1.8rem;
        }
        .setting-item { margin-bottom: 20px; display: flex; flex-direction: column; }
        .setting-item label { margin-bottom: 8px; font-weight: 600; font-size: 0.9rem;}
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
          -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%;
          background: var(--primary); cursor: pointer; margin-top: -7px;
          box-shadow: 0 0 8px var(--primary);
        }
        input[type=range]::-moz-range-thumb {
          height: 20px; width: 20px; border-radius: 50%; background: var(--primary);
          cursor: pointer; border: none; box-shadow: 0 0 8px var(--primary);
        }
        input[type=range]::-webkit-slider-runnable-track {
          width: 100%; height: 6px; cursor: pointer; background: rgba(255,255,255,0.2);
          border-radius: 3px; border: 1px solid rgba(0,0,0,0.2);
        }
        input[type=range]::-moz-range-track {
          width: 100%; height: 6px; cursor: pointer; background: rgba(255,255,255,0.2);
          border-radius: 3px; border: 1px solid rgba(0,0,0,0.2);
        }
        .close-modal-btn {
            color: #aaa; position: absolute; top: 15px; right: 20px;
            font-size: 28px; font-weight: bold; cursor: pointer;
        }
        .close-modal-btn:hover, .close-modal-btn:focus { color: var(--light); text-decoration: none; }

        /* Feedback Pop-up - GTP Style */
        .feedback-popup {
            position: fixed; top: 50%; left: 50%; background-color: rgba(15, 16, 18, 0.97);
            color: white; padding: 30px 50px; border-radius: 20px; font-size: 2.8rem;
            font-family: "Luckiest Guy", cursive; text-align: center;
            z-index: 2000; box-shadow: 0 15px 40px rgba(0,0,0,0.7);
            opacity: 0; transform: translate(-50%, -50%) scale(0.7);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            pointer-events: none; border: 3px solid var(--gold); display: none;
        }
        .feedback-popup.show { opacity: 1; transform: translate(-50%, -50%) scale(1); pointer-events: auto; display: block; }
        .feedback-popup.correct { color: var(--success); border-color: var(--success); text-shadow: 0 0 15px var(--success); }
        .feedback-popup.incorrect { color: var(--danger); border-color: var(--danger); text-shadow: 0 0 15px var(--danger); }
        .feedback-popup.info { color: var(--info); border-color: var(--info); text-shadow: 0 0 15px var(--info); }

        /* Confetti Styles */
        .confetti-piece {
            position: fixed; width: 10px; height: 20px; background-color: var(--primary);
            opacity: 0; animation-timing-function: linear; animation-fill-mode: forwards;
            pointer-events: none; z-index: 3000;
        }
        @keyframes fallAndFade {
            0% { transform: translateY(-20vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(120vh) rotate(720deg); opacity: 0; }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .game-container { padding: 20px; }
            h1 { font-size: 2.5rem; }
            h3 { font-size: 1.4rem; }
            .game-mode-selection { flex-direction: column; align-items: center; gap: 15px;}
            .mode-option { max-width: 90%; }
            .options-container { grid-template-columns: 1fr; gap: 12px;}
            .option { font-size: 0.9rem; padding: 12px 18px;}
            .game-info { flex-direction: column; gap: 8px; font-size: 1rem; padding: 12px;}
            .score-card-multi, .score-display .score-card { max-width: 90%; }
            .win-message { font-size: 2.2rem; }
            .winner-trophy { font-size: 5rem; }
            .feedback-popup { font-size: 2rem; padding: 25px 35px; width: 90%;}
            .modal-content { padding: 20px; }
            .game-over-buttons-container { flex-direction: column; align-items: center;}
            .game-over-buttons-container .game-over-button-wrapper { width: 90%; margin: 5px auto;}
            .game-over-buttons-container .game-over-button-wrapper button { width: 100%;}
            .video-stage-container::before, .video-stage-container::after { display: none; } /* Hide spotlights */
        }
        @media (max-width: 480px) {
            h1 { font-size: 2rem; }
            .instructions li { font-size: 0.9rem; }
            button { padding: 12px 20px; font-size: 0.9rem; }
            .video-stage-container { padding: 15px; }
            .tv-screen-wrapper { border-width: 5px; padding: 5px; }
            .icon-btn { top: 10px; right: 10px; width: 35px; height: 35px; font-size: 1rem; }
            .team-input-wrapper input { padding: 12px 15px; font-size: 1rem;}
            .remove-team-btn { padding: 7px 10px !important; font-size: 0.8rem !important;}
        }
    </style>
</head>
<body>
    <div class="game-container">
        <img id="corner-logo-static" class="brand-logo" src="https://static.wixstatic.com/shapes/9ce3e5_4f0149a89dd841859da02f59247b5b6b.svg" alt="Blyza Mascot" style="position: absolute; top: 20px; left: 20px; max-height: 40px; opacity: 0.7; display: none;">
        <button id="settings-btn" class="icon-btn" aria-label="Open Settings">
            <i class="fas fa-cog"></i>
        </button>

        <!-- Start Screen -->
        <div id="start-screen" class="screen active">
            <img class="brand-logo brand-logo-prominent" src="https://static.wixstatic.com/shapes/9ce3e5_4f0149a89dd841859da02f59247b5b6b.svg" alt="Blyza Mascot">
            <h1>What Happens Next?</h1>
            <div class="instructions">
                <p>HOW TO PLAY:</p>
                <ul>
                    <li><i class="fas fa-video"></i> Watch the first part of a video clip.</li>
                    <li><i class="fas fa-question-circle"></i> Guess what happens next from the 3 options provided.</li>
                    <li><i class="fas fa-eye"></i> Click "Reveal Video" to see the full clip and find out if you're right!</li>
                    <li><i class="fas fa-users"></i> Play solo or with up to 4 teams!</li>
                    <li><i class="fas fa-star"></i> Score 1 point for each correct guess. The game lasts for 5 rounds.</li>
                </ul>
            </div>
            <div class="game-mode-selection">
                <div class="mode-option selected" data-mode="single">
                    <i class="fas fa-user"></i>
                    <h3>Single Player</h3>
                    <p>Play 5 rounds alone</p>
                </div>
                <div class="mode-option" data-mode="multi">
                    <i class="fas fa-users"></i>
                    <h3>Multiplayer</h3>
                    <p>Up to 4 teams</p>
                </div>
            </div>
            <div id="team-inputs-container" style="display: none;">
                <div class="team-inputs">
                    <h3>Enter Team Names</h3>
                    <div id="team-names-list">
                        <div class="team-input-wrapper"><input type="text" class="team-name-input" placeholder="Team 1"><button class="remove-team-btn" disabled><i class="fas fa-times"></i></button></div>
                        <div class="team-input-wrapper"><input type="text" class="team-name-input" placeholder="Team 2"><button class="remove-team-btn" disabled><i class="fas fa-times"></i></button></div>
                    </div>
                    <button id="add-team-btn" class="btn-secondary"><i class="fas fa-plus"></i> Add Team</button>
                </div>
            </div>
            <button id="start-game-btn" class="btn-primary">Start Game <i class="fas fa-play"></i></button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div class="game-info">
                <div id="round-info-text">Round <span id="round-number-text">1</span>/5</div>
                <div id="score-info-text" style="display:none;">Score: <span id="current-score-text">0</span></div>
            </div>
            <div id="turn-indicator" style="display: none;"></div> <!-- Styled with CSS -->

            <div class="video-stage-container">
                <div class="tv-screen-wrapper">
                    <div class="stage-curtains left" id="video-curtain-left"></div>
                    <div class="stage-curtains right" id="video-curtain-right"></div>
                    <video id="video-clip-player" controlsList="nodownload" controls>
                        Your browser does not support the video tag.
                    </video>
                </div>
            </div>

            <h3>What happens next?</h3>
            <div id="options-container-display" class="options-container"></div>
            <button id="reveal-video-btn" class="btn-primary" disabled>Reveal Full Video <i class="fas fa-eye"></i></button>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="screen">
            <h1>Round Result</h1>
            <div class="video-stage-container"> <!-- Re-use stage for full video -->
                 <div class="tv-screen-wrapper">
                    <!-- Curtains not strictly needed here, but wrapper can be kept for consistency -->
                    <video id="full-video-player" controlsList="nodownload" controls style="opacity:1;"> <!-- Full video always visible here -->
                        Your browser does not support the video tag.
                    </video>
                 </div>
            </div>
            <div id="detailed-feedback-area-results" style="margin-top: 20px; font-size: 1.1rem; line-height:1.7;">
            </div>
            <div id="score-display-area" class="score-display-multi">
            </div>
            <button id="next-round-btn" class="btn-primary">Next Round <i class="fas fa-arrow-right"></i></button>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="screen">
            <img class="brand-logo brand-logo-prominent" src="https://static.wixstatic.com/shapes/9ce3e5_4f0149a89dd841859da02f59247b5b6b.svg" alt="Blyza Mascot">
            <h1>Game Over!</h1>
            <div class="win-message" id="win-message-text">Game Complete!</div>
            <div class="winner-trophy">üèÜ</div>
            <div id="final-score-message-text">Your final score is...</div>
            <div id="final-scores-display-area" class="score-display-multi" style="margin-bottom:30px;">
            </div>
            <div class="game-over-buttons-container">
                <div class="game-over-button-wrapper">
                    <button id="play-again-btn" class="btn-success"><i class="fas fa-redo"></i> Play Again</button>
                </div>
                <div class="game-over-button-wrapper">
                    <button id="main-menu-btn" class="btn-secondary"><i class="fas fa-home"></i> Main Menu</button>
                </div>
                <div class="game-over-button-wrapper" id="store-button-wrapper">
                    <!-- "Treat Yourself" callout will be inserted here by JS -->
                    <button id="visit-store-btn" class="btn-info"><i class="fas fa-store"></i> Visit Store</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span id="close-modal-btn" class="close-modal-btn">√ó</span>
            <h2>Settings</h2>
            <div class="setting-item">
                <label for="bgm-volume-slider">Background Music Volume:</label>
                <input type="range" id="bgm-volume-slider" min="0" max="1" step="0.01" value="0.2">
            </div>
            <div class="setting-item">
                <label for="sfx-toggle-btn">Sound Effects:</label>
                <button id="sfx-toggle-btn" class="btn-secondary">SFX: ON</button>
            </div>
        </div>
    </div>

    <!-- Feedback Pop-up -->
    <div id="feedback-popup" class="feedback-popup"> <!-- display:none handled by .show -->
        <span id="feedback-message-text-el"></span>
    </div>

    <!-- Audio elements -->
    <audio id="background-game-music" loop src="https://static.wixstatic.com/mp3/9ce3e5_380adfaea802407b9a4cebc67f12a216.mp3"></audio>
    <audio id="start-game-sound" src="https://static.wixstatic.com/mp3/9ce3e5_1b9151238aec4e29ab14f1526e9c1334.mp3"></audio>
    <audio id="interaction-sound" src="https://static.wixstatic.com/mp3/9ce3e5_fc326aa1760c485dbac083ec55c2bfcb.wav"></audio>
    <audio id="video-reveal-sound" src="https://static.wixstatic.com/mp3/9ce3e5_fc326aa1760c485dbac083ec55c2bfcb.wav"></audio>
    <audio id="correct-answer-sound" src="https://static.wixstatic.com/mp3/9ce3e5_76691a6fefcd4536aa403ada111e886a.mp3"></audio>
    <audio id="wrong-answer-sound" src="https://static.wixstatic.com/mp3/9ce3e5_277f814439064d1bbe5c0342241b23e4.mp3"></audio>
    <audio id="curtain-sound" src="https://static.wixstatic.com/mp3/9ce3e5_ccd36cdf98bf4e1594cf2e52d5296c51.wav"></audio>
    <audio id="confetti-sound" src="https://static.wixstatic.com/mp3/9ce3e5_5d7fcfc389734cf7994f5d37de621e3d.mp3"></audio>

       <script>
        const gameConfig = {
            totalRounds: 5,
            sfxEnabled: true,
            musicVolume: 0.2,
            minTeams: 2,
            maxTeams: 4
        };

        const gameState = {
            gameMode: 'single',
            players: [],
            scores: {},
            currentRound: 0,
            currentPlayerIndexInRound: 0,
            roundPlayerChoices: {},
            singlePlayerChoice: null,
            currentClip: null,
            clips: [ /* Ensure your clips are here */
                 { id: 1, partialUrl: "https://video.wixstatic.com/video/9ce3e5_84548f28d45d4b03b449d0cbd97b590d/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_b76bd68b8d27495f86dcf3e4b70bac4a/1080p/mp4/file.mp4", options: ["A lightning strike hits the car", "A tire launches the car in the air", "Car skids on to the other side of the road"], correctOption: 1 },
                 { id: 2, partialUrl: "https://video.wixstatic.com/video/9ce3e5_d23402cffe424530af1963fef8f81aa6/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_0d20c45eb31545efa62b6f7fb41bb0c3/1080p/mp4/file.mp4", options: ["Horse bites off riders shirt", "Rider sucker punches the horse back ", "Horse runs the race without the rider"], correctOption: 2 },
                 { id: 3, partialUrl: "https://video.wixstatic.com/video/9ce3e5_8e3cc14bc48e4615b1efc3b2fbc8214c/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_af370e640de747209137a52d9b5f7962/1080p/mp4/file.mp4", options: ["Man does a double backflip", "Man nearly dodges the supercar", "Man jumps over the supercar"], correctOption: 2 },
                 { id: 4, partialUrl: "https://video.wixstatic.com/video/9ce3e5_6981fbbc61754965bbafbee9a25b7555/720p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_577a1af924ef4f3db6f38fda862d6083/720p/mp4/file.mp4", options: ["Surfer bumbs into a pole in the ocean", "Surfer catches the beer can and celebrates in style", "A dolphin comes up and pushes the surfer off the board"], correctOption: 0 },
                 { id: 5, partialUrl: "https://video.wixstatic.com/video/9ce3e5_e1280576aa434e1da4d3a46489215d1e/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_da774a9ca6ba4b619d3062a2a53eec60/1080p/mp4/file.mp4", options: ["Another dog pops up and bumbs into the race dog", "Dog stops mid course to take a poo", "Dog jumps on the owner to play instead of racing"], correctOption: 1 },
                 { id: 6, partialUrl: "https://video.wixstatic.com/video/9ce3e5_b82959bb98534f1c82926f9a75f64e0f/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_1baeb8ad1b9c4909a71fc04883e3c41a/1080p/mp4/file.mp4", options: ["The squirrel bites the mans hand", "The squirrel poops on the mans hand", "The squirrel gets eaten by a cat"], correctOption: 2 },
                 { id: 7, partialUrl: "https://video.wixstatic.com/video/9ce3e5_9f5bd13b46a446e7974ed69fb768c20e/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_5065e8f288214d5ca99d7bf0e3c9a329/1080p/mp4/file.mp4", options: ["A man falls throuhg the ceiling.", "A monkey recieves the order.", "Delivery driver gets blasted with flour"], correctOption: 1 },
                 { id: 8, partialUrl: "https://video.wixstatic.com/video/9ce3e5_4fe5dac5708c4fc495de2c9c9d1f75e4/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_45f5bbbe9e0744ac994857b1689f615c/1080p/mp4/file.mp4", options: ["A snake walks in to the room.", "Her dad walks in to the room.", "She slips and breaks the table."], correctOption: 0 },
                 { id: 9, partialUrl: "https://video.wixstatic.com/video/9ce3e5_facc1b5721714355abd0108dfc0c3450/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_d975afb8db7046a6a512b4f582b79ca3/1080p/mp4/file.mp4", options: ["Man pulls the table instead.", "Man pulls the table cloth perfectly.", "Man slips on to the table and breaks everything."], correctOption: 0 },
                 { id: 10, partialUrl: "https://video.wixstatic.com/video/9ce3e5_97e28c78becf449292d14377bec69088/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_e01ab74af57d4974b12b89c495f2365b/1080p/mp4/file.mp4", options: ["An eagle snatches his shade off", "Man gets snow ball thrown on his face", "Man ski's off house roof."], correctOption: 2 },
                 { id: 11, partialUrl: "https://video.wixstatic.com/video/9ce3e5_6f0d0e5fdd524178a8a8663f30e89a9c/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_125946bb472844218b22c15db192fe51/1080p/mp4/file.mp4", options: ["One of the singer starts to throw up.", "A girl starts throwing eggs at the judges.", "Camera pans to auidence member eating his booger."], correctOption: 1 },
                 { id: 12, partialUrl: "https://video.wixstatic.com/video/9ce3e5_17db7648471c4556b0a371d830a7c0a4/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_238a9a9a22a04e3db56c726c8a127257/1080p/mp4/file.mp4", options: ["Man faints at the finish line.", "His daughter runs into the track.", "Man breaks his leg"], correctOption: 2 },
                 { id: 13, partialUrl: "https://video.wixstatic.com/video/9ce3e5_d318cfdb4b4c4b2ab0cc390d21b6ff7c/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_3c01170407b447b58cb618381818c05e/1080p/mp4/file.mp4", options: ["Seasaw breaks in half.", "Man gets hit in the head with the seasaw.", "Both men fall into the pond."], correctOption: 1 },
                 { id: 14, partialUrl: "https://video.wixstatic.com/video/9ce3e5_13ebb4cbdfe34e2cbaf8c938d128f0c0/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_5cb32c3f0cd646a9acbf347ce3de8928/1080p/mp4/file.mp4", options: ["Man kicks ball to girls face.", "Both joggers trip and fall on the ball.", "Cat takes the ball away."], correctOption: 0 },
                 { id: 15, partialUrl: "https://video.wixstatic.com/video/9ce3e5_5d98adfed19f4f53ba7100406625c1ba/1080p/mp4/file.mp4", fullUrl: "https://video.wixstatic.com/video/9ce3e5_a6c7f0ae43224b6e8bc83c6459913c01/1080p/mp4/file.mp4", options: ["Man falls face first onto the road.", "The puddle is deeper than he thought.", "The splash from the puddle drenches the camera man."], correctOption: 1 }
            ],
            usedClips: []
        };

        // DOM elements
        const screens = {
            start: document.getElementById('start-screen'),
            game: document.getElementById('game-screen'),
            results: document.getElementById('results-screen'),
            gameOver: document.getElementById('game-over-screen')
        };
        const cornerLogoEl = document.getElementById('corner-logo-static');
        const modeOptionsEl = document.querySelectorAll('.mode-option');
        const teamInputsContainerEl = document.getElementById('team-inputs-container');
        const teamNamesListEl = document.getElementById('team-names-list');
        const addTeamBtnEl = document.getElementById('add-team-btn');
        const startGameBtnEl = document.getElementById('start-game-btn');

        const roundInfoTextEl = document.getElementById('round-info-text');
        const scoreInfoTextEl = document.getElementById('score-info-text');
        const turnIndicatorEl = document.getElementById('turn-indicator');
        const roundNumberTextEl = document.getElementById('round-number-text');
        const currentScoreTextEl = document.getElementById('current-score-text');

        const videoCurtainLeftEl = document.getElementById('video-curtain-left');
        const videoCurtainRightEl = document.getElementById('video-curtain-right');
        const videoClipPlayerEl = document.getElementById('video-clip-player');
        const optionsContainerDisplayEl = document.getElementById('options-container-display');
        const revealVideoBtnEl = document.getElementById('reveal-video-btn');

        const fullVideoPlayerEl = document.getElementById('full-video-player');
        const detailedFeedbackAreaResultsEl = document.getElementById('detailed-feedback-area-results');
        const scoreDisplayAreaEl = document.getElementById('score-display-area');
        const nextRoundBtnEl = document.getElementById('next-round-btn');

        const winMessageTextEl = document.getElementById('win-message-text');
        const finalScoreMessageTextEl = document.getElementById('final-score-message-text');
        const finalScoresDisplayAreaEl = document.getElementById('final-scores-display-area');
        const storeButtonWrapperEl = document.getElementById("store-button-wrapper");
        let treatYourselfElement = null;
        const playAgainBtnEl = document.getElementById('play-again-btn');
        const mainMenuBtnEl = document.getElementById('main-menu-btn');
        const visitStoreBtnEl = document.getElementById('visit-store-btn');

        const settingsBtnEl = document.getElementById('settings-btn');
        const settingsModalEl = document.getElementById('settings-modal');
        const closeModalBtnEl = document.getElementById('close-modal-btn');
        const bgmVolumeSliderEl = document.getElementById('bgm-volume-slider');
        const sfxToggleBtnEl = document.getElementById('sfx-toggle-btn');

        const backgroundMusicAudioEl = document.getElementById('background-game-music');
        const startGameSoundAudioEl = document.getElementById('start-game-sound');
        const interactionSoundAudioEl = document.getElementById('interaction-sound');
        const videoRevealSoundAudioEl = document.getElementById('video-reveal-sound');
        const correctAnswerSoundAudioEl = document.getElementById('correct-answer-sound');
        const wrongAnswerSoundAudioEl = document.getElementById('wrong-answer-sound');
        const curtainSoundAudioEl = document.getElementById('curtain-sound');
        const confettiSoundAudioEl = document.getElementById('confetti-sound');

        const feedbackPopupEl = document.getElementById('feedback-popup');
        const feedbackMessageTextPopupEl = document.getElementById('feedback-message-text-el');
        let feedbackTimeoutId;


        // --- Sound & UI Functions ---
        function playSound(audioElement) {
            if (gameConfig.sfxEnabled && audioElement) {
                audioElement.currentTime = 0;
                audioElement.volume = 0.7;
                audioElement.play().catch(e => console.error("SFX play error:", e));
            }
        }
        function playSoundWithCallback(audioElement, callback, ...args) {
            if (gameConfig.sfxEnabled && audioElement) {
                audioElement.currentTime = 0;
                audioElement.volume = 0.7;
                let cbExecuted = false;
                const execCb = () => { if (!cbExecuted) { cbExecuted = true; audioElement.removeEventListener('ended', execCb); if(typeof soundTimeoutId !=='undefined' && soundTimeoutId) clearTimeout(soundTimeoutId); if (callback) callback(...args); }}; // Renamed timeoutId
                audioElement.addEventListener('ended', execCb);
                const soundDur = (audioElement.duration && isFinite(audioElement.duration)) ? audioElement.duration * 1000 : 500;
                const soundTimeoutId = setTimeout(execCb, soundDur + 200); // Renamed
                audioElement.play().catch(e => { console.error("SFX play error:", e); execCb(); });
            } else { if (callback) callback(...args); }
        }
        function initBackgroundMusic() {
            backgroundMusicAudioEl.volume = gameConfig.musicVolume;
            backgroundMusicAudioEl.play().catch(e => console.log("BGM autoplay failed.", e));
        }
        function showFeedbackMessage(message, type = 'info', duration = 2500) {
            feedbackMessageTextPopupEl.textContent = message;
            feedbackPopupEl.className = 'feedback-popup';
            if (type) feedbackPopupEl.classList.add(type);
            feedbackPopupEl.classList.add('show');
            // feedbackPopupEl.style.display = 'block'; // .show handles this

            clearTimeout(feedbackTimeoutId);
            feedbackTimeoutId = setTimeout(() => {
                feedbackPopupEl.classList.remove('show');
                // setTimeout(() => { feedbackPopupEl.style.display = 'none'; }, 300); // .show handles this
            }, duration);
        }
        function triggerConfetti() {
            playSound(confettiSoundAudioEl);
            const confettiCount = 100;
            const colors = ['var(--primary)', 'var(--secondary)', 'var(--success)', 'var(--gold)', 'var(--info)']; // Added gold
            for (let i = 0; i < confettiCount; i++) {
                const piece = document.createElement('div');
                piece.classList.add('confetti-piece');
                piece.style.left = Math.random() * 100 + 'vw';
                piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                const animDur = Math.random() * 3 + 2; // Match GTP
                piece.style.animationName = 'fallAndFade';
                piece.style.animationDuration = animDur + 's';
                piece.style.animationDelay = Math.random() * 1 + 's'; // Match GTP
                document.body.appendChild(piece);
                setTimeout(() => piece.remove(), (animDur + parseFloat(piece.style.animationDelay || 0)) * 1000 + 500);
            }
        }
        function switchScreen(screenId) {
            Object.values(screens).forEach(screen => screen.classList.remove('active'));
            screens[screenId].classList.add('active');
            cornerLogoEl.style.display = (screenId !== 'start') ? 'block' : 'none';
             if (treatYourselfElement) {
                treatYourselfElement.style.display = (screenId === 'gameOver') ? 'flex' : 'none';
            }
        }

        function openVideoCurtains() {
            videoCurtainLeftEl.classList.add('open');
            videoCurtainRightEl.classList.add('open');
            videoClipPlayerEl.classList.add('visible');
            playSound(curtainSoundAudioEl);
        }
        function closeVideoCurtains() {
            videoCurtainLeftEl.classList.remove('open');
            videoCurtainRightEl.classList.remove('open');
            videoClipPlayerEl.classList.remove('visible');
        }


        // --- Settings ---
        settingsBtnEl.addEventListener('click', () => { playSound(interactionSoundAudioEl); settingsModalEl.style.display = 'flex'; });
        closeModalBtnEl.addEventListener('click', () => { playSound(interactionSoundAudioEl); settingsModalEl.style.display = 'none'; });
        window.addEventListener('click', (event) => { if (event.target === settingsModalEl) { playSound(interactionSoundAudioEl); settingsModalEl.style.display = 'none'; } });
        bgmVolumeSliderEl.addEventListener('input', (e) => { gameConfig.musicVolume = parseFloat(e.target.value); backgroundMusicAudioEl.volume = gameConfig.musicVolume; });
        sfxToggleBtnEl.addEventListener('click', () => {
            playSound(interactionSoundAudioEl);
            gameConfig.sfxEnabled = !gameConfig.sfxEnabled;
            sfxToggleBtnEl.textContent = `SFX: ${gameConfig.sfxEnabled ? 'ON' : 'OFF'}`;
            sfxToggleBtnEl.classList.toggle('btn-success', gameConfig.sfxEnabled);
            sfxToggleBtnEl.classList.toggle('btn-danger', !gameConfig.sfxEnabled);
        });

        // --- Start Screen & Team Setup ---
        modeOptionsEl.forEach(option => {
            option.addEventListener('click', function() {
                playSound(interactionSoundAudioEl);
                modeOptionsEl.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                gameState.gameMode = this.dataset.mode;
                teamInputsContainerEl.style.display = gameState.gameMode === 'multi' ? 'block' : 'none';
                if (gameState.gameMode === 'multi') updateTeamAddRemoveButtons();
            });
        });
        addTeamBtnEl.addEventListener('click', () => {
            playSound(interactionSoundAudioEl);
            const teamCount = teamNamesListEl.querySelectorAll('.team-input-wrapper').length;
            if (teamCount < gameConfig.maxTeams) {
                const wrapper = document.createElement('div');
                wrapper.className = 'team-input-wrapper';
                wrapper.innerHTML = `<input type="text" class="team-name-input" placeholder="Team ${teamCount + 1}"><button class="remove-team-btn btn-danger"><i class="fas fa-times"></i></button>`; // Added btn-danger
                wrapper.querySelector('.remove-team-btn').onclick = function() { playSound(interactionSoundAudioEl); this.parentElement.remove(); updateTeamAddRemoveButtons(); };
                teamNamesListEl.appendChild(wrapper);
                updateTeamAddRemoveButtons();
            } else {
                showFeedbackMessage(`Maximum of ${gameConfig.maxTeams} teams.`, 'info');
            }
        });
        function updateTeamAddRemoveButtons() {
            const teamWrappers = teamNamesListEl.querySelectorAll('.team-input-wrapper');
            const teamCount = teamWrappers.length;
            addTeamBtnEl.disabled = teamCount >= gameConfig.maxTeams;
            teamWrappers.forEach(wrapper => {
                const removeBtn = wrapper.querySelector('.remove-team-btn');
                if(removeBtn) removeBtn.disabled = teamCount <= gameConfig.minTeams;
            });
        }
        startGameBtnEl.addEventListener('click', () => {
            if(backgroundMusicAudioEl.paused) initBackgroundMusic();
            playSoundWithCallback(startGameSoundAudioEl, startGame);
        });

        // --- Game Flow ---
        function startGame() {
            gameState.currentRound = 0;
            gameState.usedClips = [];
            gameState.scores = {};

            if (gameState.gameMode === 'single') {
                gameState.players = ['You'];
            } else {
                gameState.players = Array.from(teamNamesListEl.querySelectorAll('.team-name-input'))
                    .map((input, index) => input.value.trim() || `Team ${index + 1}`)
                    .filter(name => name !== ''); // Basic validation, ensure not empty
                if (gameState.players.some(name => name.length > 15)) {
                    showFeedbackMessage("Team names too long (max 15)!", "danger"); return;
                }
                if (gameState.players.length < gameConfig.minTeams) {
                    showFeedbackMessage(`Multiplayer needs ${gameConfig.minTeams}-${gameConfig.maxTeams} teams!`, 'danger'); return;
                }
            }
            gameState.players.forEach(player => gameState.scores[player] = 0);
            nextRoundBtnEl.innerHTML = 'Next Round <i class="fas fa-arrow-right"></i>';
            setupRound();
        }

        function setupRound() {
            closeVideoCurtains(); // Ensure curtains are closed before loading new video
            gameState.currentRound++;
            gameState.singlePlayerChoice = null;
            gameState.roundPlayerChoices = {};
            gameState.currentPlayerIndexInRound = 0;

            let availableClips = gameState.clips.filter(clip => !gameState.usedClips.includes(clip.id));
            if (availableClips.length === 0) { gameState.usedClips = []; availableClips = [...gameState.clips]; }
            gameState.currentClip = availableClips[Math.floor(Math.random() * availableClips.length)];
            gameState.usedClips.push(gameState.currentClip.id);

            roundNumberTextEl.textContent = gameState.currentRound;
            if (gameState.gameMode === 'single') {
                scoreInfoTextEl.style.display = 'block';
                currentScoreTextEl.textContent = gameState.scores['You'];
                turnIndicatorEl.style.display = 'none';
            } else {
                scoreInfoTextEl.style.display = 'none';
                turnIndicatorEl.style.display = 'block';
                updateTurnIndicator();
            }

            videoClipPlayerEl.src = gameState.currentClip.partialUrl;
            videoClipPlayerEl.currentTime = 0; videoClipPlayerEl.pause(); videoClipPlayerEl.load();

            optionsContainerDisplayEl.innerHTML = '';
            gameState.currentClip.options.forEach((optionText, index) => {
                const optEl = document.createElement('button'); // Changed to button
                optEl.className = 'option'; // Keep class for specific option styles
                optEl.innerHTML = `<i class="far fa-circle"></i> <span>${optionText}</span>`;
                optEl.dataset.optionIndex = index;
                optEl.addEventListener('click', () => selectOption(optEl, index));
                optionsContainerDisplayEl.appendChild(optEl);
            });
            revealVideoBtnEl.disabled = true;
            switchScreen('game');
            setTimeout(openVideoCurtains, 500); // Open curtains after a delay
        }

        function updateTurnIndicator() {
            if (gameState.gameMode === 'multi' && gameState.players.length > 0) {
                const currentPlayerName = gameState.players[gameState.currentPlayerIndexInRound];
                turnIndicatorEl.textContent = `${currentPlayerName}'s turn to guess:`;
            }
        }

        function selectOption(optionElement, optionIndex) {
            playSound(interactionSoundAudioEl);
            const currentPlayerName = gameState.gameMode === 'multi' ? gameState.players[gameState.currentPlayerIndexInRound] : 'You';

            document.querySelectorAll('#options-container-display .option').forEach(opt => {
                if (opt.classList.contains('selected') && (gameState.gameMode === 'single' || opt.dataset.playerOwner === currentPlayerName) ) {
                    opt.classList.remove('selected');
                    opt.querySelector('i').className = 'far fa-circle'; // Reset icon
                    delete opt.dataset.playerOwner;
                }
            });

            optionElement.classList.add('selected');
            optionElement.querySelector('i').className = 'fas fa-check-circle'; // Change icon to check
            if(gameState.gameMode === 'multi') optionElement.dataset.playerOwner = currentPlayerName;

            if (gameState.gameMode === 'single') {
                gameState.singlePlayerChoice = optionIndex;
            } else {
                gameState.roundPlayerChoices[currentPlayerName] = optionIndex;
            }
            revealVideoBtnEl.disabled = false;
        }

        revealVideoBtnEl.addEventListener('click', () => {
            playSound(videoRevealSoundAudioEl); // Sound for revealing video
            if (gameState.gameMode === 'single' && gameState.singlePlayerChoice === null) {
                showFeedbackMessage("Please make a selection first!", "info");
                return;
            }

            if (gameState.gameMode === 'multi') {
                const currentPlayerName = gameState.players[gameState.currentPlayerIndexInRound];
                if (gameState.roundPlayerChoices[currentPlayerName] === undefined) {
                     showFeedbackMessage(`${currentPlayerName}, please make a selection.`, 'info');
                     return;
                }
                // If all multiplayer players have made a choice for this round, then process.
                if (gameState.currentPlayerIndexInRound < gameState.players.length -1) {
                    gameState.currentPlayerIndexInRound++;
                    updateTurnIndicator();
                    document.querySelectorAll('#options-container-display .option').forEach(opt => {
                        opt.classList.remove('selected');
                        opt.querySelector('i').className = 'far fa-circle';
                        const optIndex = parseInt(opt.dataset.optionIndex);
                        opt.onclick = () => selectOption(opt, optIndex); // Re-attach for new player
                    });
                    revealVideoBtnEl.disabled = true; // Disable until new player makes a choice
                    return;
                }
            }
            processAndRevealFullVideo();
        });


        function processAndRevealFullVideo() {
            videoClipPlayerEl.pause(); // Pause partial video
            closeVideoCurtains(); // Close curtains on game screen

            switchScreen('results');
            fullVideoPlayerEl.src = gameState.currentClip.fullUrl;
            fullVideoPlayerEl.currentTime = 0; fullVideoPlayerEl.load();
            // Autoplay might be blocked, user might need to click play on results screen video
            fullVideoPlayerEl.play().catch(error => console.log("Autoplay full video error:", error));

            let feedbackMsg = "";
            let feedbackType = "info";

            if (gameState.gameMode === 'single') {
                const isCorrect = gameState.singlePlayerChoice === gameState.currentClip.correctOption;
                if (isCorrect) { gameState.scores['You']++; playSound(correctAnswerSoundAudioEl); feedbackMsg = "You're Right!"; feedbackType = "correct"; }
                else { playSound(wrongAnswerSoundAudioEl); feedbackMsg = "You're Wrong!"; feedbackType = "incorrect"; }
            } else {
                const correctPlayersThisRound = [];
                gameState.players.forEach(player => {
                    const choice = gameState.roundPlayerChoices[player];
                    if (choice === gameState.currentClip.correctOption) { gameState.scores[player]++; correctPlayersThisRound.push(player); }
                });
                if (correctPlayersThisRound.length === gameState.players.length) { feedbackMsg = "Everyone got it right!"; feedbackType = "correct"; playSound(correctAnswerSoundAudioEl); }
                else if (correctPlayersThisRound.length > 0) { feedbackMsg = `${correctPlayersThisRound.join(', ')} got it right!`; feedbackType = "correct"; playSound(correctAnswerSoundAudioEl); }
                else { feedbackMsg = "Nobody got it right!"; feedbackType = "incorrect"; playSound(wrongAnswerSoundAudioEl); }
            }
            showFeedbackMessage(feedbackMsg, feedbackType, 2500);

            // Mark options on game screen (which is now hidden)
            const gameScreenOptions = document.querySelectorAll('#game-screen .option'); // Select options from game screen
            gameScreenOptions.forEach((optionEl, index) => {
                optionEl.classList.remove('selected');
                optionEl.onclick = null; // Disable further clicks on these old options
                optionEl.classList.add('disabled-option'); // Generic disabled state

                if (index === gameState.currentClip.correctOption) {
                    optionEl.classList.add('correct');
                    optionEl.classList.remove('disabled-option');
                    optionEl.querySelector('i').className = 'fas fa-check-circle';
                } else {
                    optionEl.querySelector('i').className = 'far fa-circle'; // Reset non-correct ones
                    // Highlight individual player's INCORRECT choices if needed, but can be noisy.
                    // For simplicity, we primarily highlight the correct one.
                     if (gameState.gameMode === 'single' && index === gameState.singlePlayerChoice) {
                        optionEl.classList.add('incorrect');
                        optionEl.classList.remove('disabled-option');
                        optionEl.querySelector('i').className = 'fas fa-times-circle';
                    }
                    // For multi, detailed feedback is on results screen.
                }
            });
            updateScoreDisplayOnResults();
            if (gameState.currentRound >= gameConfig.totalRounds) {
                 nextRoundBtnEl.innerHTML = 'See Final Results <i class="fas fa-trophy"></i>';
            } else {
                 nextRoundBtnEl.innerHTML = 'Next Round <i class="fas fa-arrow-right"></i>';
            }
        }

        function updateScoreDisplayOnResults() {
            scoreDisplayAreaEl.innerHTML = '';
            detailedFeedbackAreaResultsEl.innerHTML = ''; // Clear previous details

            if (gameState.gameMode === 'single') {
                const scoreCard = document.createElement('div');
                scoreCard.className = 'score-card-multi'; // Use multi style for consistency
                const progress = (gameState.scores['You'] / gameConfig.totalRounds) * 100;
                scoreCard.innerHTML = `
                    <h4>Your Current Score</h4>
                    <div class="score-value">${gameState.scores['You']}/${gameConfig.totalRounds}</div>
                    <div class="progress-bar-multi"><div class="progress-fill-multi" style="width: ${progress}%"></div></div>
                `;
                scoreDisplayAreaEl.appendChild(scoreCard);
                const singlePlayerChoiceIndex = gameState.singlePlayerChoice;
                const correctChoiceIndex = gameState.currentClip.correctOption;
                const singlePlayerCorrect = singlePlayerChoiceIndex === correctChoiceIndex;
                detailedFeedbackAreaResultsEl.innerHTML = `<p style="font-weight:bold;">You chose: "${gameState.currentClip.options[singlePlayerChoiceIndex]}". This was ${singlePlayerCorrect ? '<span style="color:var(--success);">Correct!</span>' : '<span style="color:var(--danger);">Incorrect.</span>'} The correct answer was "${gameState.currentClip.options[correctChoiceIndex]}".</p>`;
            } else { // Multiplayer
                 gameState.players.forEach(player => {
                    const scoreCard = document.createElement('div');
                    scoreCard.className = 'score-card-multi';
                    const score = gameState.scores[player];
                    const progress = (score / gameConfig.totalRounds) * 100;
                    scoreCard.innerHTML = `
                        <h4>${player}</h4>
                        <div class="score-value">${score}</div>
                        <div class="progress-bar-multi"><div class="progress-fill-multi" style="width: ${progress}%"></div></div>
                    `;
                    scoreDisplayAreaEl.appendChild(scoreCard);

                    const choiceIndex = gameState.roundPlayerChoices[player];
                    if (choiceIndex !== undefined && choiceIndex !== null) { // Ensure choice was made
                        const choiceText = gameState.currentClip.options[choiceIndex];
                        const isCorrect = choiceIndex === gameState.currentClip.correctOption;
                        const feedbackEntry = document.createElement('p');
                        feedbackEntry.innerHTML = `<strong>${player}</strong> chose: "${choiceText}" - ${isCorrect ? '<span style="color:var(--success);">Correct!</span>' : '<span style="color:var(--danger);">Incorrect.</span>'}`;
                        detailedFeedbackAreaResultsEl.appendChild(feedbackEntry);
                    } else {
                        const feedbackEntry = document.createElement('p');
                        feedbackEntry.innerHTML = `<strong>${player}</strong> did not make a selection.`;
                        detailedFeedbackAreaResultsEl.appendChild(feedbackEntry);
                    }
                });
                 const correctOptionText = gameState.currentClip.options[gameState.currentClip.correctOption];
                detailedFeedbackAreaResultsEl.innerHTML += `<p style="margin-top:15px; font-weight:bold;">The correct answer was: "${correctOptionText}"</p>`;
            }
        }

        nextRoundBtnEl.addEventListener('click', () => {
            playSound(interactionSoundAudioEl);
            fullVideoPlayerEl.pause();
            if (gameState.currentRound >= gameConfig.totalRounds) {
                showGameOver();
            } else {
                setupRound();
            }
        });

        function showGameOver() {
            triggerConfetti();
            finalScoresDisplayAreaEl.innerHTML = '';

            if (gameState.gameMode === 'single') {
                const score = gameState.scores['You'];
                finalScoreMessageTextEl.textContent = `You scored ${score} out of ${gameConfig.totalRounds}!`;
                winMessageTextEl.textContent = score === gameConfig.totalRounds ? "Perfect Score!" : (score > gameConfig.totalRounds / 2 ? "Great Job!" : "Game Complete!");

                const finalScoreCard = document.createElement('div');
                finalScoreCard.className = `score-card-multi ${score === gameConfig.totalRounds ? 'winner-glow' : ''}`;
                finalScoreCard.innerHTML = `
                    <h4>Final Score</h4>
                    <div class="score-value">${score}/${gameConfig.totalRounds}</div>`;
                finalScoresDisplayAreaEl.appendChild(finalScoreCard);
            } else { // Multiplayer
                let highScore = -1;
                Object.values(gameState.scores).forEach(s => { if (Number(s) > highScore) highScore = Number(s); });
                const winners = gameState.players.filter(p => (Number(gameState.scores[p]) || 0) === highScore && highScore >= 0);

                if (winners.length === 1) { winMessageTextEl.textContent = `${winners[0]} Wins!`; }
                else if (winners.length > 1) { winMessageTextEl.textContent = "It's a Tie!"; }
                else { winMessageTextEl.textContent = "Game Over!"; }
                finalScoreMessageTextEl.textContent = "Final scores below.";

                gameState.players.forEach(player => {
                    const scoreCard = document.createElement('div');
                    scoreCard.className = `score-card-multi ${winners.includes(player) ? 'winner-glow' : ''}`;
                    scoreCard.innerHTML = `<h4>${player}</h4><div class="score-value">${gameState.scores[player]}</div>`;
                    finalScoresDisplayAreaEl.appendChild(scoreCard);
                });
            }
             // "Treat Yourself" callout
            if (!treatYourselfElement) {
                treatYourselfElement = document.createElement('div');
                treatYourselfElement.className = 'treat-yourself-callout';
                treatYourselfElement.innerHTML = `<span>Treat Yourself!</span> <i class="fas fa-arrow-down"></i>`;
                storeButtonWrapperEl.insertBefore(treatYourselfElement, visitStoreBtnEl);
            }
            switchScreen('gameOver'); // This will also ensure treatYourself is displayed
        }

        playAgainBtnEl.addEventListener('click', () => { playSoundWithCallback(startGameSoundAudioEl, startGame);});
        mainMenuBtnEl.addEventListener('click', () => {
            playSound(interactionSoundAudioEl);
            // Reset team inputs for new game setup
            teamNamesListEl.innerHTML = `
                <div class="team-input-wrapper"><input type="text" class="team-name-input" placeholder="Team 1"><button class="remove-team-btn btn-danger" disabled><i class="fas fa-times"></i></button></div>
                <div class="team-input-wrapper"><input type="text" class="team-name-input" placeholder="Team 2"><button class="remove-team-btn btn-danger" disabled><i class="fas fa-times"></i></button></div>
            `;
            updateTeamAddRemoveButtons();
            if (modeOptionsEl.length > 0) modeOptionsEl[0].click(); // Default to single player
             if (treatYourselfElement) treatYourselfElement.style.display = 'none';
             if(backgroundMusicAudioEl.paused) initBackgroundMusic();
            switchScreen('start');
        });
        visitStoreBtnEl.addEventListener('click', () => {
            playSound(interactionSoundAudioEl);
            window.open('https://www.example.com/store', '_blank');
        });

        document.addEventListener('DOMContentLoaded', () => {
            sfxToggleBtnEl.textContent = `SFX: ${gameConfig.sfxEnabled ? 'ON' : 'OFF'}`;
            sfxToggleBtnEl.classList.toggle('btn-success', gameConfig.sfxEnabled);
            sfxToggleBtnEl.classList.toggle('btn-danger', !gameConfig.sfxEnabled);
            bgmVolumeSliderEl.value = gameConfig.musicVolume;
            initBackgroundMusic();
            if (modeOptionsEl.length > 0) modeOptionsEl[0].click(); // Set default mode
            updateTeamAddRemoveButtons(); // Initialize button states
            switchScreen('start');
        });
    </script>
</body>
</html>