<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siblings or Dating - Blyza Game Center</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bungee&family=Luckiest+Guy&family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- START: BRAND IDENTITY & ROOT VARIABLES --- */
        :root {
            --blyza-orange-primary: #FF8833;
            --blyza-purple-secondary: #cb7ae1;
            --blyza-keppel-accent: #00BFA6;
            --blyza-sunny-yellow: #FFDF00;
            --blyza-quickfire-red: #EA2027;

            --darker-grey-bg: #4A4A4A;
            --text-light: #FDFEFE;
            --text-dark: #2C3A47;
            --text-medium: #535c68;
            --black-stroke: #1A1A1A;

            --font-logo: "Luckiest Guy", cursive;
            --font-heading-alt: "Bungee", cursive;
            --font-body: 'Quicksand', sans-serif;
            --border-radius-game: 12px;
            --shadow-chunky: 4px 4px 0px var(--black-stroke);
        }
        /* --- END: BRAND IDENTITY & ROOT VARIABLES --- */

        /* --- Basic Reset & Body --- */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        
        body {
            font-family: var(--font-body);
            color: var(--text-light);
            background: linear-gradient(135deg, var(--blyza-orange-primary) 0%, var(--blyza-purple-secondary) 100%);
            line-height: 1.6;
            overflow: hidden; /* Body does not scroll */
            position: relative;
            height: var(--app-height, 100vh); /* Full screen height */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px 10px;
        }

        /* --- Floating Background Elements --- */
        .hero-background-elements { position: fixed; top:0; left:0; width:100%; height:100%; z-index:0; pointer-events: none; }
        .bg-game-element {
            position: absolute; opacity: 0.1; color: var(--text-light);
            animation: floatSimple 20s infinite ease-in-out alternate;
            user-select: none;
        }
        .bg-heart-1 { font-size: 150px; top: 10%; left: 5%; --initial-rotate: -15deg; animation-duration: 22s; }
        .bg-users-1 { font-size: 100px; top: 65%; right: 8%; --initial-rotate: 10deg; animation-duration: 18s; }
        .bg-venus-1 { font-size: 120px; top: 70%; left: 15%; --initial-rotate: 5deg; animation-duration: 25s; opacity: 0.08; }
        .bg-mars-1 { font-size: 130px; top: 15%; right: 10%; --initial-rotate: 20deg; animation-duration: 16s; }
        .bg-heart-2 { font-size: 80px; top: 80%; right: 25%; --initial-rotate: 25deg; animation-duration: 15s; }
        .bg-users-2 { font-size: 120px; bottom: 5%; left: 3%; --initial-rotate: -5deg; animation-duration: 28s; }
        .bg-question-1 { font-size: 90px; top: 20%; left: 20%; --initial-rotate: 15deg; animation-duration: 20s; }
        .bg-rings-1 { font-size: 70px; top: 5%; right: 30%; --initial-rotate: -10deg; animation-duration: 24s; }
        .bg-heart-3 { font-size: 110px; bottom: 10%; right: 4%; --initial-rotate: 12deg; animation-duration: 19s; }
        .bg-users-3 { font-size: 60px; top: 50%; left: 1%; --initial-rotate: 20deg; animation-duration: 26s; }

        @keyframes floatSimple {
            0% { transform: translateY(0px) rotate(var(--initial-rotate, 0deg)); }
            50% { transform: translateY(-25px) rotate(calc(var(--initial-rotate, 0deg) + 8deg)); }
            100% { transform: translateY(0px) rotate(calc(var(--initial-rotate, 0deg) - 8deg)); }
        }
        
        /* --- Main Game Container --- */
        .game-container {
            max-width: 900px;
            width: 100%;
            background: linear-gradient(145deg, #fdfefe, #e9ecef);
            color: var(--text-dark);
            border-radius: var(--border-radius-game);
            border: 3px solid var(--black-stroke);
            box-shadow: 8px 8px 0px var(--black-stroke);
            padding: 30px; 
            text-align: center;
            position: relative;
            z-index: 2;
            max-height: calc(var(--app-height, 100vh) - 40px); /* Make container scrollable */
            overflow-y: auto;
        }

        .brand-logo { object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .brand-logo-prominent { display: block; margin: 0 auto 15px; max-height: 80px; }
        
        h1 {
            font-family: var(--font-logo);
            font-size: clamp(2.2rem, 5vw, 3rem);
            color: var(--blyza-orange-primary);
            -webkit-text-stroke: 2px var(--black-stroke);
            text-stroke: 2px var(--black-stroke);
            text-shadow: 3px 3px 0px rgba(0,0,0,0.15);
            margin-bottom: 20px;
            line-height: 1.1;
        }

        h3 { 
            font-family: var(--font-heading-alt); 
            margin-bottom: 15px; 
            font-size: 1.5rem;
            color: var(--text-dark);
        }
        
        .screen { display: none; animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .active { display: block; }
        
        /* --- Instructions & Info Panels --- */
        .instructions, .team-inputs {
            background: rgba(0,0,0, 0.04);
            padding: 20px; border-radius: 10px; margin: 25px 0;
            border: 2px dashed var(--text-medium);
        }
        .instructions p { font-size: 1.1rem; margin-bottom: 15px; font-weight: 600; }
        .instructions ul { list-style-type: none; text-align: left; padding: 0 10px; }
        .instructions li { margin-bottom: 10px; display: flex; align-items: center; }
        .instructions i { margin-right: 15px; font-size: 1.3em; color: var(--blyza-purple-secondary); width:20px; text-align:center;}
        
        /* --- Buttons --- */
        button, .btn-primary, .btn-secondary, .btn-success, .btn-danger, .btn-info {
            font-family: var(--font-heading-alt); font-size: 1.1rem; padding: 0.7em 1.5em;
            border: 3px solid var(--black-stroke); border-radius: 8px;
            text-transform: uppercase; text-decoration: none; display: inline-flex;
            align-items: center; justify-content: center; gap: 10px;
            transition: transform 0.1s ease, box-shadow 0.1s ease;
            letter-spacing: 1px; cursor: pointer; color: var(--text-dark);
            margin: 8px 5px;
            box-shadow: var(--shadow-chunky);
        }
        button:hover:not(:disabled) { transform: translate(2px, 2px); box-shadow: 2px 2px 0px var(--black-stroke); }
        button:active:not(:disabled) { transform: translate(4px, 4px); box-shadow: 0px 0px 0px var(--black-stroke); }
        button:disabled { background: var(--text-medium); color: var(--text-light); cursor: not-allowed; opacity: 0.7; box-shadow: var(--shadow-chunky); }

        .btn-primary { background-color: var(--blyza-sunny-yellow); }
        .btn-secondary { background-color: var(--blyza-purple-secondary); color: var(--text-light); }
        .btn-success { background-color: var(--blyza-keppel-accent); color: var(--text-light); }
        .btn-danger { background-color: var(--blyza-quickfire-red); color: var(--text-light); }
        .btn-info { background-color: #4ECDC4; color: var(--text-dark); }

        /* --- Mode & Team Selection --- */
        .game-mode-selection { display: flex; justify-content: center; gap: 20px; margin: 30px 0; flex-wrap: wrap; }
        .mode-option {
            background: var(--text-light); padding: 20px; border-radius: var(--border-radius-game);
            cursor: pointer; transition: all 0.3s ease; border: 3px solid var(--black-stroke);
            box-shadow: var(--shadow-chunky); flex: 1; min-width: 250px; max-width: 300px;
        }
        .mode-option:hover { transform: translateY(-5px) scale(1.02); box-shadow: 6px 6px 0 var(--blyza-orange-primary); }
        .mode-option.selected {
            background: var(--blyza-keppel-accent); color: var(--text-light); border-color: var(--black-stroke);
            transform: scale(1.02); box-shadow: 6px 6px 0 var(--black-stroke);
        }
        .mode-option.selected i, .mode-option.selected h3, .mode-option.selected p { color: var(--text-light); }
        .mode-option i { font-size: 2.5rem; margin-bottom: 10px; color: var(--blyza-orange-primary); transition: all 0.3s ease; }
        .mode-option h3 { margin-bottom: 8px; font-size: 1.3rem; margin-top: 0; }
        .mode-option p { color: var(--text-medium); font-size: 0.9rem; }
        .team-inputs h3 { font-family: var(--font-heading-alt); margin-bottom: 15px; margin-top:0; }
        .team-input-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
        .team-input-wrapper input {
            width: 100%; padding: 12px 18px; border-radius: 8px;
            border: 3px solid var(--black-stroke); background: var(--text-light);
            color: var(--text-dark); font-size: 1rem; transition: all 0.3s ease;
            font-family: var(--font-body); font-weight: 600;
        }
        .team-input-wrapper input:focus { outline: none; border-color: var(--blyza-orange-primary); box-shadow: 0 0 0 3px var(--blyza-sunny-yellow); }
        .remove-team-btn {
            background: var(--blyza-quickfire-red); color: var(--text-light);
            padding: 8px 12px; font-size: 0.8rem; margin: 0;
        }
        .remove-team-btn:disabled { background: var(--text-medium); cursor: not-allowed; opacity: 0.7; }
        #add-team-btn { font-size: 1rem; padding: 10px 20px;}

        /* --- Game Screen & Media Stage --- */
        .game-info {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
            padding: 12px 15px;
            background: rgba(0,0,0,0.1);
            border-radius: 8px;
            font-size: 1.1rem;
            font-family: var(--font-heading-alt);
            color: var(--text-dark);
            border: 2px solid var(--black-stroke);
        }
        #turn-indicator { font-size: 1.2rem; color: var(--blyza-purple-secondary); text-shadow: 1px 1px 0 var(--black-stroke); }
        .media-stage-container {
            background: var(--darker-grey-bg); padding: 20px; border-radius: var(--border-radius-game);
            margin: 25px auto; border: 3px solid var(--black-stroke);
            box-shadow: inset 0 0 15px rgba(0,0,0,0.3); position: relative; overflow: hidden;
        }
        .tv-screen-wrapper {
            background: #111; border: 10px solid #333; border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.7), inset 0 0 10px rgba(0,0,0,0.5);
            position: relative; z-index: 1;
            width: 100%; min-height: 300px;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        .stage-curtains {
            position: absolute; top: 0; width: 51%; height: 100%;
            background-color: var(--text-dark);
            background-image: repeating-linear-gradient(90deg, transparent, transparent 20px, rgba(255,255,255,0.03) 20px, rgba(255,255,255,0.03) 40px);
            box-shadow: 0 0 25px rgba(0,0,0,0.6);
            transition: transform 1.2s cubic-bezier(0.77, 0, 0.175, 1);
            z-index: 5;
        }
        .stage-curtains.left { left: 0; border-right: 6px solid var(--blyza-orange-primary); }
        .stage-curtains.right { right: 0; border-left: 6px solid var(--blyza-orange-primary); }
        .stage-curtains.open.left { transform: translateX(-105%) skewX(-10deg); }
        .stage-curtains.open.right { transform: translateX(105%) skewX(10deg); }
        
        .media-content-image {
            max-height: 400px; max-width: 100%; object-fit: contain;
            border-radius: 8px; display: block;
            opacity: 0; transition: opacity 0.5s ease-in 0.7s;
        }
        .media-content-image.visible { opacity: 1; }

        /* --- Choice Buttons & Results --- */
        .choice-buttons-container {
            display: flex; justify-content: center; gap: 20px;
            margin: 30px 0 20px 0; flex-wrap: wrap;
        }
        .choice-btn { flex: 1; max-width: 300px; }
        .choice-btn.selected {
            box-shadow: 2px 2px 0px var(--black-stroke) !important;
            transform: translate(2px, 2px) !important;
        }
        #siblings-btn { background-color: var(--blyza-keppel-accent); color: var(--text-light); }
        #dating-btn { background-color: var(--blyza-quickfire-red); color: var(--text-light); }

        .result-display-area {
            background: var(--darker-grey-bg); padding: 20px; border-radius: var(--border-radius-game);
            margin-bottom: 25px; border: 3px solid var(--black-stroke);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #result-image-content { max-height: 300px; max-width: 95%; object-fit: contain; border-radius: 8px; }
        #inline-answer-feedback { margin-top: 15px; text-align: center; }
        .inline-answer-text { font-family: var(--font-heading-alt); font-size: 1.8rem; margin-bottom: 5px; }
        .inline-feedback-text { font-family: var(--font-body); font-weight: 700; font-size: 1.1rem; }
        .answer-siblings-text { color: var(--blyza-keppel-accent); text-shadow: 1px 1px 0 var(--black-stroke); }
        .answer-dating-text { color: var(--blyza-quickfire-red); text-shadow: 1px 1px 0 var(--black-stroke); }
        .feedback-correct-text { color: var(--blyza-keppel-accent); }
        .feedback-incorrect-text { color: var(--blyza-quickfire-red); }

        /* --- Score & Game Over --- */
        .score-display-container, #final-scores-display-area {
            display: grid; gap: 20px; margin: 30px 0;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        .score-card {
            background: rgba(0,0,0,0.05); padding: 20px; border-radius: 10px;
            border: 3px solid var(--black-stroke); transition: all 0.3s ease;
            box-shadow: var(--shadow-chunky);
        }
        .score-card h4 { font-family: var(--font-heading-alt); color: var(--blyza-orange-primary); }
        .score-card .score-value-text { font-family: var(--font-heading-alt); font-size: 2rem; margin-bottom: 15px;}
        .score-card.winner-glow {
            animation: winnerGlow 1.5s infinite alternate;
            border-color: var(--blyza-keppel-accent);
        }
        @keyframes winnerGlow { from { box-shadow: 4px 4px 0 var(--blyza-keppel-accent); } to { box-shadow: 4px 4px 15px var(--blyza-keppel-accent); } }
        
        .progress-bar-element {
            height: 12px; background: rgba(0,0,0,0.2); border-radius: 50px;
            margin-top: 15px; overflow: hidden; border: 2px solid var(--black-stroke);
        }
        .progress-fill-element {
            height: 100%; background: var(--blyza-sunny-yellow);
            border-radius: 50px; transition: width 0.5s ease;
        }

        .winner-trophy-icon {
            font-size: 6rem; margin: 20px 0; animation: bounce 1.5s infinite ease-in-out;
            color: var(--blyza-sunny-yellow);
            text-shadow: 0 0 20px var(--blyza-orange-primary), 3px 3px 0 var(--black-stroke);
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-25px); } }
        
        .win-message-text {
            font-family: var(--font-logo); font-size: 3rem; margin: 20px 0;
            color: var(--blyza-orange-primary);
            -webkit-text-stroke: 2px var(--black-stroke);
            text-stroke: 2px var(--black-stroke);
        }
        #final-message-details { font-size: 1.1rem; font-weight: 600; }

        /* --- Floating Icon Buttons --- */
        .icon-btn {
            position: absolute; background-color: var(--blyza-purple-secondary);
            color: var(--text-light); border-radius: 50%; width: 55px; height: 55px;
            font-size: 1.2rem; cursor: pointer; transition: all 0.1s ease;
            display: flex; justify-content: center; align-items: center; z-index: 100;
            text-decoration: none; border: 3px solid var(--black-stroke);
            box-shadow: 4px 4px 0px var(--black-stroke);
        }
        .icon-btn:hover { transform: translate(2px, 2px); box-shadow: 2px 2px 0px var(--black-stroke); }
        .icon-btn:active { transform: translate(4px, 4px); box-shadow: 0px 0px 0px var(--black-stroke); }
        #settings-btn { top: 20px; right: 20px; }
        #highscore-btn { top: 20px; right: 85px; background-color: var(--blyza-sunny-yellow); }
        #home-menu-btn, #back-btn { top: 20px; left: 20px; }
        #back-btn { display: none; }
        
        /* --- Modal & Feedback Styles --- */
        .modal { position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); -webkit-backdrop-filter: blur(5px); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; animation: fadeInModal 0.3s ease; }
        @keyframes fadeInModal { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background-color: var(--darker-grey-bg); margin: auto; padding: 25px; border: 3px solid var(--black-stroke); border-radius: var(--border-radius-game); width: 90%; max-width: 450px; box-shadow: 8px 8px 0px rgba(0,0,0,0.4); position: relative; color: var(--text-light); text-align: center; }
        .modal-content h2 { font-family: var(--font-logo); color: var(--blyza-orange-primary); -webkit-text-stroke: 1.5px var(--black-stroke); text-stroke: 1.5px var(--black-stroke); text-align: center; margin-bottom: 25px; font-size: 2rem; }
        .setting-item { margin-bottom: 18px; display: flex; flex-direction: column; }
        .setting-item label { margin-bottom: 10px; font-weight: 600; font-size: 1rem; }
        .close-modal-btn { color: #aaa; position: absolute; top: 10px; right: 15px; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .close-modal-btn:hover { color: var(--text-light); }
        .modal-content button#sfx-toggle-btn { font-size: 1rem; padding: 10px 20px; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]:focus { outline: none; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 10px; cursor: pointer; background: rgba(0,0,0,0.3); border-radius: 5px; border: 2px solid var(--black-stroke); }
        input[type=range]::-webkit-slider-thumb { border: 2px solid var(--black-stroke); height: 22px; width: 22px; border-radius: 50%; background: var(--blyza-orange-primary); cursor: pointer; -webkit-appearance: none; margin-top: -9px; }
        #audio-consent-modal .modal-content p { font-family: var(--font-body); font-weight: 600; font-size: 1.1rem; margin-bottom: 25px; color: var(--text-light); }
        #audio-consent-buttons { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        
        .feedback-popup { position: fixed; top: 50%; left: 50%; background-color: var(--text-dark); color: white; padding: 25px 40px; border-radius: var(--border-radius-game); font-size: 2.5rem; font-family: var(--font-logo); text-align: center; z-index: 2000; box-shadow: 8px 8px 0px rgba(0,0,0,0.5); opacity: 0; transform: translate(-50%, -50%) scale(0.7); transition: opacity 0.3s ease, transform 0.3s ease; pointer-events: none; border: 3px solid var(--black-stroke); display: none; }
        .feedback-popup.show { opacity: 1; transform: translate(-50%, -50%) scale(1); display: block; }
        .feedback-popup.correct { color: var(--blyza-keppel-accent); }
        .feedback-popup.incorrect { color: var(--blyza-quickfire-red); }
        .feedback-popup.info { color: var(--blyza-sunny-yellow); }

        /* --- Confetti & Game Over Buttons --- */
        .confetti-piece { position: fixed; width: 10px; height: 20px; background-color: var(--blyza-orange-primary); opacity: 0; animation-timing-function: linear; animation-fill-mode: forwards; pointer-events: none; z-index: 3000; }
        @keyframes fallAndFade { 0% { transform: translateY(-20vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(120vh) rotate(720deg); opacity: 0; } }
        .game-over-buttons-container { display: flex; justify-content: center; flex-wrap: wrap; gap: 15px; margin-top: 20px; }
        .game-over-button-wrapper { position: relative; display: flex; flex-direction: column; align-items: center; }
        .treat-yourself-callout { margin-bottom: 8px; background-color: var(--blyza-sunny-yellow); color: var(--text-dark); padding: 8px 15px; border-radius: 20px; font-family: var(--font-heading-alt); font-size: 0.9rem; white-space: nowrap; box-shadow: var(--shadow-chunky); display: none; align-items: center; gap: 8px; z-index: 10; border: 2px solid var(--black-stroke); }
        .treat-yourself-callout i { font-size: 1.2em; animation: bounceArrow 1s infinite; }
        @keyframes bounceArrow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        
        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) {
            body { 
                padding: 10px; 
                align-items: flex-start;
                padding-top: 20px;
                padding-bottom: 20px;
            }
            .game-container { 
                padding: 45px 15px 15px; 
                max-height: calc(var(--app-height, 100vh) - 40px);
            } 
            h1 { font-size: 2rem; margin-top: 5px; }
            .instructions { padding: 15px; }
            .choice-buttons-container { flex-direction: column; align-items: center; }
            .choice-btn { width: 90%; max-width: none; }
            .icon-btn { width: 48px; height: 48px; }
            #settings-btn { top: 12px; right: 12px; }
            #highscore-btn { top: 12px; right: 70px; }
            #home-menu-btn, #back-btn { top: 12px; left: 12px; }
            .feedback-popup { font-size: 2rem; padding: 20px 30px; width: 90%; }
            .modal-content { padding: 20px; }
            .game-over-buttons-container { flex-direction: column; align-items: center; }
            .game-over-buttons-container .game-over-button-wrapper { width: 90%; }
            .game-over-buttons-container .game-over-button-wrapper button { width: 100%; }
            .win-message-text { font-size: 2.2rem; }
            .media-content-image { max-height: 250px; }
            .bg-game-element { display: none; }
        }
    </style>
</head>
<body>
    <!-- Floating background elements -->
    <div class="hero-background-elements">
        <div class="bg-game-element bg-heart-1"><i class="fas fa-heart"></i></div>
        <div class="bg-game-element bg-users-1"><i class="fas fa-users"></i></div>
        <div class="bg-game-element bg-venus-1"><i class="fas fa-venus"></i></div>
        <div class="bg-game-element bg-mars-1"><i class="fas fa-mars"></i></div>
        <div class="bg-game-element bg-heart-2"><i class="fas fa-heart"></i></div>
        <div class="bg-game-element bg-users-2"><i class="fas fa-users"></i></div>
        <div class="bg-game-element bg-question-1"><i class="fas fa-question-circle"></i></div>
        <div class="bg-game-element bg-rings-1"><i class="fas fa-ring"></i></div>
        <div class="bg-game-element bg-heart-3"><i class="fas fa-heart"></i></div>
        <div class="bg-game-element bg-users-3"><i class="fas fa-users"></i></div>
    </div>
    
    <script>
        // THIS SCRIPT MUST RUN FIRST
        function setAppHeight() {
            document.documentElement.style.setProperty('--app-height', `${window.innerHeight}px`);
        }
        window.addEventListener('resize', setAppHeight);
        setAppHeight();
    </script>

    <div class="game-container">
        <a href="#" onclick="history.back(); return false;" id="home-menu-btn" class="icon-btn" aria-label="Back to the previous page">
            <i class="fas fa-home"></i>
        </a>
        <button id="back-btn" class="icon-btn" aria-label="Go Back" style="display: none;">
            <i class="fas fa-arrow-left"></i>
        </button>
        <button id="highscore-btn" class="icon-btn" aria-label="Show High Score">
            <i class="fas fa-star"></i>
        </button>
        <button id="settings-btn" class="icon-btn" aria-label="Open Settings">
            <i class="fas fa-cog"></i>
        </button>

        <!-- Start Screen -->
        <div id="start-screen" class="screen active">
            <img class="brand-logo brand-logo-prominent" src="https://static.wixstatic.com/shapes/9ce3e5_4f0149a89dd841859da02f59247b5b6b.svg" alt="Blyza Mascot">
            <h1>Siblings or Dating?</h1>
            <div class="instructions">
                <p><strong>HOW TO PLAY:</strong></p>
                <ul>
                    <li><i class="fas fa-images"></i> You'll be shown a photo of two people</li>
                    <li><i class="fas fa-user-friends"></i><i class="fas fa-heart" style="margin-left: 5px;"></i> Decide if they are siblings or if they are dating!</li>
                    <li><i class="fas fa-users"></i> Play solo or with up to 4 teams!</li>
                </ul>
            </div>
             <div class="game-mode-selection">
                <div class="mode-option selected" data-mode="single">
                    <i class="fas fa-user"></i>
                    <h3>Single Player</h3>
                    <p>5 rounds or infinite mode</p>
                </div>
                <div class="mode-option" data-mode="multi">
                    <i class="fas fa-users"></i>
                    <h3>Multiplayer</h3>
                    <p>Up to 4 teams, 5 rounds</p>
                </div>
            </div>
            
            <div id="single-player-sub-options" style="margin-top: 15px;">
                <button id="five-rounds-btn" class="btn-primary"><i class="fas fa-list-ol"></i> 5 Rounds</button>
                <button id="infinite-mode-btn" class="btn-primary"><i class="fas fa-infinity"></i> Infinite Mode</button>
            </div>

            <div id="multiplayer-start-area" style="display: none;">
                <div id="team-inputs-container">
                    <div class="team-inputs">
                        <h3>Enter Team Names</h3>
                        <div id="team-names-list">
                            <div class="team-input-wrapper"><input type="text" class="team-name-input" placeholder="Team 1"></div>
                            <div class="team-input-wrapper"><input type="text" class="team-name-input" placeholder="Team 2"></div>
                        </div>
                        <button id="add-team-btn" class="btn-secondary"><i class="fas fa-plus"></i> Add Team</button>
                    </div>
                </div>
                <button id="start-multiplayer-game-btn" class="btn-primary">Start Game <i class="fas fa-play"></i></button>
            </div>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="screen">
            <div class="game-info">
                <div id="round-info-text">Round <span id="round-number-text">1</span>/5</div>
                <div id="score-info-text" style="display:none;">Score: <span id="current-score-text">0</span></div>
            </div>
            <div id="turn-indicator" style="display: none;"></div>
            <div class="media-stage-container">
                <h3>Are these two...</h3>
                <div class="tv-screen-wrapper">
                    <div class="stage-curtains left" id="media-curtain-left"></div>
                    <div class="stage-curtains right" id="media-curtain-right"></div>
                    <img id="media-image-content" src="" alt="Couple or siblings photo" class="media-content-image">
                </div>
            </div>
            <div class="choice-buttons-container">
                <button id="siblings-btn" class="choice-btn">
                    <i class="fas fa-users"></i> Siblings
                </button>
                <button id="dating-btn" class="choice-btn">
                    <i class="fas fa-heart"></i> Dating
                </button>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="screen">
            <h1>Round Result</h1>
            <div class="result-display-area">
                 <img id="result-image-content" src="" alt="Result photo" class="media-content-image" style="display: block; opacity:1;">
                <div id="inline-answer-feedback">
                    <p class="inline-answer-text" id="actual-answer-text"></p>
                    <p class="inline-feedback-text" id="player-guess-feedback-text"></p>
                </div>
            </div>
            <div id="score-display-container-results" class="score-display-container"></div>
            <div id="detailed-feedback-area-multiplayer" style="margin-top: 15px; text-align:left; font-size: 1.1rem; line-height:1.7;"></div>
            <button id="next-round-btn" class="btn-primary">Next Round <i class="fas fa-arrow-right"></i></button>
        </div>

        <!-- Game Over Screen -->
        <div id="game-over-screen" class="screen">
            <img class="brand-logo brand-logo-prominent" src="https://static.wixstatic.com/shapes/9ce3e5_4f0149a89dd841859da02f59247b5b6b.svg" alt="Blyza Mascot">
            <h1>Game Over!</h1>
            <div class="win-message-text" id="final-win-message-text">Game Complete!</div>
            <div class="winner-trophy-icon">🏆</div>
            <div id="final-message-details">Your final score is...</div>
            <div id="final-scores-display-area" class="score-display-container"></div>
            <div class="game-over-buttons-container">
                <div class="game-over-button-wrapper">
                    <button id="play-again-btn" class="btn-success"><i class="fas fa-redo"></i> Play Again</button>
                </div>
                <div class="game-over-button-wrapper">
                     <button id="main-menu-btn" class="btn-secondary"><i class="fas fa-home"></i> Main Menu</button>
                </div>
                <div class="game-over-button-wrapper" id="store-button-wrapper">
                    <button id="visit-store-btn" class="btn-info"><i class="fas fa-store"></i> Visit Store</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio Consent Modal -->
    <div id="audio-consent-modal" class="modal">
        <div class="modal-content">
            <h2>Enable Audio?</h2>
            <p>This game has background music and sound effects. Would you like to enable them for the best experience?</p>
            <div id="audio-consent-buttons">
                <button id="audio-consent-yes-btn" class="btn-success"><i class="fas fa-volume-up"></i> Yes, please!</button>
                <button id="audio-consent-no-btn" class="btn-secondary"><i class="fas fa-volume-mute"></i> No, thanks</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span id="close-modal-btn" class="close-modal-btn">×</span>
            <h2>Settings</h2>
            <div class="setting-item">
                <label for="bgm-volume-slider">Music Volume:</label>
                <input type="range" id="bgm-volume-slider" min="0" max="1" step="0.01" value="0.2">
            </div>
            <div class="setting-item">
                <label for="sfx-toggle-btn">Sound Effects:</label>
                <button id="sfx-toggle-btn" class="btn-secondary">SFX: ON</button>
            </div>
        </div>
    </div>

    <!-- Feedback Pop-up -->
    <div id="feedback-popup" class="feedback-popup">
        <span id="feedback-message-text-el"></span>
    </div>

    <audio id="background-music" loop src="https://static.wixstatic.com/mp3/9ce3e5_380adfaea802407b9a4cebc67f12a216.mp3"></audio>
    <audio id="start-game-sound" src="https://static.wixstatic.com/mp3/9ce3e5_1b9151238aec4e29ab14f1526e9c1334.mp3"></audio>
    <audio id="interaction-sound" src="https://static.wixstatic.com/mp3/9ce3e5_fc326aa1760c485dbac083ec55c2bfcb.wav"></audio>
    <audio id="correct-answer-sound" src="https://static.wixstatic.com/mp3/9ce3e5_76691a6fefcd4536aa403ada111e886a.mp3"></audio>
    <audio id="wrong-answer-sound" src="https://static.wixstatic.com/mp3/9ce3e5_277f814439064d1bbe5c0342241b23e4.mp3"></audio>
    <audio id="curtain-sound" src="https://static.wixstatic.com/mp3/9ce3e5_ccd36cdf98bf4e1594cf2e52d5296c51.wav"></audio>
    <audio id="confetti-sound" src="https://static.wixstatic.com/mp3/9ce3e5_5d7fcfc389734cf7994f5d37de621e3d.mp3"></audio>

    <script>
        const gameConfig = { totalRounds: 5, sfxEnabled: true, musicVolume: 0.2, minTeams: 2, maxTeams: 4 };
        const gameState = { gameMode: 'single', singlePlayerSubType: '5rounds', players: [], scores: {}, currentRound: 0, currentPlayerIndexInRound: 0, roundPlayerChoices: {}, singlePlayerChoice: null, currentMedia: null, mediaItems: [ { url: "https://static.wixstatic.com/media/9ce3e5_2a4bf1da960443c9b30108c5fb6db7db~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_4ff037154c604c6e8302e195b3aa2346~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_338937bc52754c6cba2ab324ad24f66a~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_ee1311e3f2c649c5bb92a8cc33a2cdc6~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_18a5fdf7fd534413bd83bd0311676ce0~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_d5f4aacfa0c747c1a9d6e5b23c3dbaa7~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_6d273f451e46464fb8c199101eb1cd5e~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_5d5191182b064159a8f7d4fc971f828b~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_cdbcb9884c664be8bb5b41447dec31fe~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_493688d1afe749019ca019a7053bdcd2~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_7d66e4a893e24874982d6229a05b41f3~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_39e3debd6a424f7ca2545707a4601ae4~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_570a72fd7392406db23a982f5a30f1cf~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_6b40aceaf91344438e0732c587a6ec5a~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_f875d76e6ba84544ac383938cc20af32~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_fd1dab053f0c4fb6a1f8b7ef1997a2b0~mv2.jpg", isDating: false }, { url: "https://static.wixstatic.com/media/9ce3e5_9b631479f9bd4bbbb1bd43f1dc44eeb2~mv2.jpg", isDating: false }, { url: "https://static.wixstatic.com/media/9ce3e5_70ce3be7d82340fba5be9415f1fd9252~mv2.jpg", isDating: false }, { url: "https://static.wixstatic.com/media/9ce3e5_8ccaec12c1724f159b30a543a249668c~mv2.jpg", isDating: false }, { url: "https://static.wixstatic.com/media/9ce3e5_a66add3ba32a464abe2500589cb0a000~mv2.jpg", isDating: false }, { url: "https://static.wixstatic.com/media/9ce3e5_e836809728a44c35853d5c0d3e65cef2~mv2.jpg", isDating: false }, { url: "https://static.wixstatic.com/media/9ce3e5_a760321c0463461bae00abf096d334e9~mv2.jpg", isDating: false }, { url: "https://static.wixstatic.com/media/9ce3e5_2199e9755c144209a775f6d39a6d54d7~mv2.jpg", isDating: false }, { url: "https://static.wixstatic.com/media/9ce3e5_5f0d3e0a61f3447d916bde690dd016dc~mv2.jpg", isDating: false }, { url: "https://static.wixstatic.com/media/9ce3e5_a750f1c249264c208358458dbf75497e~mv2.jpg", isDating: false }, { url: "https://static.wixstatic.com/media/9ce3e5_f278a6277e68453b85e22ed79ddee9d8~mv2.jpg", isDating: false }, { url: "https://static.wixstatic.com/media/9ce3e5_76096dcd416344cab64edc8a0896267d~mv2.jpg", isDating: false }, { url: "https://static.wixstatic.com/media/9ce3e5_c9e389ac5ad640d89f4126804eaf33b0~mv2.jpg", isDating: false }, { url: "https://static.wixstatic.com/media/9ce3e5_585c7fbd66ff48c5a0427b9388201f80~mv2.jpg", isDating: false }, { url: "https://static.wixstatic.com/media/9ce3e5_d8b26a6fcf3b4676aa583aa5b268ddaf~mv2.jpg", isDating: false }, { url: "https://static.wixstatic.com/media/9ce3e5_ce50cad7c4a744f2aabc4923cf4b1313~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_d596a42cfab245488bd8230d9da8989e~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_4100029722bb42ae8cc1e73b5ae29481~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_2294fc9814bf4b268c6dc969318058ab~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_6c1b71e6d81c492f94ba4fff774deb8b~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_7bf74aee8cfc445bbd2a94bd52df8bde~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_c93ec6ed915a47fbaa032ed6c72f51f4~mv2.jpg", isDating: true }, { url: "https://static.wixstatic.com/media/9ce3e5_b1339f0981084a4c93753e8b69312d03~mv2.jpg", isDating: false }, { url: "https://static.wixstatic.com/media/9ce3e5_40fcf48157de492cb59f832a5c225c7c~mv2.jpg", isDating: false }, { url: "https://static.wixstatic.com/media/9ce3e5_7e54540e334b4d798c7c22574d95d043~mv2.jpg", isDating: false },], usedItems: [] };
        let infiniteHighScore = 0;
        
        const screens = { start: document.getElementById('start-screen'), game: document.getElementById('game-screen'), results: document.getElementById('results-screen'), gameOver: document.getElementById('game-over-screen')};
        const homeMenuBtnEl = document.getElementById('home-menu-btn'), backBtnEl = document.getElementById('back-btn'), settingsBtnEl = document.getElementById('settings-btn'), modeOptionsEl = document.querySelectorAll('.mode-option'), teamInputsContainerEl = document.getElementById('team-inputs-container'), teamNamesListEl = document.getElementById('team-names-list'), addTeamBtnEl = document.getElementById('add-team-btn'), startMultiplayerGameBtnEl = document.getElementById('start-multiplayer-game-btn'), roundInfoTextEl = document.getElementById('round-info-text'), scoreInfoTextEl = document.getElementById('score-info-text'), turnIndicatorEl = document.getElementById('turn-indicator'), roundNumberTextEl = document.getElementById('round-number-text'), currentScoreTextEl = document.getElementById('current-score-text'), mediaCurtainLeftEl = document.getElementById('media-curtain-left'), mediaCurtainRightEl = document.getElementById('media-curtain-right'), mediaImageContentEl = document.getElementById('media-image-content'), siblingsBtnEl = document.getElementById('siblings-btn'), datingBtnEl = document.getElementById('dating-btn'), resultImageContentEl = document.getElementById('result-image-content'), actualAnswerTextEl = document.getElementById('actual-answer-text'), playerGuessFeedbackTextEl = document.getElementById('player-guess-feedback-text'), scoreDisplayContainerResultsEl = document.getElementById('score-display-container-results'), detailedFeedbackAreaMultiplayerEl = document.getElementById('detailed-feedback-area-multiplayer'), nextRoundBtnEl = document.getElementById('next-round-btn'), finalWinMessageTextEl = document.getElementById('final-win-message-text'), finalMessageDetailsEl = document.getElementById('final-message-details'), finalScoresDisplayAreaEl = document.getElementById('final-scores-display-area'), storeButtonWrapperEl = document.getElementById("store-button-wrapper"), playAgainBtnEl = document.getElementById('play-again-btn'), mainMenuBtnEl = document.getElementById('main-menu-btn'), visitStoreBtnEl = document.getElementById('visit-store-btn'), settingsModalEl = document.getElementById('settings-modal'), closeModalBtnEl = document.getElementById('close-modal-btn'), bgmVolumeSliderEl = document.getElementById('bgm-volume-slider'), sfxToggleBtnEl = document.getElementById('sfx-toggle-btn'), feedbackPopupEl = document.getElementById('feedback-popup'), feedbackMessageTextPopupEl = document.getElementById('feedback-message-text-el');
        
        const highscoreBtnEl = document.getElementById('highscore-btn');
        const singlePlayerSubOptionsEl = document.getElementById('single-player-sub-options');
        const multiplayerStartAreaEl = document.getElementById('multiplayer-start-area');
        const fiveRoundsBtnEl = document.getElementById('five-rounds-btn');
        const infiniteModeBtnEl = document.getElementById('infinite-mode-btn');
        const audioConsentModalEl = document.getElementById('audio-consent-modal');
        const audioConsentYesBtnEl = document.getElementById('audio-consent-yes-btn');
        const audioConsentNoBtnEl = document.getElementById('audio-consent-no-btn');
        const backgroundMusicAudioEl = document.getElementById('background-music');
        let treatYourselfElement = null;

        const allSfx = [ document.getElementById('start-game-sound'), document.getElementById('interaction-sound'), document.getElementById('correct-answer-sound'), document.getElementById('wrong-answer-sound'), document.getElementById('curtain-sound'), document.getElementById('confetti-sound') ];
        let feedbackTimeoutId, audioContextStarted = false;

        function initAudio() {
            if (audioContextStarted) return;
            backgroundMusicAudioEl.play().then(() => {
                audioContextStarted = true;
                if (gameConfig.musicVolume <= 0 || document.hidden) {
                    backgroundMusicAudioEl.pause();
                }
            }).catch(e => { console.warn("Audio autoplay blocked, waiting for user interaction.", e); });
        }
        
        function playSound(audioElement) { 
            if (gameConfig.sfxEnabled && audioElement && audioContextStarted) { 
                audioElement.pause();
                audioElement.currentTime = 0; 
                audioElement.play().catch(e => {}); 
            } 
        }

        function playSoundWithCallback(audioElement, callback, ...args) { 
            if (gameConfig.sfxEnabled && audioElement && audioContextStarted) {
                audioElement.pause();
                audioElement.currentTime = 0;
                let cbExecuted = false;
                const execCb = () => {
                    if (!cbExecuted) {
                        cbExecuted = true;
                        audioElement.removeEventListener('ended', execCb);
                        if (callback) callback(...args);
                    }
                };
                audioElement.addEventListener('ended', execCb);
                audioElement.play().catch(e => { execCb(); });
            } else { 
                if (callback) callback(...args);
            }
        }
        
        function showFeedbackMessage(message, type = 'info', duration = 2500) { feedbackMessageTextPopupEl.textContent = message; feedbackPopupEl.className = 'feedback-popup'; if (type) feedbackPopupEl.classList.add(type); feedbackPopupEl.classList.add('show'); clearTimeout(feedbackTimeoutId); feedbackTimeoutId = setTimeout(() => { feedbackPopupEl.classList.remove('show'); }, duration); }
        function triggerConfetti() { playSound(allSfx[5]); const colors = ['var(--blyza-orange-primary)', 'var(--blyza-purple-secondary)', 'var(--blyza-keppel-accent)', 'var(--blyza-sunny-yellow)']; for (let i = 0; i < 100; i++) { const piece = document.createElement('div'); piece.classList.add('confetti-piece'); piece.style.left = Math.random() * 100 + 'vw'; piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)]; const animDur = Math.random() * 3 + 2; piece.style.animationName = 'fallAndFade'; piece.style.animationDuration = animDur + 's'; piece.style.animationDelay = Math.random() * 1 + 's'; document.body.appendChild(piece); setTimeout(() => piece.remove(), (animDur + 1.1) * 1000); } }
        
        function loadAudioSettings() { const savedVol = localStorage.getItem('musicVolume'), savedSfx = localStorage.getItem('sfxEnabled'); if (savedVol !== null) gameConfig.musicVolume = parseFloat(savedVol); if (savedSfx !== null) gameConfig.sfxEnabled = savedSfx === 'true'; backgroundMusicAudioEl.volume = gameConfig.musicVolume; bgmVolumeSliderEl.value = gameConfig.musicVolume; sfxToggleBtnEl.textContent = `SFX: ${gameConfig.sfxEnabled ? 'ON' : 'OFF'}`; }
        function loadHighScore() { const savedScore = localStorage.getItem('sod_infinite_highscore'); infiniteHighScore = savedScore ? parseInt(savedScore, 10) : 0; }
        function saveHighScore(score) { if (score > infiniteHighScore) { infiniteHighScore = score; localStorage.setItem('sod_infinite_highscore', infiniteHighScore); } }
        function showHighScore() { playSound(allSfx[1]); showFeedbackMessage(`Infinite High Score: ${infiniteHighScore}`, 'info', 3000); }

        function handleVisibilityChange() {
            if (!audioContextStarted) return;
            if (document.hidden) {
                backgroundMusicAudioEl.pause();
            } else if (gameConfig.musicVolume > 0) {
                backgroundMusicAudioEl.play().catch(e => {});
            }
        }
        
        function handlePageShow(event) {
            if (event.persisted) {
                console.log("Page restored from bfcache. Re-initializing...");
                setAppHeight(); 
                mainMenu();
            }
        }

        function switchScreen(screenId) { Object.values(screens).forEach(s=>s.classList.remove('active')); screens[screenId].classList.add('active'); const isStartOrGameOver = screenId === 'start' || screenId === 'gameOver'; homeMenuBtnEl.style.display = isStartOrGameOver ? 'flex' : 'none'; backBtnEl.style.display = isStartOrGameOver ? 'none' : 'flex'; if (treatYourselfElement) { treatYourselfElement.style.display = (screenId === 'gameOver') ? 'flex' : 'none'; } }
        function openMediaCurtains() { mediaCurtainLeftEl.classList.add('open'); mediaCurtainRightEl.classList.add('open'); mediaImageContentEl.classList.add('visible'); playSound(allSfx[4]); }
        function closeMediaCurtains() { mediaCurtainLeftEl.classList.remove('open'); mediaCurtainRightEl.classList.remove('open'); mediaImageContentEl.classList.remove('visible'); mediaImageContentEl.src = ""; }
        
        function startSinglePlayerGame(subType) { 
            initAudio(); // Ensure audio context is unlocked
            gameState.singlePlayerSubType = subType; 
            playSoundWithCallback(allSfx[0], startGame); 
        }
        
        function startGame() {
            gameState.currentRound = 0; gameState.usedItems = []; gameState.scores = {};
            if (gameState.gameMode === 'single') { gameState.players = ['You']; }
            else { 
                gameState.players = Array.from(teamNamesListEl.querySelectorAll('.team-name-input')).map((inp,idx)=>inp.value.trim()||`Team ${idx+1}`).filter(n=>n!==''); 
                if(gameState.players.some(n=>n.length>15)){showFeedbackMessage("Team names too long!","danger");return;} 
                if (new Set(gameState.players.map(p=>p.toLowerCase())).size !== gameState.players.length) { showFeedbackMessage("Team names must be unique!", "danger"); return; } 
                if (gameState.players.length < gameConfig.minTeams) { showFeedbackMessage(`Multiplayer needs ${gameConfig.minTeams}-${gameConfig.maxTeams} teams!`, 'danger'); return;}
            }
            gameState.players.forEach(p => gameState.scores[p] = 0);
            nextRoundBtnEl.innerHTML = 'Next Round <i class="fas fa-arrow-right"></i>';
            nextRoundBtnEl.onclick = () => { playSound(allSfx[1]); setupRound(); };
            setupRound();
        }

        function setupRound() {
            closeMediaCurtains();
            
            if (gameState.gameMode === 'single' && gameState.singlePlayerSubType === '5rounds' && gameState.currentRound >= gameConfig.totalRounds) {
                return showGameOver();
            }
            
            gameState.currentRound++; gameState.singlePlayerChoice = null; gameState.roundPlayerChoices = {}; gameState.currentPlayerIndexInRound = 0;
            let availItems = gameState.mediaItems.filter(item => !gameState.usedItems.includes(item.url));
            if (availItems.length === 0) {
                if(gameState.singlePlayerSubType === 'infinite') return showGameOver(true); // Player beat the game
                gameState.usedItems = []; availItems = [...gameState.mediaItems];
            }
            gameState.currentMedia = availItems[Math.floor(Math.random() * availItems.length)];
            gameState.usedItems.push(gameState.currentMedia.url);

            if (gameState.gameMode === 'single') {
                turnIndicatorEl.style.display = 'none';
                if (gameState.singlePlayerSubType === 'infinite') {
                    roundInfoTextEl.style.display = 'none';
                    scoreInfoTextEl.style.display = 'block';
                    currentScoreTextEl.textContent = gameState.scores['You'];
                } else {
                    roundInfoTextEl.style.display = 'block';
                    scoreInfoTextEl.style.display = 'block';
                    roundNumberTextEl.textContent = gameState.currentRound;
                    currentScoreTextEl.textContent = gameState.scores['You'];
                }
            } else {
                scoreInfoTextEl.style.display = 'none';
                turnIndicatorEl.style.display = 'block';
                roundInfoTextEl.style.display = 'block';
                roundNumberTextEl.textContent = gameState.currentRound;
                updateTurnIndicator();
            }

            mediaImageContentEl.src = gameState.currentMedia.url;
            [siblingsBtnEl, datingBtnEl].forEach(btn => { btn.classList.remove('selected'); btn.disabled = false; });
            switchScreen('game');
            setTimeout(openMediaCurtains, 500);
        }

        function updateTurnIndicator() { if (gameState.gameMode === 'multi' && gameState.players.length > 0) { turnIndicatorEl.textContent = `${gameState.players[gameState.currentPlayerIndexInRound]}'s turn:`; }}
        
        function makeChoice(choice) {
            playSound(allSfx[1]);
            const currentPlayerName = gameState.gameMode === 'multi' ? gameState.players[gameState.currentPlayerIndexInRound] : 'You';
            [siblingsBtnEl, datingBtnEl].forEach(btn => btn.classList.remove('selected'));
            const targetButton = choice === 'siblings' ? siblingsBtnEl : datingBtnEl;
            targetButton.classList.add('selected');
            if (gameState.gameMode === 'single') {
                gameState.singlePlayerChoice = choice;
                [siblingsBtnEl, datingBtnEl].forEach(btn => btn.disabled = true);
                setTimeout(() => processAndShowResults(), 700);
            } else {
                gameState.roundPlayerChoices[currentPlayerName] = choice;
                showFeedbackMessage(`${currentPlayerName} chose ${choice}.`, 'info', 1500);
                if (gameState.currentPlayerIndexInRound < gameState.players.length - 1) {
                    gameState.currentPlayerIndexInRound++;
                    updateTurnIndicator();
                    [siblingsBtnEl, datingBtnEl].forEach(btn => btn.classList.remove('selected'));
                } else {
                    [siblingsBtnEl, datingBtnEl].forEach(btn => btn.disabled = true);
                    setTimeout(() => processAndShowResults(), 700);
                }
            }
        }

        function processAndShowResults() {
            let isGameOver = false;
            switchScreen('results');
            resultImageContentEl.src = gameState.currentMedia.url;
            const actualRelationship = gameState.currentMedia.isDating ? "dating" : "siblings";
            actualAnswerTextEl.className = `inline-answer-text answer-${actualRelationship}-text`;
            actualAnswerTextEl.innerHTML = `<i class="fas ${actualRelationship === 'siblings' ? 'fa-users' : 'fa-heart'}"></i> They are ${actualRelationship}!`;

            if (gameState.gameMode === 'single') {
                const isCorrect = gameState.singlePlayerChoice === actualRelationship;
                if (isCorrect) { gameState.scores['You']++; playSound(allSfx[2]); showFeedbackMessage("Correct!", "correct"); }
                else { 
                    playSound(allSfx[3]); showFeedbackMessage("Incorrect!", "incorrect"); 
                    if (gameState.singlePlayerSubType === 'infinite') isGameOver = true;
                }
                playerGuessFeedbackTextEl.textContent = `You guessed: ${gameState.singlePlayerChoice}.`;
                playerGuessFeedbackTextEl.className = isCorrect ? "inline-feedback-text feedback-correct-text" : "inline-feedback-text feedback-incorrect-text";
            } else {
                const correctPlayers = gameState.players.filter(p => gameState.roundPlayerChoices[p] === actualRelationship);
                correctPlayers.forEach(p => gameState.scores[p]++);
                if (correctPlayers.length > 0) { playSound(allSfx[2]); showFeedbackMessage("Points Awarded!", "correct"); }
                else { playSound(allSfx[3]); showFeedbackMessage("No one was right!", "incorrect"); }
                playerGuessFeedbackTextEl.textContent = "";
            }
            updateScoreDisplayOnResults();
            
            if (isGameOver || (gameState.gameMode === 'multi' && gameState.currentRound >= gameConfig.totalRounds) || (gameState.singlePlayerSubType === '5rounds' && gameState.currentRound >= gameConfig.totalRounds)) {
                 nextRoundBtnEl.innerHTML = 'See Final Results <i class="fas fa-trophy"></i>';
                 nextRoundBtnEl.onclick = () => { playSound(allSfx[1]); showGameOver(); };
            } else {
                nextRoundBtnEl.innerHTML = 'Next Round <i class="fas fa-arrow-right"></i>';
                nextRoundBtnEl.onclick = () => { playSound(allSfx[1]); setupRound(); };
            }
        }

        function updateScoreDisplayOnResults() {
            scoreDisplayContainerResultsEl.innerHTML = '';
            detailedFeedbackAreaMultiplayerEl.innerHTML = '';
            if (gameState.gameMode === 'single') {
                const scCard = document.createElement('div'); scCard.className = 'score-card';
                if (gameState.singlePlayerSubType === 'infinite') {
                    scCard.innerHTML = `<h4>Current Score</h4><div class="score-value-text">${gameState.scores['You']}</div>`;
                } else {
                    const prog = (gameState.scores['You'] / gameConfig.totalRounds) * 100;
                    scCard.innerHTML = `<h4>Your Current Score</h4><div class="score-value-text">${gameState.scores['You']}/${gameConfig.totalRounds}</div><div class="progress-bar-element"><div class="progress-fill-element" style="width:${prog}%"></div></div>`;
                }
                scoreDisplayContainerResultsEl.appendChild(scCard);
            } else {
                detailedFeedbackAreaMultiplayerEl.innerHTML = '<h3>Individual Guesses:</h3>';
                gameState.players.forEach(p => {
                    const scCard = document.createElement('div'); scCard.className = 'score-card';
                    const score = gameState.scores[p]; const prog = (score / gameConfig.totalRounds) * 100;
                    scCard.innerHTML = `<h4>${p}</h4><div class="score-value-text">${score}</div><div class="progress-bar-element"><div class="progress-fill-element" style="width:${prog}%"></div></div>`;
                    scoreDisplayContainerResultsEl.appendChild(scCard);
                    const choice = gameState.roundPlayerChoices[p];
                    if (choice) { const isCorrect = choice === (gameState.currentMedia.isDating ? "dating" : "siblings"); detailedFeedbackAreaMultiplayerEl.innerHTML += `<p><strong>${p}</strong> guessed: ${choice} (${isCorrect ? '<span style="color:var(--blyza-keppel-accent);">Correct!</span>' : '<span style="color:var(--blyza-quickfire-red);">Incorrect.</span>'})</p>`; } else { detailedFeedbackAreaMultiplayerEl.innerHTML += `<p><strong>${p}</strong> did not guess.</p>`; }
                });
            }
        }

        function showGameOver(beatTheGame = false) {
            triggerConfetti();
            finalScoresDisplayAreaEl.innerHTML = '';
            
            if (gameState.gameMode === 'single') {
                const score = gameState.scores['You'];
                if (gameState.singlePlayerSubType === 'infinite') {
                    saveHighScore(score);
                    let isNewHighScore = score > 0 && score === infiniteHighScore;
                    if (beatTheGame) {
                        finalWinMessageTextEl.textContent = "You Beat The Game!";
                        finalMessageDetailsEl.innerHTML = `You correctly identified all ${gameState.mediaItems.length} images! <br>Final Score: ${score}. ${isNewHighScore ? '<strong>New High Score!</strong>' : ''}`;
                    } else {
                        finalWinMessageTextEl.textContent = "Game Over!";
                        finalMessageDetailsEl.innerHTML = `Your Score: ${score}. ${isNewHighScore ? '<strong>New High Score!</strong>' : `High Score: ${infiniteHighScore}`}`;
                    }
                } else {
                     finalMessageDetailsEl.textContent = `You scored ${score} out of ${gameConfig.totalRounds}!`;
                    finalWinMessageTextEl.textContent = score === gameConfig.totalRounds ? "Perfect Score!" : (score >= Math.ceil(gameConfig.totalRounds/2) ? "Great Job!" : "Game Over!");
                }
                const fsc = document.createElement('div'); fsc.className = 'score-card';
                fsc.innerHTML = `<h4>Final Score</h4><div class="score-value-text">${score}</div>`;
                finalScoresDisplayAreaEl.appendChild(fsc);

            } else {
                let highScore = Math.max(...Object.values(gameState.scores));
                const winners = gameState.players.filter(p=>gameState.scores[p]===highScore && highScore > 0);
                finalWinMessageTextEl.textContent = winners.length > 1 ? "It's a Tie!" : (winners.length === 1 ? `${winners[0]} Wins!` : "Game Over!");
                finalMessageDetailsEl.textContent = winners.length > 0 ?`Congratulations on scoring ${highScore} points!` : "Better luck next time!";
                gameState.players.sort((a,b)=>gameState.scores[b] - gameState.scores[a]).forEach(p=>{const sc=document.createElement('div');sc.className=`score-card ${winners.includes(p)?'winner-glow':''}`;sc.innerHTML=`<h4>${p}</h4><div class="score-value-text">${gameState.scores[p]}</div>`;finalScoresDisplayAreaEl.appendChild(sc);});
            }
            if (!treatYourselfElement) { treatYourselfElement = document.createElement('div'); treatYourselfElement.className = 'treat-yourself-callout'; treatYourselfElement.innerHTML = `<span>Treat Yourself!</span> <i class="fas fa-arrow-down"></i>`; storeButtonWrapperEl.insertBefore(treatYourselfElement, visitStoreBtnEl); }
            switchScreen('gameOver');
        }

        function mainMenu() {
            teamNamesListEl.innerHTML = `<div class="team-input-wrapper"><input type="text" class="team-name-input" placeholder="Team 1"></div><div class="team-input-wrapper"><input type="text" class="team-name-input" placeholder="Team 2"></div>`;
            updateTeamAddRemoveButtons();
            if(modeOptionsEl.length>0)modeOptionsEl[0].click();
            if (treatYourselfElement) treatYourselfElement.style.display = 'none';
            switchScreen('start');
        }

        function updateTeamAddRemoveButtons() { const trs = teamNamesListEl.querySelectorAll('.team-input-wrapper'); const tc = trs.length; addTeamBtnEl.disabled = tc>=gameConfig.maxTeams; trs.forEach(tr => { const rb = tr.querySelector('.remove-team-btn'); if(rb)rb.disabled=tc<=gameConfig.minTeams; });}

        document.addEventListener('DOMContentLoaded', () => {
            loadAudioSettings(); 
            loadHighScore();
            
            audioConsentModalEl.style.display = 'flex';
            
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('pageshow', handlePageShow);
            
            backBtnEl.addEventListener('click', () => { playSound(allSfx[1]); mainMenu(); });
            settingsBtnEl.addEventListener('click', () => { playSound(allSfx[1]); settingsModalEl.style.display = 'flex'; });
            closeModalBtnEl.addEventListener('click', () => { playSound(allSfx[1]); settingsModalEl.style.display = 'none'; });
            bgmVolumeSliderEl.addEventListener('input', (e) => { gameConfig.musicVolume = parseFloat(e.target.value); backgroundMusicAudioEl.volume = gameConfig.musicVolume; localStorage.setItem('musicVolume', gameConfig.musicVolume); if (gameConfig.musicVolume > 0 && !document.hidden && audioContextStarted) backgroundMusicAudioEl.play().catch(e=>{}); else backgroundMusicAudioEl.pause(); });
            sfxToggleBtnEl.addEventListener('click', () => { gameConfig.sfxEnabled = !gameConfig.sfxEnabled; sfxToggleBtnEl.textContent = `SFX: ${gameConfig.sfxEnabled ? 'ON' : 'OFF'}`; playSound(allSfx[1]); localStorage.setItem('sfxEnabled', String(gameConfig.sfxEnabled)); });
            
            modeOptionsEl.forEach(opt => { opt.addEventListener('click', function(){ playSound(allSfx[1]); modeOptionsEl.forEach(o=>o.classList.remove('selected')); this.classList.add('selected'); gameState.gameMode=this.dataset.mode; const isMulti = gameState.gameMode === 'multi'; multiplayerStartAreaEl.style.display = isMulti ? 'block' : 'none'; singlePlayerSubOptionsEl.style.display = isMulti ? 'none' : 'block'; if(isMulti)updateTeamAddRemoveButtons(); });});
            addTeamBtnEl.addEventListener('click', () => { playSound(allSfx[1]); const teamCount = teamNamesListEl.querySelectorAll('.team-input-wrapper').length; if (teamCount < gameConfig.maxTeams) { const wr = document.createElement('div'); wr.className='team-input-wrapper'; wr.innerHTML=`<input type="text" class="team-name-input" placeholder="Team ${teamCount+1}"><button class="remove-team-btn btn-danger"><i class="fas fa-times"></i></button>`; wr.querySelector('.remove-team-btn').onclick = function(){ playSound(allSfx[1]); this.parentElement.remove(); updateTeamAddRemoveButtons(); }; teamNamesListEl.appendChild(wr); updateTeamAddRemoveButtons(); } else { showFeedbackMessage(`Max ${gameConfig.maxTeams} teams.`, 'info');}});
            
            fiveRoundsBtnEl.addEventListener('click', () => startSinglePlayerGame('5rounds'));
            infiniteModeBtnEl.addEventListener('click', () => startSinglePlayerGame('infinite'));
            startMultiplayerGameBtnEl.addEventListener('click', () => { initAudio(); playSoundWithCallback(allSfx[0], startGame); });
            siblingsBtnEl.addEventListener('click', () => makeChoice('siblings'));
            datingBtnEl.addEventListener('click', () => makeChoice('dating'));
            playAgainBtnEl.addEventListener('click', () => { playSoundWithCallback(allSfx[0], startGame);});
            mainMenuBtnEl.addEventListener('click', () => { playSound(allSfx[1]); mainMenu(); });
            visitStoreBtnEl.addEventListener('click', () => { playSound(allSfx[1]); window.location.href = '/store'; });
            highscoreBtnEl.addEventListener('click', showHighScore);

            mainMenu();
        });
        
        audioConsentYesBtnEl.addEventListener('click', () => {
            audioConsentModalEl.style.display = 'none';
            initAudio(); // This user tap unlocks the audio context
            playSound(allSfx[1]);
        });
        
        audioConsentNoBtnEl.addEventListener('click', () => {
            audioConsentModalEl.style.display = 'none';
            gameConfig.sfxEnabled = false;
            gameConfig.musicVolume = 0;
            backgroundMusicAudioEl.volume = 0;
            bgmVolumeSliderEl.value = 0;
            sfxToggleBtnEl.textContent = 'SFX: OFF';
            localStorage.setItem('sfxEnabled', 'false'); 
            localStorage.setItem('musicVolume', '0'); 
            initAudio(); // Still call this to set the audioContextStarted flag
        });

        // --- CUSTOM SCROLL REDIRECTION LOGIC ---
        const gameContainerForScroll = document.querySelector('.game-container');
        let lastTouchY = 0;

        window.addEventListener('wheel', e => {
            if (document.querySelector('.modal[style*="display: flex"]')) return;
            if (!gameContainerForScroll.contains(e.target)) {
                gameContainerForScroll.scrollTop += e.deltaY;
            }
        }, { passive: true });

        window.addEventListener('touchstart', e => {
            if (document.querySelector('.modal[style*="display: flex"]')) return;
            if (!gameContainerForScroll.contains(e.target)) {
                if (e.touches.length > 0) {
                    lastTouchY = e.touches[0].clientY;
                }
            }
        }, { passive: true });

        window.addEventListener('touchmove', e => {
            if (document.querySelector('.modal[style*="display: flex"]')) return;
            if (!gameContainerForScroll.contains(e.target)) {
                e.preventDefault(); 
                if (e.touches.length > 0) {
                    const currentTouchY = e.touches[0].clientY;
                    const deltaY = lastTouchY - currentTouchY;
                    gameContainerForScroll.scrollTop += deltaY;
                    lastTouchY = currentTouchY;
                }
            }
        }, { passive: false });
        // --- END OF CUSTOM SCROLL LOGIC ---
    </script>
    <script>
      window.va = window.va || function () { (window.va.q = window.va.q || []).push(arguments); };
    </script>
    <script src="/_vercel/insights/script.js" defer></script>
</body>
</html>